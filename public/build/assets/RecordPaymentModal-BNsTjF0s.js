import{r as h,j as e,C as B}from"./index-Cs-5ghpe.js";import{b as z,p as L}from"./api-CIBCEetx.js";import{p as H,r as V}from"./Feilds-BHjWXeSc.js";import{c as w,a as b,b as c}from"./index.esm-DS-fhHF9.js";import{a as X,b as G,c as J,d as K,e as Q}from"./DefaultLayout-05E0ZdWa.js";import{c as M}from"./cil-pencil-m516yCOw.js";import{c as R}from"./cil-credit-card-KG5pHjdT.js";import{C as W}from"./CForm-BcOVBk6n.js";import{C as Y}from"./cil-mobile-CqmbNfnm.js";import{C as _}from"./CFormLabel-DHukGEEc.js";import{C as v}from"./CFormInput-BnDllJdd.js";import{C as q}from"./CFormSelect-DaxkqWsS.js";import{C as U}from"./CButton-n5jldtHI.js";import{c as Z}from"./cil-x-0440B5Ce.js";const xe=({visible:f,onClose:j,orderData:s,onPaymentRecorded:g})=>{var O;const[n,k]=h.useState({received_amount:"",received_by:"",payment_type:"cash",senders_bank:"",receivers_bank:"",remark:"",payment_date:new Date().toISOString().split("T")[0]}),[l,F]=h.useState(!1),[o,A]=h.useState(!1),[C,S]=h.useState({show:!1,message:"",type:"success"}),[D,N]=h.useState(0),i=(s==null?void 0:s.isEdit)||!1,P=(s==null?void 0:s.isProformaInvoice)||!1;h.useEffect(()=>{if(!(!f||!s))if(i){const a=parseFloat(s.received_amount??s.amount??0)||0;N(a);let m=new Date().toISOString().split("T")[0];s.payment_date?m=new Date(s.payment_date).toISOString().split("T")[0]:s.created_at&&(m=new Date(s.created_at).toISOString().split("T")[0]),k({received_amount:a.toString(),received_by:s.received_by??"",payment_type:s.payment_type??"cash",senders_bank:s.senders_bank??"",receivers_bank:s.receivers_bank??"",remark:s.remark??"",payment_date:m})}else{const a=parseFloat(s.finalAmount??s.totalAmount??0),m=parseFloat(s.paidAmount??0),u=a-m;N(0),k(d=>({...d,received_amount:u>0?u.toFixed(2):"0.00",payment_date:new Date().toISOString().split("T")[0]}))}},[f,s,i]),h.useEffect(()=>{f||(k({received_amount:"",received_by:"",payment_type:"cash",senders_bank:"",receivers_bank:"",remark:"",payment_date:new Date().toISOString().split("T")[0]}),S({show:!1,message:"",type:"success"}),N(0),A(!1))},[f]);const r=(a,m="success")=>{S({show:!0,message:a,type:m}),setTimeout(()=>S({show:!1,message:"",type:"success"}),5e3)},y=a=>{const{name:m,value:u}=a.target;if(m==="received_amount"&&!i){const d=(s==null?void 0:s.finalAmount)||(s==null?void 0:s.totalAmount)||0,t=(s==null?void 0:s.paidAmount)||0,x=d-t;if((parseFloat(u)||0)>x){r(`Amount cannot exceed pending amount of ₹${x.toLocaleString()}`,"danger");return}}if(m==="payment_date"){const d=new Date(u),t=new Date;if(t.setHours(0,0,0,0),d>t){r("Payment date cannot be in the future","danger");return}}k(d=>({...d,[m]:u}))},$=async a=>{var u,d;if(a.preventDefault(),l||o)return;if(!s){r("Order data not available","danger");return}const m=parseFloat(n.received_amount);if(!n.payment_date){r("Please select a payment date","danger");return}F(!0),A(!0);try{if(i){const t=s.incomeId||s.originalIncomeId;if(!t){r("Income ID missing! Cannot update income record.","danger");return}const x={received_by:n.received_by,payment_type:n.payment_type,senders_bank:n.senders_bank,receivers_bank:n.receivers_bank,remark:n.remark,received_amount:m.toString(),payment_date:n.payment_date},p=await z(`/api/income/${t}`,x);if(!p.success&&!p.message){r("Failed to update payment record","danger");return}r("Payment updated successfully!","success"),g&&g(s.id||s.proforma_invoice_id||t,m),setTimeout(()=>j(),1500)}else if(P){const t=s.proforma_invoice_id||s.id;if(!t){r("Proforma Invoice ID missing for payment recording","danger");return}const x={received_amount:n.received_amount,received_by:n.received_by,payment_type:n.payment_type,senders_bank:n.senders_bank,receivers_bank:n.receivers_bank,remark:n.remark,payment_date:n.payment_date},p=await L(`/api/proforma-invoices/${t}/record-payment`,x);if(!p.success){r(p.message||"Error recording payment","danger");return}r("Payment recorded successfully!","success"),g&&g(t,m),setTimeout(()=>j(),1500)}else{const t=s.id||s.orderId;if(!t){r("Order ID missing for payment recording","danger");return}const x={received_amount:n.received_amount,received_by:n.received_by,payment_type:n.payment_type,senders_bank:n.senders_bank,receivers_bank:n.receivers_bank,remark:n.remark,payment_date:n.payment_date},p=await L(`/api/recordPayment/${t}`,x);if(!p.success){r(p.message||"Error recording payment","danger");return}r("Payment recorded successfully!","success"),g&&g(t,m),setTimeout(()=>j(),1500)}}catch(t){console.error("Payment processing error:",t),r(((d=(u=t.response)==null?void 0:u.data)==null?void 0:d.message)||"Error processing payment","danger")}finally{F(!1),A(!1)}};if(!s)return null;const T=s.finalAmount||s.totalAmount||s.billing_amount||0,E=s.paidAmount||parseFloat(s.received_amount||0)||0,I=i?0:T-E;return e.jsxs(X,{visible:f,onClose:j,size:"lg",backdrop:"static",keyboard:!1,children:[e.jsx(G,{children:e.jsxs(J,{children:[e.jsx(w,{icon:i?M:R,className:"me-2"}),i?"Edit Payment":"Record Payment"]})}),e.jsxs(W,{onSubmit:$,children:[e.jsxs(K,{children:[C.show&&e.jsx(Y,{color:C.type,dismissible:!0,onClose:()=>S({show:!1,message:"",type:"success"}),children:C.message}),e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:i?"Payment Details":P?"Proforma Invoice Details":"Order Details"}),e.jsxs(b,{className:"mb-2",children:[e.jsxs(c,{lg:6,md:6,sm:6,xs:6,children:[e.jsx("small",{className:"text-muted d-block",children:"Invoice Number:"}),e.jsx("div",{children:e.jsx("strong",{children:s.invoice_no||s.invoice_number||`INV-${s.id}`})})]}),e.jsxs(c,{lg:6,md:6,sm:6,xs:6,children:[e.jsx("small",{className:"text-muted d-block",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:s.project_name||((O=s.project)==null?void 0:O.project_name)||"N/A"})})]})]}),!i&&e.jsxs(b,{children:[e.jsxs(c,{lg:4,md:4,sm:4,xs:4,children:[e.jsx("small",{className:"text-muted d-block",children:"Total Amount:"}),e.jsx("div",{children:e.jsxs("strong",{children:["₹",T.toLocaleString()]})})]}),e.jsxs(c,{lg:4,md:4,sm:4,xs:4,children:[e.jsx("small",{className:"text-muted d-block",children:"Paid Amount:"}),e.jsx("div",{className:"text-success",children:e.jsxs("strong",{children:["₹",E.toLocaleString()]})})]}),e.jsxs(c,{lg:4,md:4,sm:4,xs:4,children:[e.jsx("small",{className:"text-muted d-block",children:"Pending Amount:"}),e.jsx("div",{className:"text-danger",children:e.jsxs("strong",{children:["₹",I.toLocaleString()]})})]})]})]}),e.jsxs(b,{className:"mb-3",children:[e.jsxs(c,{lg:6,md:6,sm:6,xs:12,className:"mb-3 mb-sm-0",children:[e.jsx(_,{htmlFor:"received_amount",children:"Payment Amount *"}),e.jsx(v,{type:"number",step:"0.01",name:"received_amount",value:n.received_amount,onChange:y,placeholder:"Enter payment amount",required:!0,max:i?void 0:I,disabled:l||o}),!i&&e.jsxs("small",{className:"text-muted",children:["Maximum: ₹",I.toLocaleString()]})]}),e.jsxs(c,{lg:6,md:6,sm:6,xs:12,children:[e.jsx(_,{htmlFor:"payment_date",children:"Payment Date *"}),e.jsx(v,{type:"date",name:"payment_date",value:n.payment_date,onChange:y,max:new Date().toISOString().split("T")[0],required:!0,disabled:l||o})]})]}),e.jsxs(b,{className:"mb-3",children:[e.jsxs(c,{lg:6,md:6,sm:6,xs:12,className:"mb-3 mb-sm-0",children:[e.jsx(_,{htmlFor:"received_by",children:"Received From *"}),e.jsx(v,{type:"text",name:"received_by",value:n.received_by,onChange:y,placeholder:"Enter payer name",required:!0,disabled:l||o})]}),e.jsxs(c,{lg:6,md:6,sm:6,xs:12,children:[e.jsx(_,{htmlFor:"payment_type",children:"Payment Type *"}),e.jsx(q,{name:"payment_type",value:n.payment_type,onChange:y,required:!0,disabled:l||o,children:H.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]})]}),e.jsxs(b,{className:"mb-3",children:[e.jsxs(c,{lg:6,md:6,sm:6,xs:12,className:"mb-3 mb-sm-0",children:[e.jsx(_,{htmlFor:"senders_bank",children:"Sender's Bank *"}),e.jsx(v,{type:"text",name:"senders_bank",value:n.senders_bank,onChange:y,placeholder:"Enter sender's bank name",required:!0,disabled:l||o})]}),e.jsxs(c,{lg:6,md:6,sm:6,xs:12,children:[e.jsx(_,{htmlFor:"receivers_bank",children:"Receiver's Bank *"}),e.jsxs(q,{name:"receivers_bank",value:n.receivers_bank,onChange:y,required:!0,disabled:l||o,children:[e.jsx("option",{value:"",children:"Select receiver's bank"}),V.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})]})]}),e.jsx(b,{className:"mb-3",children:e.jsxs(c,{xs:12,children:[e.jsx(_,{htmlFor:"remark",children:"Transaction Number"}),e.jsx(v,{type:"text",name:"remark",value:n.remark,onChange:y,placeholder:"Enter transaction number (optional)",disabled:l||o})]})})]}),e.jsxs(Q,{className:"d-flex justify-content-end gap-2",children:[e.jsxs(U,{color:"secondary",onClick:j,disabled:l||o,className:"flex-sm-grow-0 flex-grow-1",children:[e.jsx(w,{icon:Z,className:"me-1 d-none d-sm-inline"}),"Cancel"]}),e.jsx(U,{color:"primary",type:"submit",disabled:l||o,className:"flex-sm-grow-0 flex-grow-1",children:l||o?e.jsxs(e.Fragment,{children:[e.jsx(B,{size:"sm",className:"me-2"}),e.jsx("span",{className:"d-none d-sm-inline",children:i?"Updating...":"Recording..."}),e.jsx("span",{className:"d-inline d-sm-none",children:i?"Updating":"Recording"})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{icon:i?M:R,className:"me-1 d-none d-sm-inline"}),e.jsx("span",{className:"d-none d-sm-inline",children:i?"Update Payment":"Record Payment"}),e.jsx("span",{className:"d-inline d-sm-none",children:i?"Update":"Record"})]})})]})]})]})};export{xe as R};

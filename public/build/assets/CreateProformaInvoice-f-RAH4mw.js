import{e as ve,u as Pe,b as ke,r as p,j as e,C as Ae}from"./index-95D3pMM8.js";import{a as _,b as o,c as A}from"./index.esm-DxutiY6j.js";import{p as Se}from"./api-CIBCEetx.js";import{C as re,a as oe}from"./CCardBody-dOzHbfOa.js";import{C as Ne}from"./cil-mobile-DjllxSOU.js";import{C as b}from"./CButton-B_ZYbnJ4.js";import{C as Te}from"./CCardHeader-Cq-j3fyp.js";import{c as we}from"./cil-arrow-left-D66Kb3Zq.js";import{C as Fe}from"./CForm-DyhjnECG.js";import{C as g}from"./CFormLabel-C_2Vxs-X.js";import{C as m}from"./CFormInput-C_VETgxc.js";import{C as x}from"./CInputGroup-B3cbnFfp.js";import{C as P}from"./CInputGroupText-CMKr1FZN.js";import{C as ae}from"./DefaultLayout-CJHw--2-.js";import{c as ce}from"./cil-pencil-m516yCOw.js";import{c as le}from"./cil-x-0440B5Ce.js";import{C as Ge}from"./CFormTextarea-B-FmTaE-.js";import{c as qe}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-DhbFIWP9.js";import"./RawMaterial-BtjEDAbB.js";const tt=()=>{var Y,Z,ee;const ie=ve(),q=Pe(),{showToast:S}=ke(),{workOrderId:B,workOrderData:d}=ie.state||{},[L,Q]=p.useState(!1),[me,de]=p.useState(!1);p.useState([]);const[ue,Ie]=p.useState([]),[a,I]=p.useState({work_order_id:B||null,project_id:(d==null?void 0:d.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[f,F]=p.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:"",gst_percent:18,cgst_amount:0,sgst_amount:0}]),ge=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[N,W]=p.useState(ge),[pe,R]=p.useState(-1),[U,H]=p.useState(""),[E,X]=p.useState(""),he=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[T,O]=p.useState(he),[xe,D]=p.useState(-1),[$,J]=p.useState(""),[M,K]=p.useState("");p.useState(""),p.useEffect(()=>{if(d){let n=0,t=0,s=0,r=0;const l=parseFloat(d.totalAmount)||0,c=parseFloat(d.cgst)||0,u=parseFloat(d.sgst)||0,j=parseFloat(d.igst)||0,v=parseFloat(d.gst)||0;if(l>0&&(c>0&&(s=Math.round(c/l*100*100)/100),u>0&&(t=Math.round(u/l*100*100)/100),j>0&&(r=Math.round(j/l*100*100)/100),v>0?n=Math.round(v/l*100*100)/100:n=s+t+r),I(y=>({...y,work_order_id:d.id,project_id:d.project_id,gstPercentage:n,sgstPercentage:t,cgstPercentage:s,igstPercentage:r})),d.items&&d.items.length>0){const y=d.items.map(i=>{const h=parseFloat(i.qty)||0,G=parseFloat(i.price)||0,V=parseFloat(i.total_price)||0;let w=0;if(i.gst_percent!==null&&i.gst_percent!==void 0)w=parseFloat(i.gst_percent),isNaN(w)&&(w=0);else{const te=parseFloat(i.cgst_amount)||0,se=parseFloat(i.sgst_amount)||0,ne=h*G;if(ne>0&&(te>0||se>0)){const Ce=te+se;w=Math.round(Ce/ne*100*100)/100}}const _e=parseFloat(i.cgst_amount)||0,fe=parseFloat(i.sgst_amount)||0;return{work_type:i.work_type||"",uom:i.uom||"",qty:h,price:G,total_price:V,remark:i.remark||"",gst_percent:w,cgst_amount:_e,sgst_amount:fe}});F(y),z(y)}}},[d]);const C=n=>{const{name:t,value:s}=n.target;I(r=>{let l={...r,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(s)||0:s};if(t==="gstPercentage"){const u=(parseFloat(s)||0)/2;l={...l,sgstPercentage:u,cgstPercentage:u}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const c=t==="sgstPercentage"?parseFloat(s)||0:r.sgstPercentage,u=t==="cgstPercentage"?parseFloat(s)||0:r.cgstPercentage;l={...l,gstPercentage:c+u}}if(t==="discount"||t.endsWith("Percentage")){const c=f.reduce((G,V)=>G+(V.total_price||0),0),u=c-l.discount,j=u*(l.sgstPercentage/100),v=u*(l.cgstPercentage/100),y=u*(l.igstPercentage/100),i=j+v+y,h=u+i;l={...l,subtotal:c,taxableAmount:u,gstAmount:i,sgstAmount:j,cgstAmount:v,igstAmount:y,finalAmount:h}}return l})},k=(n,t,s)=>{const r=[...f];t==="qty"||t==="price"?r[n][t]=s===""?0:parseFloat(s)||0:t==="gst_percent"?r[n].gst_percent=s===""||s===null||s===void 0?0:parseFloat(s)||0:r[n][t]=s;const l=r[n].qty||0,c=r[n].price||0,u=r[n].gst_percent??0,j=l*c,v=u/2,y=j*(v/100),i=j*(v/100);r[n].cgst_amount=y,r[n].sgst_amount=i,r[n].total_price=j+y+i,F(r),z(r)},je=()=>{F([...f,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:0,cgst_amount:0,sgst_amount:0,remark:""}])},ye=n=>{const t=[...f];t.splice(n,1),F(t),z(t)},z=n=>{I(t=>{const s=n.reduce((i,h)=>i+h.qty*h.price,0);n.reduce((i,h)=>i+(h.cgst_amount||0),0),n.reduce((i,h)=>i+(h.sgst_amount||0),0);const r=n.reduce((i,h)=>i+(h.total_price||0),0),l=r*(t.sgstPercentage/100),c=r*(t.cgstPercentage/100),u=r*(t.igstPercentage/100),j=l+c+u,y=r+j-(t.discount||0);return{...t,subtotal:s,taxableAmount:r,gstAmount:j,cgstAmount:c,sgstAmount:l,igstAmount:u,finalAmount:y}})},be=async n=>{if(n.preventDefault(),!n.currentTarget.checkValidity()){de(!0);return}if(!a.work_order_id||!a.project_id){S("danger","Work order and project information missing");return}if(f.length===0||f.every(s=>!s.work_type||s.qty<=0)){S("danger","Please add at least one valid work item");return}try{Q(!0);const s=f.filter(c=>c.work_type&&c.qty>0).map(c=>({work_type:c.work_type,uom:c.uom||null,qty:parseFloat(c.qty)||0,price:parseFloat(c.price)||0,total_price:parseFloat(c.total_price)||0,remark:c.remark||null,gst_percent:c.gst_percent!==null&&c.gst_percent!==void 0?parseFloat(c.gst_percent):0,cgst_amount:parseFloat(c.cgst_amount)||0,sgst_amount:parseFloat(c.sgst_amount)||0})),r={work_order_id:a.work_order_id,project_id:a.project_id,tally_invoice_number:a.tally_invoice_number||null,invoice_date:a.invoice_date,delivery_date:a.delivery_date||null,items:s,discount:a.discount,gst_percentage:a.gstPercentage,cgst_percentage:a.cgstPercentage,sgst_percentage:a.sgstPercentage,igst_percentage:a.igstPercentage,rule_ids:ue,notes:a.notes||null,payment_terms:N.join(`
`),terms_conditions:T.join(`
`)},l=await Se("/api/proforma-invoices",r);l&&l.success?(S("success","Proforma invoice created successfully"),setTimeout(()=>{q(`/proforma-invoice-details/${l.data.id}`)},1500)):S("danger",l.message||"Failed to create proforma invoice",8e3)}catch(s){console.error("Submit error:",s);const r=s.message||"Failed to create proforma invoice";S("danger",r,8e3)}finally{Q(!1)}};return!B||!d?e.jsx(re,{children:e.jsx(oe,{children:e.jsxs(Ne,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(b,{color:"primary",onClick:()=>q("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(_,{children:e.jsx(o,{xs:12,children:e.jsxs(re,{className:"mb-4",children:[e.jsx(Te,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(b,{color:"secondary",size:"sm",onClick:()=>q("/invoiceTable"),children:[e.jsx(A,{icon:we,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(oe,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(_,{children:[e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:d.invoice_number})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(Y=d.project)==null?void 0:Y.project_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(Z=d.project)==null?void 0:Z.customer_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(ee=d.project)==null?void 0:ee.work_place})]})]})]}),e.jsxs(Fe,{validated:me,onSubmit:be,children:[e.jsxs(_,{className:"mb-3",children:[e.jsxs(o,{md:4,children:[e.jsx(g,{children:"Tally Invoice Number"}),e.jsx(m,{type:"text",name:"tally_invoice_number",value:a.tally_invoice_number,onChange:C,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(o,{md:4,children:[e.jsx(g,{children:"Invoice Date *"}),e.jsx(m,{type:"date",name:"invoice_date",value:a.invoice_date,onChange:C,required:!0})]}),e.jsxs(o,{md:4,children:[e.jsx(g,{children:"Delivery Date"}),e.jsx(m,{type:"date",name:"delivery_date",value:a.delivery_date,onChange:C})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),f.map((n,t)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(_,{className:"g-3 mb-2 align-items-end",children:[e.jsx(o,{md:3,children:e.jsx(m,{label:"Work Type *",placeholder:"Work Type",value:n.work_type,onChange:s=>k(t,"work_type",s.target.value),required:!0})}),e.jsx(o,{md:2,children:e.jsx(m,{label:"UOM",placeholder:"Unit",value:n.uom,onChange:s=>k(t,"uom",s.target.value)})}),e.jsx(o,{md:2,children:e.jsx(m,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:n.qty,onChange:s=>k(t,"qty",s.target.value),required:!0})}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"Rate *"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(m,{type:"number",step:"0.01",min:"0",value:n.price,onChange:s=>k(t,"price",s.target.value),required:!0})]})]}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",((n.qty||0)*(n.price||0)).toFixed(2)]})]}),e.jsx(o,{md:1,className:"d-flex align-items-end",children:e.jsx(b,{color:"danger",size:"sm",onClick:()=>ye(t),disabled:f.length===1,children:"×"})})]}),e.jsxs(_,{className:"g-3 align-items-end",children:[e.jsx(o,{md:2,children:e.jsx(m,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:n.gst_percent,onChange:s=>k(t,"gst_percent",s.target.value)})}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(n.cgst_amount||0).toFixed(2)]})]}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(n.sgst_amount||0).toFixed(2)]})]}),e.jsxs(o,{md:2,children:[e.jsx(g,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",(n.total_price||0).toFixed(2)]})]}),e.jsx(o,{md:4,children:e.jsx(m,{label:"Remark",placeholder:"Remark",value:n.remark,onChange:s=>k(t,"remark",s.target.value)})})]})]},t)),e.jsx(b,{color:"warning",variant:"outline",className:"mb-4",onClick:je,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(_,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Total GST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"gstPercentage",value:a.gstPercentage,onChange:C,min:"0",max:"100",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.gstAmount]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"SGST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"sgstPercentage",value:a.sgstPercentage,onChange:C,min:"0",max:"50",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.sgstAmount]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"CGST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"cgstPercentage",value:a.cgstPercentage,onChange:C,min:"0",max:"50",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.cgstAmount]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"IGST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"igstPercentage",value:a.igstPercentage,onChange:C,min:"0",max:"100",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.igstAmount]})]})]}),e.jsxs(_,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Subtotal"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(m,{type:"number",value:a.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Discount"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(m,{type:"number",name:"discount",value:a.discount,onChange:C,min:"0",step:"0.01"})]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Taxable Amount"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(m,{type:"number",value:a.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Final Amount"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(m,{type:"number",value:a.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:N.map((n,t)=>pe===t?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(m,{value:U,onChange:s=>H(s.target.value)}),e.jsx(b,{color:"success",onClick:()=>{const s=[...N];s[t]=U,W(s),R(-1)},children:"Save"}),e.jsx(b,{color:"secondary",onClick:()=>R(-1),children:"Cancel"})]},t):e.jsxs(ae,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:ce,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{R(t),H(n)}}),e.jsx(A,{icon:le,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{W(N.filter((s,r)=>r!==t))}})]},t))}),e.jsx(_,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(x,{children:[e.jsx(m,{placeholder:"Add new payment term...",value:E,onChange:n=>X(n.target.value)}),e.jsx(b,{color:"primary",onClick:()=>{E.trim()&&(W([...N,E.trim()]),X(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:T.map((n,t)=>xe===t?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(m,{value:$,onChange:s=>J(s.target.value)}),e.jsx(b,{color:"success",onClick:()=>{const s=[...T];s[t]=$,O(s),D(-1)},children:"Save"}),e.jsx(b,{color:"secondary",onClick:()=>D(-1),children:"Cancel"})]},t):e.jsxs(ae,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:ce,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{D(t),J(n)}}),e.jsx(A,{icon:le,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{O(T.filter((s,r)=>r!==t))}})]},t))}),e.jsx(_,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(x,{children:[e.jsx(m,{placeholder:"Add new condition...",value:M,onChange:n=>K(n.target.value)}),e.jsx(b,{color:"primary",onClick:()=>{M.trim()&&(O([...T,M.trim()]),K(""))},children:"Add"})]})})}),e.jsx(_,{className:"mb-3",children:e.jsxs(o,{md:12,children:[e.jsx(g,{children:"Additional Notes"}),e.jsx(Ge,{name:"notes",value:a.notes,onChange:C,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(b,{color:"primary",type:"submit",disabled:L,children:[L?e.jsx(Ae,{size:"sm"}):e.jsx(A,{icon:qe,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{tt as default};

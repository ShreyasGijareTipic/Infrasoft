import{e as xe,u as je,b as ye,r as g,j as e,C as be}from"./index-DQ9cqY-w.js";import{a as f,b as c,c as A}from"./index.esm-t1uhsutJ.js";import{p as _e}from"./api-CIBCEetx.js";import{C as ee,a as te}from"./CCardBody-nJ-qIk-T.js";import{C as fe}from"./cil-mobile-Cf1prUnf.js";import{C as _}from"./CButton-Cv8rOKs_.js";import{C as Ce}from"./CCardHeader-Dxk59cNM.js";import{c as ve}from"./cil-arrow-left-D66Kb3Zq.js";import{C as Pe}from"./CForm-Dfp3PuZs.js";import{C as u}from"./CFormLabel-C-r2uEyX.js";import{C as d}from"./CFormInput-C2pMQ5Ja.js";import{C as y}from"./CInputGroup-CX6YuGRq.js";import{C as P}from"./CInputGroupText-CFKboCAQ.js";import{C as se}from"./DefaultLayout-D1v7lmV6.js";import{c as ne}from"./cil-pencil-m516yCOw.js";import{c as re}from"./cil-x-0440B5Ce.js";import{C as ke}from"./CFormTextarea-BLz_0Ah5.js";import{c as Ae}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-C03sehqW.js";import"./RawMaterial-BtjEDAbB.js";const Xe=()=>{var K,Y,Z;const ae=xe(),G=je(),{showToast:S}=ye(),{workOrderId:V,workOrderData:i}=ae.state||{},[B,L]=g.useState(!1),[oe,ce]=g.useState(!1);g.useState([]);const[le,Se]=g.useState([]),[l,q]=g.useState({work_order_id:V||null,project_id:(i==null?void 0:i.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[C,w]=g.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:"",gst_percent:18,cgst_amount:0,sgst_amount:0}]),ie=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[N,I]=g.useState(ie),[me,W]=g.useState(-1),[Q,U]=g.useState(""),[R,H]=g.useState(""),de=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[T,E]=g.useState(de),[ue,O]=g.useState(-1),[X,$]=g.useState(""),[D,J]=g.useState("");g.useState(""),g.useEffect(()=>{if(i){let n=18,t=9,s=9,a=0;if(i.totalAmount){const o=parseFloat(i.totalAmount)||0,r=parseFloat(i.gst)||0,m=parseFloat(i.sgst)||0,p=parseFloat(i.cgst)||0,j=parseFloat(i.igst)||0;o>0&&(r>0&&(n=Math.round(r/o*100*100)/100),m>0&&(t=Math.round(m/o*100*100)/100),p>0&&(s=Math.round(p/o*100*100)/100),j>0&&(a=Math.round(j/o*100*100)/100))}if(q(o=>({...o,work_order_id:i.id,project_id:i.project_id,gstPercentage:n,sgstPercentage:t,cgstPercentage:s,igstPercentage:a})),i.items&&i.items.length>0){const o=i.items.map(r=>{const m=parseFloat(r.qty)||0,p=parseFloat(r.price)||0,j=parseFloat(r.cgst_amount)||0,b=parseFloat(r.sgst_amount)||0,h=parseFloat(r.total_price)||0;let x=0;if(r.gst_percent!==null&&r.gst_percent!==void 0)x=parseFloat(r.gst_percent);else{const F=m*p;if(F>0&&(j>0||b>0)){const z=j+b;x=Math.round(z/F*100*100)/100}}return{work_type:r.work_type||"",uom:r.uom||"",qty:m,price:p,total_price:h,remark:r.remark||"",gst_percent:x,cgst_amount:j,sgst_amount:b}});w(o),M(o)}}},[i]);const v=n=>{const{name:t,value:s}=n.target;q(a=>{let o={...a,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(s)||0:s};if(t==="gstPercentage"){const m=(parseFloat(s)||0)/2;o={...o,sgstPercentage:m,cgstPercentage:m}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const r=t==="sgstPercentage"?parseFloat(s)||0:a.sgstPercentage,m=t==="cgstPercentage"?parseFloat(s)||0:a.cgstPercentage;o={...o,gstPercentage:r+m}}if(t==="discount"||t.endsWith("Percentage")){const r=C.reduce((F,z)=>F+(z.total_price||0),0),m=r-o.discount,p=m*(o.sgstPercentage/100),j=m*(o.cgstPercentage/100),b=m*(o.igstPercentage/100),h=p+j+b,x=m+h;o={...o,subtotal:r,taxableAmount:m,gstAmount:h,sgstAmount:p,cgstAmount:j,igstAmount:b,finalAmount:x}}return o})},k=(n,t,s)=>{const a=[...C];t==="qty"||t==="price"?a[n][t]=s===""?0:parseFloat(s)||0:t==="gst_percent"?a[n].gst_percent=s===""||s===null||s===void 0?0:parseFloat(s)||0:a[n][t]=s;const o=a[n].qty||0,r=a[n].price||0,m=a[n].gst_percent??0,p=o*r,j=m/2,b=p*(j/100),h=p*(j/100);a[n].cgst_amount=b,a[n].sgst_amount=h,a[n].total_price=p+b+h,w(a),M(a)},ge=()=>{w([...C,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:0,sgst_amount:0,remark:""}])},pe=n=>{const t=[...C];t.splice(n,1),w(t),M(t)},M=n=>{q(t=>{const s=n.reduce((h,x)=>h+x.qty*x.price,0);n.reduce((h,x)=>h+(x.cgst_amount||0),0),n.reduce((h,x)=>h+(x.sgst_amount||0),0);const a=n.reduce((h,x)=>h+(x.total_price||0),0),o=a*(t.sgstPercentage/100),r=a*(t.cgstPercentage/100),m=a*(t.igstPercentage/100),p=o+r+m,b=a+p-(t.discount||0);return{...t,subtotal:s,taxableAmount:a,gstAmount:p,cgstAmount:r,sgstAmount:o,igstAmount:m,finalAmount:b}})},he=async n=>{if(n.preventDefault(),!n.currentTarget.checkValidity()){ce(!0);return}if(!l.work_order_id||!l.project_id){S("danger","Work order and project information missing");return}if(C.length===0||C.every(s=>!s.work_type||s.qty<=0)){S("danger","Please add at least one valid work item");return}try{L(!0);const s=C.filter(r=>r.work_type&&r.qty>0).map(r=>({work_type:r.work_type,uom:r.uom||null,qty:parseFloat(r.qty)||0,price:parseFloat(r.price)||0,total_price:parseFloat(r.total_price)||0,remark:r.remark||null,gst_percent:r.gst_percent!==null&&r.gst_percent!==void 0?parseFloat(r.gst_percent):0,cgst_amount:parseFloat(r.cgst_amount)||0,sgst_amount:parseFloat(r.sgst_amount)||0})),a={work_order_id:l.work_order_id,project_id:l.project_id,tally_invoice_number:l.tally_invoice_number||null,invoice_date:l.invoice_date,delivery_date:l.delivery_date||null,items:s,discount:l.discount,gst_percentage:l.gstPercentage,cgst_percentage:l.cgstPercentage,sgst_percentage:l.sgstPercentage,igst_percentage:l.igstPercentage,rule_ids:le,notes:l.notes||null,payment_terms:N.join(`
`),terms_conditions:T.join(`
`)},o=await _e("/api/proforma-invoices",a);o&&o.success?(S("success","Proforma invoice created successfully"),setTimeout(()=>{G(`/proforma-invoice-details/${o.data.id}`)},1500)):S("danger",o.message||"Failed to create proforma invoice",8e3)}catch(s){console.error("Submit error:",s);const a=s.message||"Failed to create proforma invoice";S("danger",a,8e3)}finally{L(!1)}};return!V||!i?e.jsx(ee,{children:e.jsx(te,{children:e.jsxs(fe,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(_,{color:"primary",onClick:()=>G("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(f,{children:e.jsx(c,{xs:12,children:e.jsxs(ee,{className:"mb-4",children:[e.jsx(Ce,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(_,{color:"secondary",size:"sm",onClick:()=>G("/invoiceTable"),children:[e.jsx(A,{icon:ve,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(te,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(f,{children:[e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:i.invoice_number})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(K=i.project)==null?void 0:K.project_name})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(Y=i.project)==null?void 0:Y.customer_name})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(Z=i.project)==null?void 0:Z.work_place})]})]})]}),e.jsxs(Pe,{validated:oe,onSubmit:he,children:[e.jsxs(f,{className:"mb-3",children:[e.jsxs(c,{md:4,children:[e.jsx(u,{children:"Tally Invoice Number"}),e.jsx(d,{type:"text",name:"tally_invoice_number",value:l.tally_invoice_number,onChange:v,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(c,{md:4,children:[e.jsx(u,{children:"Invoice Date *"}),e.jsx(d,{type:"date",name:"invoice_date",value:l.invoice_date,onChange:v,required:!0})]}),e.jsxs(c,{md:4,children:[e.jsx(u,{children:"Delivery Date"}),e.jsx(d,{type:"date",name:"delivery_date",value:l.delivery_date,onChange:v})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),C.map((n,t)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(f,{className:"g-3 mb-2 align-items-end",children:[e.jsx(c,{md:3,children:e.jsx(d,{label:"Work Type *",placeholder:"Work Type",value:n.work_type,onChange:s=>k(t,"work_type",s.target.value),required:!0})}),e.jsx(c,{md:2,children:e.jsx(d,{label:"UOM",placeholder:"Unit",value:n.uom,onChange:s=>k(t,"uom",s.target.value)})}),e.jsx(c,{md:2,children:e.jsx(d,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:n.qty,onChange:s=>k(t,"qty",s.target.value),required:!0})}),e.jsxs(c,{md:2,children:[e.jsx(u,{children:"Rate *"}),e.jsxs(y,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",step:"0.01",min:"0",value:n.price,onChange:s=>k(t,"price",s.target.value),required:!0})]})]}),e.jsxs(c,{md:2,children:[e.jsx(u,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",((n.qty||0)*(n.price||0)).toFixed(2)]})]}),e.jsx(c,{md:1,className:"d-flex align-items-end",children:e.jsx(_,{color:"danger",size:"sm",onClick:()=>pe(t),disabled:C.length===1,children:"×"})})]}),e.jsxs(f,{className:"g-3 align-items-end",children:[e.jsx(c,{md:2,children:e.jsx(d,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:n.gst_percent,onChange:s=>k(t,"gst_percent",s.target.value)})}),e.jsxs(c,{md:2,children:[e.jsx(u,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(n.cgst_amount||0).toFixed(2)]})]}),e.jsxs(c,{md:2,children:[e.jsx(u,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(n.sgst_amount||0).toFixed(2)]})]}),e.jsxs(c,{md:2,children:[e.jsx(u,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",(n.total_price||0).toFixed(2)]})]}),e.jsx(c,{md:4,children:e.jsx(d,{label:"Remark",placeholder:"Remark",value:n.remark,onChange:s=>k(t,"remark",s.target.value)})})]})]},t)),e.jsx(_,{color:"warning",variant:"outline",className:"mb-4",onClick:ge,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(u,{children:"Total GST (%)"}),e.jsxs(y,{children:[e.jsx(d,{type:"number",name:"gstPercentage",value:l.gstPercentage,onChange:v,min:"0",max:"100",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.gstAmount]})]}),e.jsxs(c,{md:3,children:[e.jsx(u,{children:"SGST (%)"}),e.jsxs(y,{children:[e.jsx(d,{type:"number",name:"sgstPercentage",value:l.sgstPercentage,onChange:v,min:"0",max:"50",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.sgstAmount]})]}),e.jsxs(c,{md:3,children:[e.jsx(u,{children:"CGST (%)"}),e.jsxs(y,{children:[e.jsx(d,{type:"number",name:"cgstPercentage",value:l.cgstPercentage,onChange:v,min:"0",max:"50",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.cgstAmount]})]}),e.jsxs(c,{md:3,children:[e.jsx(u,{children:"IGST (%)"}),e.jsxs(y,{children:[e.jsx(d,{type:"number",name:"igstPercentage",value:l.igstPercentage,onChange:v,min:"0",max:"100",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.igstAmount]})]})]}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(u,{children:"Subtotal"}),e.jsxs(y,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",value:l.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(c,{md:3,children:[e.jsx(u,{children:"Discount"}),e.jsxs(y,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",name:"discount",value:l.discount,onChange:v,min:"0",step:"0.01"})]})]}),e.jsxs(c,{md:3,children:[e.jsx(u,{children:"Taxable Amount"}),e.jsxs(y,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",value:l.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(c,{md:3,children:[e.jsx(u,{children:"Final Amount"}),e.jsxs(y,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",value:l.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:N.map((n,t)=>me===t?e.jsxs(y,{style:{width:"auto"},children:[e.jsx(d,{value:Q,onChange:s=>U(s.target.value)}),e.jsx(_,{color:"success",onClick:()=>{const s=[...N];s[t]=Q,I(s),W(-1)},children:"Save"}),e.jsx(_,{color:"secondary",onClick:()=>W(-1),children:"Cancel"})]},t):e.jsxs(se,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:ne,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{W(t),U(n)}}),e.jsx(A,{icon:re,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{I(N.filter((s,a)=>a!==t))}})]},t))}),e.jsx(f,{className:"mb-3",children:e.jsx(c,{md:6,children:e.jsxs(y,{children:[e.jsx(d,{placeholder:"Add new payment term...",value:R,onChange:n=>H(n.target.value)}),e.jsx(_,{color:"primary",onClick:()=>{R.trim()&&(I([...N,R.trim()]),H(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:T.map((n,t)=>ue===t?e.jsxs(y,{style:{width:"auto"},children:[e.jsx(d,{value:X,onChange:s=>$(s.target.value)}),e.jsx(_,{color:"success",onClick:()=>{const s=[...T];s[t]=X,E(s),O(-1)},children:"Save"}),e.jsx(_,{color:"secondary",onClick:()=>O(-1),children:"Cancel"})]},t):e.jsxs(se,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:ne,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{O(t),$(n)}}),e.jsx(A,{icon:re,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{E(T.filter((s,a)=>a!==t))}})]},t))}),e.jsx(f,{className:"mb-3",children:e.jsx(c,{md:6,children:e.jsxs(y,{children:[e.jsx(d,{placeholder:"Add new condition...",value:D,onChange:n=>J(n.target.value)}),e.jsx(_,{color:"primary",onClick:()=>{D.trim()&&(E([...T,D.trim()]),J(""))},children:"Add"})]})})}),e.jsx(f,{className:"mb-3",children:e.jsxs(c,{md:12,children:[e.jsx(u,{children:"Additional Notes"}),e.jsx(ke,{name:"notes",value:l.notes,onChange:v,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(_,{color:"primary",type:"submit",disabled:B,children:[B?e.jsx(be,{size:"sm"}):e.jsx(A,{icon:Ae,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{Xe as default};

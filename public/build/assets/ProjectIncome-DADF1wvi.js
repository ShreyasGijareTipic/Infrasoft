import{e as pe,u as he,r as o,j as e,C as je}from"./index-BjGmA7Bo.js";import{a as U,b as _e,p as Y}from"./api-CIBCEetx.js";import{p as xe,r as ve,g as ge}from"./Feilds-BHjWXeSc.js";import{c as I,a as f,b as i}from"./index.esm-Dt7Qe3Av.js";import{C as be,a as fe}from"./CCardBody-C0Yq84MQ.js";import{C as ye}from"./CCardHeader-AnyY50zi.js";import{c as J}from"./cil-plus-D8mtC-W5.js";import{C as B}from"./CButton-CC7WAWlS.js";import{c as Ce}from"./cil-arrow-left-D66Kb3Zq.js";import{C as K}from"./cil-mobile-D36DLDwv.js";import{C as Se}from"./CForm-vzVfQCWh.js";import{C as c}from"./CFormLabel-B_oLSbD9.js";import{C as Fe}from"./CInputGroup-ByShXRUz.js";import{C as d}from"./CFormInput-DF8ie22K.js";import{c as Ae}from"./cil-search-CDkY_4k-.js";import{C as V}from"./CFormSelect-CFPHA-xf.js";import{c as ke}from"./cil-pencil-m516yCOw.js";import"./CFormControlWrapper-BkxhhPL_.js";const He=()=>{const q=ge,v=pe(),S=he(),[r,h]=o.useState({project_id:"",po_no:"",po_date:"",invoice_no:"",invoice_date:"",basic_amount:"",gst_amount:"",billing_amount:"",received_amount:"",received_by:"",senders_bank:"",payment_type:"",receivers_bank:"",pending_amount:"",remark:""}),[D,y]=o.useState([]),[C,G]=o.useState([]),[g,N]=o.useState(""),[L,P]=o.useState(""),[F,A]=o.useState(!1),[X,Z]=o.useState(""),[ee,te]=o.useState(""),[ne,w]=o.useState(!1),[_,re]=o.useState(!1),[se,oe]=o.useState(null),[O,z]=o.useState(!1),[k,E]=o.useState(""),[u,ae]=o.useState(!1),[$,ie]=o.useState(null),T=o.useRef(null),R=o.useRef(null),b=(t,s)=>{Z(t),te(s),w(!0),setTimeout(()=>w(!1),5e3)};o.useEffect(()=>{var t,s,m,a,p,j;if((t=v.state)!=null&&t.income){const n=v.state.income;if(ae(v.state.fromInvoice||!1),ie(v.state.orderId||null),h({project_id:n.project_id,po_no:n.po_no||"",po_date:W(n.po_date),invoice_no:n.invoice_no||"",invoice_date:W(n.invoice_date),basic_amount:((s=n.basic_amount)==null?void 0:s.toString())||"",gst_amount:((m=n.gst_amount)==null?void 0:m.toString())||"",billing_amount:((a=n.billing_amount)==null?void 0:a.toString())||"",received_amount:((p=n.received_amount)==null?void 0:p.toString())||"",received_by:n.received_by||"",senders_bank:n.senders_bank||"",payment_type:n.payment_type||"cash",receivers_bank:n.receivers_bank||"",pending_amount:((j=n.pending_amount)==null?void 0:j.toString())||"0.00",remark:n.remark||""}),n.project_id){const x=n.project_name||`Project ${n.project_id}`;E(x),N(n.project_id),P(x)}!v.state.fromInvoice&&n.id&&(re(!0),oe(n.id))}},[v.state,C]);const M=o.useCallback(async()=>{try{const t=await U("/api/projects");G(t||[])}catch(t){console.error("Error fetching all projects:",t),G([])}},[]),Q=o.useCallback(async(t="")=>{try{const s=t?`/api/projects?searchQuery=${t}`:"/api/projects",m=await U(s);y(m||[])}catch(s){console.error("Error fetching projects:",s),y([])}},[]);o.useEffect(()=>{M()},[M]),o.useEffect(()=>{const t=setTimeout(()=>{k.length>0&&F&&!g?Q(k):F&&!g&&y(C)},300);return()=>clearTimeout(t)},[k,Q,C,F,g]),o.useEffect(()=>{const t=s=>{T.current&&!T.current.contains(s.target)&&A(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const ce=t=>{E(t.project_name),N(t.id),P(t.project_name),h(s=>({...s,project_id:t.id})),y([]),A(!1),R.current&&R.current.blur()},le=()=>{C.length>0&&!g&&(y(C),A(!0))},me=t=>{const s=t.target.value;E(s),A(!0),g&&s!==L&&(N(""),P(""),h(m=>({...m,project_id:""})))},l=t=>{const{name:s,value:m}=t.target;if(h(a=>({...a,[s]:m})),s==="basic_amount"){const a=parseFloat(m)||0,p=a*q/100,j=a+p;h(x=>({...x,[s]:m,gst_amount:p.toFixed(2),billing_amount:j.toFixed(2)}));const n=parseFloat(r.received_amount)||0;if(n>0){const x=j-n;h(ue=>({...ue,pending_amount:x>0?x.toFixed(2):"0.00"}))}}else if(s==="received_amount"){const a=parseFloat(r.billing_amount)||0,p=parseFloat(m)||0;if(p>a){b("Received Amount cannot exceed Amount With GST","danger"),h(n=>({...n,[s]:a.toString()}));return}const j=a-p;h(n=>({...n,[s]:m,pending_amount:j>0?j.toFixed(2):"0.00"}))}},de=async t=>{t.preventDefault();const s=parseFloat(r.billing_amount)||0;if((parseFloat(r.received_amount)||0)>s){b("Received Amount cannot exceed Amount With GST","danger");return}if(!r.project_id){b("Please select a project","danger");return}z(!0);try{let a;if(_?a=await _e(`/api/income/${se}`,r):a=await Y("/api/income",r),a.message){if(b(_?"Income updated successfully!":"Income stored successfully!","success"),u&&$)try{await Y(`/api/recordPayment/${$}`,{received_amount:r.received_amount,received_by:r.received_by,payment_type:r.payment_type,senders_bank:r.senders_bank,receivers_bank:r.receivers_bank,remark:r.remark})}catch(p){console.error("Error updating order payment:",p)}setTimeout(()=>{S(u?"/invoiceTable":"/incomeTable")},1500)}else b("Error saving income data","danger")}catch(a){console.error("Error submitting form:",a),b("Error saving income data","danger")}finally{z(!1)}},W=t=>t?new Date(t).toISOString().split("T")[0]:"",H=()=>{S(u?"/invoiceTable":"/incomeTable")};return e.jsx("div",{className:"container-fluid py-4",children:e.jsxs(be,{className:"mb-4",children:[e.jsxs(ye,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(I,{icon:J,className:"me-2"}),u?"Record Payment":_?"Edit Project Income":"Add Project Income"]}),e.jsx("div",{className:"d-flex gap-2",children:(_||u)&&e.jsxs(B,{color:"light",size:"sm",onClick:H,children:[e.jsx(I,{icon:Ce,className:"me-1"}),u?"Back to Invoices":"Cancel"]})})]}),e.jsxs(fe,{children:[u&&e.jsxs(K,{color:"info",className:"mb-3",children:[e.jsx("strong",{children:"Recording Payment:"})," Fill in the payment details below. The order will be automatically updated once the payment is recorded."]}),ne&&e.jsx(K,{color:ee,dismissible:!0,onClose:()=>w(!1),children:X}),e.jsxs(Se,{onSubmit:de,children:[e.jsxs(f,{className:"mb-3",children:[e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"project",children:"Project *"}),e.jsxs("div",{className:"position-relative",ref:T,children:[e.jsxs(Fe,{children:[e.jsx(d,{ref:R,type:"text",value:k,onChange:me,onFocus:le,placeholder:"Search and select project...",className:"border",autoComplete:"off",required:!0,disabled:u}),e.jsx(I,{icon:Ae,className:"position-absolute",style:{right:"10px",top:"50%",transform:"translateY(-50%)",zIndex:5,color:"#6c757d"}})]}),F&&D.length>0&&!u&&e.jsx("div",{className:"dropdown-menu show w-100",style:{maxHeight:"200px",overflowY:"auto",position:"absolute",zIndex:1e3,marginTop:"2px"},children:D.map(t=>e.jsx("div",{className:"dropdown-item cursor-pointer",style:{cursor:"pointer"},onClick:()=>ce(t),children:t.project_name},t.id))}),g&&e.jsxs("div",{className:"text-success mt-1 small",children:["Selected: ",L]})]})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"po_no",children:"PO Number *"}),e.jsx(d,{type:"text",name:"po_no",value:r.po_no,onChange:l,placeholder:"Enter PO Number",required:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"po_date",children:"PO Date *"}),e.jsx(d,{type:"date",name:"po_date",value:r.po_date,onChange:l,required:!0})]})]}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"invoice_no",children:"Invoice Number *"}),e.jsx(d,{type:"text",name:"invoice_no",value:r.invoice_no,onChange:l,placeholder:"Enter Invoice Number",required:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"invoice_date",children:"Invoice Date *"}),e.jsx(d,{type:"date",name:"invoice_date",value:r.invoice_date,onChange:l,required:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"basic_amount",children:"Amount Before GST*"}),e.jsx(d,{type:"number",step:"0.01",name:"basic_amount",value:r.basic_amount,onChange:l,placeholder:"Enter Basic Amount",required:!0})]})]}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(i,{md:4,children:[e.jsxs(c,{htmlFor:"gst_amount",children:["GST Amount (",q,"%)"]}),e.jsx(d,{type:"number",step:"0.01",name:"gst_amount",value:r.gst_amount,onChange:l,placeholder:"Auto-calculated",disabled:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"billing_amount",children:"Amount With GST"}),e.jsx(d,{type:"number",step:"0.01",name:"billing_amount",value:r.billing_amount,onChange:l,placeholder:"Auto-calculated",disabled:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"received_amount",children:"Received Amount *"}),e.jsx(d,{type:"number",step:"0.01",name:"received_amount",value:r.received_amount,onChange:l,placeholder:"Enter Received Amount",required:!0})]})]}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"pending_amount",children:"Pending Amount"}),e.jsx(d,{type:"number",step:"0.01",name:"pending_amount",value:r.pending_amount,onChange:l,placeholder:"Auto-calculated",disabled:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"received_by",children:"Sent By *"}),e.jsx(d,{type:"text",name:"received_by",value:r.received_by,onChange:l,placeholder:"Enter Receiver Name",required:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"payment_type",children:"Payment Type *"}),e.jsxs(V,{name:"payment_type",value:r.payment_type,onChange:l,required:!0,children:[e.jsx("option",{value:"",children:"Select Payment Type"}),xe.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]})]}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"senders_bank",children:"Sender's Bank *"}),e.jsx(d,{type:"text",name:"senders_bank",value:r.senders_bank,onChange:l,placeholder:"Enter Sender's Bank",required:!0})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"receivers_bank",children:"Receiver's Bank *"}),e.jsxs(V,{name:"receivers_bank",value:r.receivers_bank,onChange:l,required:!0,children:[e.jsx("option",{value:"",children:"Select Receiver's Bank"}),ve.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]}),e.jsxs(i,{md:4,children:[e.jsx(c,{htmlFor:"remark",children:"Transaction Number"}),e.jsx(d,{type:"text",name:"remark",value:r.remark,onChange:l,placeholder:"Enter Transaction Number (optional)"})]})]}),e.jsx(f,{children:e.jsxs(i,{md:12,className:"d-flex gap-2",children:[e.jsx(B,{type:"submit",color:"primary",disabled:O,children:O?e.jsxs(e.Fragment,{children:[e.jsx(je,{size:"sm",className:"me-2"}),u?"Recording Payment...":_?"Updating...":"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{icon:_?ke:J,className:"me-2"}),u?"Record Payment":_?"Update Income":"Save Income"]})}),e.jsx(B,{type:"button",color:"secondary",onClick:H,children:"Cancel"})]})})]})]})]})})};export{He as default};

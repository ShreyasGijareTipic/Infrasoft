import{r as m,b as le,k as R,j as e}from"./index-RpBzfmRP.js";import{c as b}from"./index.esm-DUetlGrP.js";import{a as ce,c as de}from"./api-CIBCEetx.js";import{r as oe,p as me}from"./Feilds-BHjWXeSc.js";import{u as pe,a as G,b as U,c as I,d as O,e as W,C as P}from"./DefaultLayout-8YNBKV_4.js";import{C as he}from"./CForm-HJD6m-Ck.js";import{C as i}from"./CFormLabel-CbpozHkd.js";import{C as k}from"./CFormSelect-C4Gr2yJD.js";import{C as l}from"./CFormInput-DA1SntO8.js";import{C as g}from"./CButton-L7dQWiht.js";import{C as H,a as K}from"./CCardBody-CXkOMOvY.js";import{c as V}from"./cil-cloud-upload-Ca9_6_ej.js";import{c as J}from"./cil-trash-CBbKHhHb.js";const Se=({visible:u,onClose:A,expense:p,onExpenseUpdated:T})=>{const[Y,v]=m.useState(!1),[Q,X]=m.useState([]),[N,B]=m.useState(!1),{showToast:h}=le(),{t:d}=pe("global"),[f,C]=m.useState([]),[j,y]=m.useState([]),[x,w]=m.useState([]),[Z,E]=m.useState(!1),S=m.useRef(null),[a,L]=m.useState({name:"",desc:"",expense_id:void 0,qty:1,price:0,total_price:0,expense_date:new Date().toISOString().split("T")[0],show:!0,gst:"",sgst:"",cgst:"",igst:"",contact:"",payment_by:"",payment_type:"",pending_amount:"",isGst:0,photoAvailable:0,photo_url:"",photo_remark:"",bank_name:"",acc_number:"",ifsc:"",aadhar:"",pan:"",transaction_id:""}),D=()=>localStorage.getItem("i18nextLng")||R.language||"en",ee=(s,n=null)=>(n||D())==="mr"&&s.localName||s.name,F=async()=>{try{const s=await ce("/api/expenseType");X(s.filter(n=>n.show===1))}catch(s){h("danger","Error occurred "+s)}};m.useEffect(()=>{u&&F()},[u]),m.useEffect(()=>{u&&F()},[R.language,u]),m.useEffect(()=>{p&&u&&(L({...a,...p,expense_date:p.expense_date||new Date().toISOString().split("T")[0],show:p.show!==void 0?p.show:!0}),p.photos&&Array.isArray(p.photos)?C(p.photos):C([]),y([]),w([]),v(!1))},[p,u]);const M=s=>Number((Math.round(s*100)/100).toFixed(2)),se=s=>{const n=M(parseFloat(s.qty)||0),r=M(parseFloat(s.price)||0);s.total_price=Math.round(n*r)},c=s=>{const{name:n,value:r}=s.target;["price","qty"].includes(n)?L(t=>{const o={...t,[n]:r};return se(o),o}):L(t=>({...t,[n]:r}))},ae=s=>{const n=Array.from(s.target.files),r=[];n.forEach(t=>{if(!["image/jpeg","image/jpg","image/png","application/pdf"].includes(t.type)){h("warning",`${t.name} is not a valid file type.`);return}if(t.size>4096*1024){h("warning",`${t.name} exceeds 4MB size limit.`);return}r.push({file:t,preview:t.type.startsWith("image/")?URL.createObjectURL(t):null,name:t.name,size:(t.size/1024).toFixed(2),type:t.type.includes("pdf")?"pdf":"image",remark:"",id:"new_"+Date.now()+Math.random()})}),y(t=>[...t,...r]),S.current&&(S.current.value="")},ne=s=>{y(n=>{const r=n.filter(o=>o.id!==s),t=n.find(o=>o.id===s);return t&&t.preview&&URL.revokeObjectURL(t.preview),r})},te=s=>{x.includes(s)?w(x.filter(n=>n!==s)):w([...x,s])},q=(s,n)=>{typeof s=="string"&&s.startsWith("new_")?y(r=>r.map(t=>t.id===s?{...t,remark:n}:t)):C(r=>r.map(t=>t.id===s?{...t,remark:n}:t))},_=()=>f.filter(s=>!x.includes(s.id)).length+j.length,z=async s=>{if(s.preventDefault(),s.stopPropagation(),v(!0),a.contact&&!/^\d{10}$/.test(a.contact)){h("danger","Contact number must be exactly 10 digits.");return}if(!a.payment_type){h("danger","Please select payment type");return}if(a.expense_id&&a.price>0&&a.qty>0){B(!0);try{const n=new FormData;n.append("_method","PUT"),n.append("expense_id",a.expense_id),n.append("price",a.price),n.append("qty",a.qty),n.append("total_price",a.total_price),n.append("expense_date",a.expense_date),n.append("show",a.show?1:0),n.append("payment_type",a.payment_type),n.append("payment_by",a.payment_by||""),a.name&&n.append("name",a.name),a.desc&&n.append("desc",a.desc),a.contact&&n.append("contact",a.contact),a.pending_amount&&n.append("pending_amount",a.pending_amount),n.append("isGst",a.isGst?1:0),a.gst&&n.append("gst",a.gst),a.sgst&&n.append("sgst",a.sgst),a.cgst&&n.append("cgst",a.cgst),a.igst&&n.append("igst",a.igst),a.bank_name&&n.append("bank_name",a.bank_name),a.acc_number&&n.append("acc_number",a.acc_number),a.ifsc&&n.append("ifsc",a.ifsc),a.transaction_id&&n.append("transaction_id",a.transaction_id),a.aadhar&&n.append("aadhar",a.aadhar),a.pan&&n.append("pan",a.pan),x.length>0&&x.forEach((t,o)=>{n.append(`delete_photo_ids[${o}]`,t)}),j.length>0&&j.forEach((t,o)=>{n.append(`new_photos[${o}]`,t.file),t.remark&&n.append(`new_photo_remarks[${o}]`,t.remark)}),f.forEach(t=>{x.includes(t.id)||n.append(`photo_remarks[${t.id}]`,t.remark||"")});const r=await de(`/api/expense/${p.id}`,n);r&&r.success?(h("success",d("MSG.expense_updated_successfully")),T&&T(r.expense||a),A()):h("danger",d("MSG.error_occured_please_try_again_later_msg"))}catch(n){h("danger","Error occurred: "+n.message)}finally{B(!1)}}else h("danger",d("MSG.fill_required_fields"))},$=()=>{v(!1),A()},re=new Date().toISOString().split("T")[0],ie=D();return e.jsxs(G,{visible:u,onClose:$,size:"lg",children:[e.jsx(U,{children:e.jsx(I,{children:d("LABELS.edit_expense")})}),e.jsx(O,{children:e.jsxs(he,{noValidate:!0,validated:Y,onSubmit:z,children:[e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-6 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.expense_type")})}),e.jsxs(k,{name:"expense_id",value:a.expense_id||"",onChange:c,required:!0,children:[e.jsx("option",{value:"",children:d("MSG.select_expense_type_msg")}),Q.map(s=>e.jsx("option",{value:s.id,children:ee(s,ie)},s.id))]})]}),e.jsxs("div",{className:"col-sm-6 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.about_expense")})}),e.jsx(l,{name:"name",value:a.name,onChange:c,placeholder:"Enter expense name"})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.expense_date")})}),e.jsx(l,{type:"date",name:"expense_date",max:re,value:a.expense_date,onChange:c,required:!0})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.price_per_unit")})}),e.jsx(l,{type:"number",name:"price",min:"0",step:"0.01",value:a.price,onChange:c,required:!0})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.total_units")})}),e.jsx(l,{type:"number",name:"qty",step:"0.01",min:"0",value:a.qty,onChange:c,required:!0})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.total_price")})}),e.jsx(l,{readOnly:!0,name:"total_price",value:a.total_price})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.contact")})}),e.jsx(l,{type:"text",name:"contact",value:a.contact||"",onChange:s=>{const n=s.target.value;/^\d{0,10}$/.test(n)&&c(s)},maxLength:10,inputMode:"numeric",placeholder:"Enter contact"})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.payment_by")})}),e.jsxs(k,{name:"payment_by",value:a.payment_by||"",onChange:c,children:[e.jsx("option",{value:"",children:d("LABELS.select_payment_by")}),oe.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:d("LABELS.payment_type")})}),e.jsxs(k,{name:"payment_type",value:a.payment_type||"",onChange:c,required:!0,children:[e.jsx("option",{value:"",children:"Select Payment Type"}),me.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]})]}),(a.payment_type==="imps"||a.payment_type==="rtgs"||a.payment_type==="neft")&&e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-3 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Bank Name"})}),e.jsx(l,{name:"bank_name",value:a.bank_name||"",onChange:c,placeholder:"Enter Bank Name"})]}),e.jsxs("div",{className:"col-sm-3 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Account Number"})}),e.jsx(l,{name:"acc_number",value:a.acc_number||"",onChange:c,placeholder:"Enter Account Number"})]}),e.jsxs("div",{className:"col-sm-3 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"IFSC"})}),e.jsx(l,{name:"ifsc",value:a.ifsc||"",onChange:c,placeholder:"Enter IFSC"})]}),e.jsxs("div",{className:"col-sm-3 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Transaction ID"})}),e.jsx(l,{name:"transaction_id",value:a.transaction_id||"",onChange:c,placeholder:"Enter Transaction ID"})]})]}),a.payment_type==="upi"&&e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Transaction ID"})}),e.jsx(l,{name:"transaction_id",value:a.transaction_id||"",onChange:c,placeholder:"Enter Transaction ID"})]})}),a.payment_type==="cheque"&&e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Cheque Number"})}),e.jsx(l,{name:"transaction_id",value:a.transaction_id||"",onChange:c,placeholder:"Enter Cheque Number"})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Bank Name"})}),e.jsx(l,{name:"bank_name",value:a.bank_name||"",onChange:c,placeholder:"Enter Bank Name"})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Aadhar Number"})}),e.jsx(l,{name:"aadhar",value:a.aadhar||"",onChange:c,placeholder:"Enter Aadhar Number"})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"PAN"})}),e.jsx(l,{name:"pan",value:a.pan||"",onChange:c,placeholder:"Enter PAN"})]}),e.jsxs("div",{className:"col-sm-4 mb-3",children:[e.jsx(i,{children:e.jsx("b",{children:"Pending Amount"})}),e.jsx(l,{type:"number",name:"pending_amount",value:a.pending_amount||0,onChange:c,placeholder:"Enter Pending Amount"})]})]}),e.jsxs("div",{className:"row mt-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("hr",{}),e.jsxs("h6",{children:["Photos (",_(),")"]})]}),e.jsxs("div",{className:"col-12 mb-3",children:[e.jsx(i,{htmlFor:"photo_files",children:e.jsx("b",{children:"Upload Photos (JPG, PNG, PDF - Max 4MB each)"})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(l,{ref:S,type:"file",id:"photo_files",name:"photo_files",accept:"image/png, image/jpeg, image/jpg, application/pdf",onChange:ae,multiple:!0,style:{flex:1}}),_()>0&&e.jsxs(g,{color:"info",onClick:()=>E(!0),type:"button",children:["Preview (",_(),")"]})]}),e.jsx("small",{className:"text-muted",children:"You can select multiple files at once"})]})]})]})}),e.jsxs(W,{children:[e.jsx(g,{color:"secondary",onClick:$,disabled:N,children:d("LABELS.cancel")}),e.jsx(g,{color:"primary",onClick:z,disabled:N,children:N?"Updating...":d("LABELS.update_expense")})]}),e.jsxs(G,{visible:Z,onClose:()=>E(!1),size:"xl",scrollable:!0,children:[e.jsx(U,{children:e.jsxs(I,{children:["Photo Preview (",_()," photos)"]})}),e.jsxs(O,{children:[f.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("h6",{children:["Existing Photos (",f.filter(s=>!x.includes(s.id)).length,")"]}),e.jsx("div",{className:"row g-3",children:f.map(s=>{const n=x.includes(s.id);return e.jsx("div",{className:"col-md-4",children:e.jsx(H,{className:n?"border-danger":"",children:e.jsxs(K,{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-center mb-2",style:{height:"200px",backgroundColor:"#f8f9fa",borderRadius:"4px",overflow:"hidden",opacity:n?.3:1,position:"relative"},children:[s.photo_type==="pdf"?e.jsxs("div",{className:"text-center",children:[e.jsx(b,{icon:V,size:"4xl"}),e.jsx("div",{className:"mt-2",children:e.jsx(P,{color:"danger",children:"PDF"})})]}):e.jsx("img",{src:`/${s.photo_url}`,alt:`Photo ${s.id}`,style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}),n&&e.jsx("div",{className:"position-absolute top-50 start-50 translate-middle",children:e.jsx(P,{color:"danger",style:{fontSize:"1rem",padding:"8px"},children:"Marked for Deletion"})})]}),e.jsxs("small",{className:"text-muted d-block mb-2",children:[s.photo_url.split("/").pop(),s.file_size&&` (${s.file_size} KB)`]}),e.jsx(l,{type:"text",size:"sm",placeholder:"Photo remark",value:s.remark||"",onChange:r=>q(s.id,r.target.value),className:"mb-2",disabled:n}),e.jsxs(g,{color:n?"warning":"danger",size:"sm",onClick:()=>te(s.id),className:"w-100",children:[e.jsx(b,{icon:J}),n?"Undo Delete":"Delete"]})]})})},s.id)})})]}),j.length>0&&e.jsxs("div",{children:[e.jsxs("h6",{children:["New Photos to Upload (",j.length,")"]}),e.jsx("div",{className:"row g-3",children:j.map(s=>e.jsx("div",{className:"col-md-4",children:e.jsx(H,{className:"border-success",children:e.jsxs(K,{children:[e.jsx("div",{className:"d-flex align-items-center justify-content-center mb-2",style:{height:"200px",backgroundColor:"#f8f9fa",borderRadius:"4px",overflow:"hidden"},children:s.type==="image"?e.jsx("img",{src:s.preview,alt:s.name,style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}):e.jsxs("div",{className:"text-center",children:[e.jsx(b,{icon:V,size:"4xl"}),e.jsx("div",{className:"mt-2",children:e.jsx(P,{color:"danger",children:"PDF"})})]})}),e.jsxs("small",{className:"text-muted d-block mb-2",children:[s.name," (",s.size," KB)"]}),e.jsx(l,{type:"text",size:"sm",placeholder:"Photo remark",value:s.remark,onChange:n=>q(s.id,n.target.value),className:"mb-2"}),e.jsxs(g,{color:"danger",size:"sm",onClick:()=>ne(s.id),className:"w-100",children:[e.jsx(b,{icon:J})," Remove"]})]})})},s.id))})]}),_()===0&&e.jsx("div",{className:"text-center py-4 text-muted",children:"No photos added yet"})]}),e.jsx(W,{children:e.jsx(g,{color:"secondary",onClick:()=>E(!1),children:"Close"})})]})]})};export{Se as E};

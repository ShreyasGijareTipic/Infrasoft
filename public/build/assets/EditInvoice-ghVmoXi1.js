import{d as O,u as x,e as k,r as m,b as D,j as y}from"./index-ZbBnGUwW.js";import{a as L,b as M}from"./api-CIBCEetx.js";import q from"./Invoice-A91Lu-yC.js";import{u as E}from"./DefaultLayout-BIkduJaW.js";/* empty css                */import"./index.esm-CjRd7TO4.js";import"./ProjectSelectionModal-D2mqX3Xp.js";import"./CFormInput-BlwHhfPK.js";import"./CFormControlWrapper-B0Dgyxun.js";import"./CFormLabel-CK5sZng0.js";import"./CTable-DiPaCHf0.js";import"./CButton-B_ZQUDVk.js";import"./CCardBody-D3Xtntes.js";import"./CCardHeader-DFWDQYhy.js";import"./CForm-CFb5zsUZ.js";import"./CInputGroup-BZyBCIlh.js";import"./CInputGroupText-BeL17f_c.js";import"./cil-x-0440B5Ce.js";import"./cil-search-CDkY_4k-.js";import"./cil-plus-D8mtC-W5.js";import"./CFormSelect-Bt6dv3W8.js";import"./cil-pencil-m516yCOw.js";import"./CFormTextarea-B6tVGQrA.js";import"./RawMaterial-BtjEDAbB.js";import"./cil-mobile-Da8wudM0.js";const mt=()=>{const{id:n}=O(),A=x(),N=k(),s=new URLSearchParams(N.search).get("convertTo"),[T,v]=m.useState(null),[h,P]=m.useState(!0),[j,S]=m.useState(!1),{showToast:i}=D(),{t:a}=E("global");m.useEffect(()=>{(async()=>{try{const t=await L(`/api/order/${n}`);if(console.log("Fetched order:",t),t){const r=t.project||{},u=Number(t.gst||0),d=Number(t.sgst||0),l=Number(t.cgst||0),p=Number(t.igst||0),o=Number(t.totalAmount||0);let g=0,_=0,b=0,f=0;o>0&&(g=u/o*100,_=d/o*100,b=l/o*100,f=p/o*100),v({projectId:t.project_id||r.id||null,customer_id:t.customer_id||null,projectName:r.project_name||"N/A",customer:{name:r.customer_name||"Unknown",address:r.work_place||"",mobile:r.mobile_number||""},lat:t.lat||"",long:t.long||"",payLater:!!t.payLater,isSettled:!!t.isSettled,invoiceDate:t.invoiceDate||"",deliveryTime:t.deliveryTime||"",deliveryDate:t.deliveryDate||"",invoiceType:s?parseInt(s):t.invoiceType||3,orderStatus:s?parseInt(s):t.orderStatus||1,items:(t.items||[]).map(e=>({id:e.id,work_type:e.work_type||"",uom:e.uom||"",qty:Number(e.qty||0),price:Number(e.price||0),total_price:Number(e.total_price||0),remark:e.remark||"",gst_percent:e.gst_percent!==null&&e.gst_percent!==void 0?Number(e.gst_percent):18,cgst_amount:Number(e.cgst_amount||0),sgst_amount:Number(e.sgst_amount||0)})).sort((e,w)=>(e.id||0)-(w.id||0)),totalAmount:o,subtotal:o,taxableAmount:o,discount:Number(t.discount||0),paidAmount:Number(t.paidAmount||0),finalAmount:Number(t.finalAmount||0),balanceAmount:Number(t.finalAmount||0)-Number(t.paidAmount||0),gstAmount:u,sgstAmount:d,cgstAmount:l,igstAmount:p,gstPercentage:Math.round(g*100)/100,sgstPercentage:Math.round(_*100)/100,cgstPercentage:Math.round(b*100)/100,igstPercentage:Math.round(f*100)/100,paymentType:t.paymentType||0,company_id:t.company_id||null,payment_terms:t.payment_terms||"",terms_and_conditions:t.terms_and_conditions||"",note:t.note||"",ref_id:t.ref_id||"",po_number:t.po_number||""}),S(!0)}else i("danger","No order data found")}catch(t){console.error("Fetch order error:",t),i("danger",a("TOAST.fetch_order_failed"))}finally{P(!1)}})()},[n,s,a]);const I=async c=>{try{const t={...c,id:n,project_id:c.projectId,remainingBalance:Number(c.finalAmount||0)-Number(c.paidAmount||0)};console.log("Updating order:",t);const r=await M(`/api/order/${n}`,t);r!=null&&r.success?(i("success",a("TOAST.order_updated")),A(`/invoice-details/${n}`)):i("danger",(r==null?void 0:r.message)||a("TOAST.update_failed"))}catch(t){console.error("Update error:",t),i("danger",a("TOAST.update_error"))}};return h||!j?y.jsx("div",{children:a("TOAST.loading")}):y.jsx(q,{editMode:!0,initialData:T,onSubmit:I})};export{mt as default};

import{e as ve,u as Pe,b as ke,r as h,j as e,C as Ae}from"./index-C2yVeD7S.js";import{a as f,b as o,c as A}from"./index.esm-BfesGHR4.js";import{p as Se}from"./api-CIBCEetx.js";import{C as re,a as oe}from"./CCardBody-D-jAy6vr.js";import{C as Ne}from"./cil-mobile-YEmBCbC2.js";import{C as b}from"./CButton-pXUvGqWL.js";import{C as Te}from"./CCardHeader-6bNqU1xa.js";import{c as Fe}from"./cil-arrow-left-D66Kb3Zq.js";import{C as we}from"./CForm-9WpppnGX.js";import{C as g}from"./CFormLabel-eLpXnSYX.js";import{C as d}from"./CFormInput-CXoXZ5N_.js";import{C as x}from"./CInputGroup-Dl8FeEzY.js";import{C as P}from"./CInputGroupText-BfFQ-DqL.js";import{C as ae}from"./DefaultLayout-BQzMumzV.js";import{c as ce}from"./cil-pencil-m516yCOw.js";import{c as le}from"./cil-x-0440B5Ce.js";import{C as Ge}from"./CFormTextarea-CPboTIMv.js";import{c as Me}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-D7XNeBGJ.js";import"./RawMaterial-BtjEDAbB.js";const tt=()=>{var Y,Z,ee;const ie=ve(),M=Pe(),{showToast:S}=ke(),{workOrderId:B,workOrderData:m}=ie.state||{},[L,Q]=h.useState(!1),[de,me]=h.useState(!1);h.useState([]);const[ue,qe]=h.useState([]),[a,q]=h.useState({work_order_id:B||null,project_id:(m==null?void 0:m.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[C,w]=h.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:"",gst_percent:18,cgst_amount:0,sgst_amount:0}]),ge=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[N,I]=h.useState(ge),[he,W]=h.useState(-1),[U,H]=h.useState(""),[R,X]=h.useState(""),pe=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[T,E]=h.useState(pe),[xe,O]=h.useState(-1),[$,J]=h.useState(""),[D,K]=h.useState("");h.useState(""),h.useEffect(()=>{if(m){let n=0,t=0,s=0,r=0;const l=parseFloat(m.totalAmount)||0,c=parseFloat(m.cgst)||0,u=parseFloat(m.sgst)||0,j=parseFloat(m.igst)||0,_=parseFloat(m.gst)||0;if(l>0&&(c>0&&(s=Math.round(c/l*100*100)/100),u>0&&(t=Math.round(u/l*100*100)/100),j>0&&(r=Math.round(j/l*100*100)/100),_>0?n=Math.round(_/l*100*100)/100:n=s+t+r),q(y=>({...y,work_order_id:m.id,project_id:m.project_id,gstPercentage:n,sgstPercentage:t,cgstPercentage:s,igstPercentage:r})),m.items&&m.items.length>0){const y=m.items.map(i=>{const p=parseFloat(i.qty)||0,G=parseFloat(i.price)||0,V=parseFloat(i.total_price)||0;let F=0;if(i.gst_percent!==null&&i.gst_percent!==void 0)F=parseFloat(i.gst_percent),isNaN(F)&&(F=0);else{const te=parseFloat(i.cgst_amount)||0,se=parseFloat(i.sgst_amount)||0,ne=p*G;if(ne>0&&(te>0||se>0)){const Ce=te+se;F=Math.round(Ce/ne*100*100)/100}}const _e=parseFloat(i.cgst_amount)||0,fe=parseFloat(i.sgst_amount)||0;return{work_type:i.work_type||"",uom:i.uom||"",qty:p,price:G,total_price:V,remark:i.remark||"",gst_percent:F,cgst_amount:_e,sgst_amount:fe}});w(y),z(y)}}},[m]);const v=n=>{const{name:t,value:s}=n.target;q(r=>{let l={...r,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(s)||0:s};if(t==="gstPercentage"){const u=(parseFloat(s)||0)/2;l={...l,sgstPercentage:u,cgstPercentage:u}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const c=t==="sgstPercentage"?parseFloat(s)||0:r.sgstPercentage,u=t==="cgstPercentage"?parseFloat(s)||0:r.cgstPercentage;l={...l,gstPercentage:c+u}}if(t==="discount"||t.endsWith("Percentage")){const c=C.reduce((G,V)=>G+(V.total_price||0),0),u=c-l.discount,j=u*(l.sgstPercentage/100),_=u*(l.cgstPercentage/100),y=u*(l.igstPercentage/100),i=j+_+y,p=u+i;l={...l,subtotal:c,taxableAmount:u,gstAmount:i,sgstAmount:j,cgstAmount:_,igstAmount:y,finalAmount:p}}return l})},k=(n,t,s)=>{const r=[...C];t==="qty"||t==="price"?r[n][t]=s===""?0:parseFloat(s)||0:t==="gst_percent"?r[n].gst_percent=s===""||s===null||s===void 0?0:parseFloat(s)||0:r[n][t]=s;const l=r[n].qty||0,c=r[n].price||0,u=r[n].gst_percent??0,j=l*c,_=u/2,y=Math.round(j*(_/100)*100)/100,i=Math.round(j*(_/100)*100)/100;r[n].cgst_amount=y,r[n].sgst_amount=i,r[n].total_price=Math.round((j+y+i)*100)/100,w(r),z(r)},je=()=>{w([...C,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:0,cgst_amount:0,sgst_amount:0,remark:""}])},ye=n=>{const t=[...C];t.splice(n,1),w(t),z(t)},z=n=>{q(t=>{const s=n.reduce((i,p)=>i+p.qty*p.price,0);n.reduce((i,p)=>i+(p.cgst_amount||0),0),n.reduce((i,p)=>i+(p.sgst_amount||0),0);const r=n.reduce((i,p)=>i+(p.total_price||0),0),l=Math.round(r*(t.sgstPercentage/100)*100)/100,c=Math.round(r*(t.cgstPercentage/100)*100)/100,u=Math.round(r*(t.igstPercentage/100)*100)/100,j=Math.round((l+c+u)*100)/100,_=Math.round((r+j)*100)/100,y=Math.round((_-(t.discount||0))*100)/100;return{...t,subtotal:Math.round(s*100)/100,taxableAmount:Math.round(r*100)/100,gstAmount:j,cgstAmount:c,sgstAmount:l,igstAmount:u,finalAmount:y}})},be=async n=>{if(n.preventDefault(),!n.currentTarget.checkValidity()){me(!0);return}if(!a.work_order_id||!a.project_id){S("danger","Work order and project information missing");return}if(C.length===0||C.every(s=>!s.work_type||s.qty<=0)){S("danger","Please add at least one valid work item");return}try{Q(!0);const s=C.filter(c=>c.work_type&&c.qty>0).map(c=>({work_type:c.work_type,uom:c.uom||null,qty:parseFloat(c.qty)||0,price:parseFloat(c.price)||0,total_price:parseFloat(c.total_price)||0,remark:c.remark||null,gst_percent:c.gst_percent!==null&&c.gst_percent!==void 0?parseFloat(c.gst_percent):0,cgst_amount:parseFloat(c.cgst_amount)||0,sgst_amount:parseFloat(c.sgst_amount)||0})),r={work_order_id:a.work_order_id,project_id:a.project_id,tally_invoice_number:a.tally_invoice_number||null,invoice_date:a.invoice_date,delivery_date:a.delivery_date||null,items:s,discount:a.discount,gst_percentage:a.gstPercentage,cgst_percentage:a.cgstPercentage,sgst_percentage:a.sgstPercentage,igst_percentage:a.igstPercentage,rule_ids:ue,notes:a.notes||null,payment_terms:N.join(`
`),terms_conditions:T.join(`
`)},l=await Se("/api/proforma-invoices",r);l&&l.success?(S("success","Proforma invoice created successfully"),setTimeout(()=>{M(`/proforma-invoice-details/${l.data.id}`)},1500)):S("danger",l.message||"Failed to create proforma invoice",8e3)}catch(s){console.error("Submit error:",s);const r=s.message||"Failed to create proforma invoice";S("danger",r,8e3)}finally{Q(!1)}};return!B||!m?e.jsx(re,{children:e.jsx(oe,{children:e.jsxs(Ne,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(b,{color:"primary",onClick:()=>M("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(f,{children:e.jsx(o,{xs:12,children:e.jsxs(re,{className:"mb-4",children:[e.jsx(Te,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(b,{color:"secondary",size:"sm",onClick:()=>M("/invoiceTable"),children:[e.jsx(A,{icon:Fe,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(oe,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(f,{children:[e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:m.invoice_number})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(Y=m.project)==null?void 0:Y.project_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(Z=m.project)==null?void 0:Z.customer_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(ee=m.project)==null?void 0:ee.work_place})]})]})]}),e.jsxs(we,{validated:de,onSubmit:be,children:[e.jsxs(f,{className:"mb-3",children:[e.jsxs(o,{md:4,children:[e.jsx(g,{children:"Tally Invoice Number"}),e.jsx(d,{type:"text",name:"tally_invoice_number",value:a.tally_invoice_number,onChange:v,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(o,{md:4,children:[e.jsx(g,{children:"Invoice Date *"}),e.jsx(d,{type:"date",name:"invoice_date",value:a.invoice_date,onChange:v,required:!0})]}),e.jsxs(o,{md:4,children:[e.jsx(g,{children:"Delivery Date"}),e.jsx(d,{type:"date",name:"delivery_date",value:a.delivery_date,onChange:v})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),C.map((n,t)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(f,{className:"g-3 mb-2 align-items-end",children:[e.jsx(o,{md:3,children:e.jsx(d,{label:"Work Type *",placeholder:"Work Type",value:n.work_type,onChange:s=>k(t,"work_type",s.target.value),required:!0})}),e.jsx(o,{md:2,children:e.jsx(d,{label:"UOM",placeholder:"Unit",value:n.uom,onChange:s=>k(t,"uom",s.target.value)})}),e.jsx(o,{md:2,children:e.jsx(d,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:n.qty,onChange:s=>k(t,"qty",s.target.value),required:!0})}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"Rate *"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",step:"0.01",min:"0",value:n.price,onChange:s=>k(t,"price",s.target.value),required:!0})]})]}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",((n.qty||0)*(n.price||0)).toFixed(2)]})]}),e.jsx(o,{md:1,className:"d-flex align-items-end",children:e.jsx(b,{color:"danger",size:"sm",onClick:()=>ye(t),disabled:C.length===1,children:"×"})})]}),e.jsxs(f,{className:"g-3 align-items-end",children:[e.jsx(o,{md:2,children:e.jsx(d,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:n.gst_percent,onChange:s=>k(t,"gst_percent",s.target.value)})}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(n.cgst_amount||0).toFixed(2)]})]}),e.jsxs(o,{md:2,children:[e.jsx(g,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(n.sgst_amount||0).toFixed(2)]})]}),e.jsxs(o,{md:2,children:[e.jsx(g,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",(n.total_price||0).toFixed(2)]})]}),e.jsx(o,{md:4,children:e.jsx(d,{label:"Remark",placeholder:"Remark",value:n.remark,onChange:s=>k(t,"remark",s.target.value)})})]})]},t)),e.jsx(b,{color:"warning",variant:"outline",className:"mb-4",onClick:je,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Total GST (%)"}),e.jsxs(x,{children:[e.jsx(d,{type:"number",name:"gstPercentage",value:a.gstPercentage,onChange:v,min:"0",max:"100",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.gstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"SGST (%)"}),e.jsxs(x,{children:[e.jsx(d,{type:"number",name:"sgstPercentage",value:a.sgstPercentage,onChange:v,min:"0",max:"50",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.sgstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"CGST (%)"}),e.jsxs(x,{children:[e.jsx(d,{type:"number",name:"cgstPercentage",value:a.cgstPercentage,onChange:v,min:"0",max:"50",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.cgstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"IGST (%)"}),e.jsxs(x,{children:[e.jsx(d,{type:"number",name:"igstPercentage",value:a.igstPercentage,onChange:v,min:"0",max:"100",step:"0.01"}),e.jsx(P,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.igstAmount.toFixed(2)]})]})]}),e.jsxs(f,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Subtotal"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",value:a.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Discount"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",name:"discount",value:a.discount,onChange:v,min:"0",step:"0.01"})]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Taxable Amount"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",value:a.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(g,{children:"Final Amount"}),e.jsxs(x,{children:[e.jsx(P,{children:"₹"}),e.jsx(d,{type:"number",value:a.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:N.map((n,t)=>he===t?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(d,{value:U,onChange:s=>H(s.target.value)}),e.jsx(b,{color:"success",onClick:()=>{const s=[...N];s[t]=U,I(s),W(-1)},children:"Save"}),e.jsx(b,{color:"secondary",onClick:()=>W(-1),children:"Cancel"})]},t):e.jsxs(ae,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:ce,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{W(t),H(n)}}),e.jsx(A,{icon:le,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{I(N.filter((s,r)=>r!==t))}})]},t))}),e.jsx(f,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(x,{children:[e.jsx(d,{placeholder:"Add new payment term...",value:R,onChange:n=>X(n.target.value)}),e.jsx(b,{color:"primary",onClick:()=>{R.trim()&&(I([...N,R.trim()]),X(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:T.map((n,t)=>xe===t?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(d,{value:$,onChange:s=>J(s.target.value)}),e.jsx(b,{color:"success",onClick:()=>{const s=[...T];s[t]=$,E(s),O(-1)},children:"Save"}),e.jsx(b,{color:"secondary",onClick:()=>O(-1),children:"Cancel"})]},t):e.jsxs(ae,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:ce,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{O(t),J(n)}}),e.jsx(A,{icon:le,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{E(T.filter((s,r)=>r!==t))}})]},t))}),e.jsx(f,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(x,{children:[e.jsx(d,{placeholder:"Add new condition...",value:D,onChange:n=>K(n.target.value)}),e.jsx(b,{color:"primary",onClick:()=>{D.trim()&&(E([...T,D.trim()]),K(""))},children:"Add"})]})})}),e.jsx(f,{className:"mb-3",children:e.jsxs(o,{md:12,children:[e.jsx(g,{children:"Additional Notes"}),e.jsx(Ge,{name:"notes",value:a.notes,onChange:v,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(b,{color:"primary",type:"submit",disabled:L,children:[L?e.jsx(Ae,{size:"sm"}):e.jsx(A,{icon:Me,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{tt as default};

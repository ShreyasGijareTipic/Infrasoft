import{e as ve,u as ke,b as Pe,r as u,j as e,C as Se}from"./index-2dn3aAPo.js";import{a as b,b as l,c as k}from"./index.esm-BqU7uZM5.js";import{p as Ae}from"./api-CIBCEetx.js";import{C as ne,a as oe}from"./CCardBody-HQDdpy5u.js";import{C as Ne}from"./cil-mobile-Mmz4KEyA.js";import{C as _}from"./CButton-BUp8JCLl.js";import{C as Te}from"./CCardHeader-CSgV6VVv.js";import{c as we}from"./cil-arrow-left-D66Kb3Zq.js";import{C as Fe}from"./CForm-BXgIXJvs.js";import{C as x}from"./CFormLabel-DZUJOBB2.js";import{C as g}from"./CFormInput-DgsDA3z5.js";import{C}from"./CInputGroup-BlJhRiG_.js";import{C as G}from"./CInputGroupText-BaanX0VJ.js";import{C as ae}from"./DefaultLayout-iLQNBb61.js";import{c as ce}from"./cil-pencil-m516yCOw.js";import{c as le}from"./cil-x-0440B5Ce.js";import{C as Ge}from"./CFormTextarea-BuvJZLbz.js";import{c as Me}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-DrysVgi4.js";import"./RawMaterial-BtjEDAbB.js";const tt=()=>{var Y,Z,ee;const ie=ve(),M=ke(),{showToast:P}=Pe(),{workOrderId:B,workOrderData:i}=ie.state||{},[L,Q]=u.useState(!1),[de,me]=u.useState(!1);u.useState([]);const[ue,qe]=u.useState([]),[d,q]=u.useState({work_order_id:B||null,project_id:(i==null?void 0:i.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:0,sgstPercentage:0,cgstPercentage:0,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[y,w]=u.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:"",gst_percent:18,cgst_amount:9,sgst_amount:9}]),ge=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[S,I]=u.useState(ge),[pe,W]=u.useState(-1),[U,H]=u.useState(""),[R,X]=u.useState(""),he=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[A,E]=u.useState(he),[je,O]=u.useState(-1),[$,J]=u.useState(""),[D,K]=u.useState("");u.useState(""),u.useEffect(()=>{if(i){let r=0,t=0,s=0,n=0;const c=parseFloat(i.totalAmount)||0,a=parseFloat(i.cgst)||0,m=parseFloat(i.sgst)||0,h=parseFloat(i.igst)||0,f=parseFloat(i.gst)||0;if(c>0&&(a>0&&(s=Math.round(a/c*100*100)/100),m>0&&(t=Math.round(m/c*100*100)/100),h>0&&(n=Math.round(h/c*100*100)/100),f>0?r=Math.round(f/c*100*100)/100:r=s+t+n),q(j=>({...j,work_order_id:i.id,project_id:i.project_id,gstPercentage:r,sgstPercentage:t,cgstPercentage:s,igstPercentage:n})),i.items&&i.items.length>0){const j=i.items.map(o=>{const p=parseFloat(o.qty)||0,F=parseFloat(o.price)||0,V=parseFloat(o.total_price)||0;let T=0;if(o.gst_percent!==null&&o.gst_percent!==void 0)T=parseFloat(o.gst_percent),isNaN(T)&&(T=0);else{const te=parseFloat(o.cgst_amount)||0,se=parseFloat(o.sgst_amount)||0,re=p*F;if(re>0&&(te>0||se>0)){const Ce=te+se;T=Math.round(Ce/re*100*100)/100}}const ye=parseFloat(o.cgst_amount)||0,be=parseFloat(o.sgst_amount)||0;return{id:o.id,work_type:o.work_type||"",uom:o.uom||"",qty:p,price:F,total_price:V,remark:o.remark||"",gst_percent:T,cgst_amount:ye,sgst_amount:be}}).sort((o,p)=>(o.id||0)-(p.id||0));w(j),z(j)}}},[i]);const N=r=>{const{name:t,value:s}=r.target;q(n=>{let c={...n,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(s)||0:s};if(t==="gstPercentage"){const m=(parseFloat(s)||0)/2;c={...c,sgstPercentage:m,cgstPercentage:m}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const a=t==="sgstPercentage"?parseFloat(s)||0:n.sgstPercentage,m=t==="cgstPercentage"?parseFloat(s)||0:n.cgstPercentage;c={...c,gstPercentage:a+m}}if(t==="discount"||t.endsWith("Percentage")){const a=y.reduce((F,V)=>F+(V.total_price||0),0),m=a-c.discount,h=m*(c.sgstPercentage/100),f=m*(c.cgstPercentage/100),j=m*(c.igstPercentage/100),o=h+f+j,p=m+o;c={...c,subtotal:a,taxableAmount:m,gstAmount:o,sgstAmount:h,cgstAmount:f,igstAmount:j,finalAmount:p}}return c})},v=(r,t,s)=>{const n=[...y];t==="qty"||t==="price"?n[r][t]=s===""?0:parseFloat(s)||0:t==="gst_percent"?n[r].gst_percent=s===""||s===null||s===void 0?0:parseFloat(s)||0:n[r][t]=s;const c=n[r].qty||0,a=n[r].price||0,m=n[r].gst_percent??0,h=c*a,f=m/2,j=Math.round(h*(f/100)*100)/100,o=Math.round(h*(f/100)*100)/100;n[r].cgst_amount=j,n[r].sgst_amount=o,n[r].total_price=Math.round((h+j+o)*100)/100,w(n),z(n)},xe=()=>{w([...y,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:9,sgst_amount:9,remark:""}])},_e=r=>{const t=[...y];t.splice(r,1),w(t),z(t)},z=r=>{q(t=>{const s=r.reduce((o,p)=>o+p.qty*p.price,0);r.reduce((o,p)=>o+(p.cgst_amount||0),0),r.reduce((o,p)=>o+(p.sgst_amount||0),0);const n=r.reduce((o,p)=>o+(p.total_price||0),0),c=Math.round(n*(t.sgstPercentage/100)*100)/100,a=Math.round(n*(t.cgstPercentage/100)*100)/100,m=Math.round(n*(t.igstPercentage/100)*100)/100,h=Math.round((c+a+m)*100)/100,f=Math.round((n+h)*100)/100,j=Math.round((f-(t.discount||0))*100)/100;return{...t,subtotal:Math.round(s*100)/100,taxableAmount:Math.round(n*100)/100,gstAmount:h,cgstAmount:a,sgstAmount:c,igstAmount:m,finalAmount:j}})},fe=async r=>{if(r.preventDefault(),!r.currentTarget.checkValidity()){me(!0);return}if(!d.work_order_id||!d.project_id){P("danger","Work order and project information missing");return}if(y.length===0||y.every(s=>!s.work_type||s.qty<=0)){P("danger","Please add at least one valid work item");return}try{Q(!0);const s=y.filter(a=>a.work_type&&a.qty>0).map(a=>({work_type:a.work_type,uom:a.uom||null,qty:parseFloat(a.qty)||0,price:parseFloat(a.price)||0,total_price:parseFloat(a.total_price)||0,remark:a.remark||null,gst_percent:a.gst_percent!==null&&a.gst_percent!==void 0?parseFloat(a.gst_percent):0,cgst_amount:parseFloat(a.cgst_amount)||0,sgst_amount:parseFloat(a.sgst_amount)||0})),n={work_order_id:d.work_order_id,project_id:d.project_id,tally_invoice_number:d.tally_invoice_number||null,invoice_date:d.invoice_date,delivery_date:d.delivery_date||null,items:s,discount:d.discount,gst_percentage:d.gstPercentage,cgst_percentage:d.cgstPercentage,sgst_percentage:d.sgstPercentage,igst_percentage:d.igstPercentage,rule_ids:ue,notes:d.notes||null,payment_terms:S.join(`
`),terms_conditions:A.join(`
`)},c=await Ae("/api/proforma-invoices",n);c&&c.success?(P("success","Proforma invoice created successfully"),setTimeout(()=>{M(`/proforma-invoice-details/${c.data.id}`)},1500)):P("danger",c.message||"Failed to create proforma invoice",8e3)}catch(s){console.error("Submit error:",s);const n=s.message||"Failed to create proforma invoice";P("danger",n,8e3)}finally{Q(!1)}};return!B||!i?e.jsx(ne,{children:e.jsx(oe,{children:e.jsxs(Ne,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(_,{color:"primary",onClick:()=>M("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(b,{children:e.jsx(l,{xs:12,children:e.jsxs(ne,{className:"mb-4",children:[e.jsx(Te,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(_,{color:"secondary",size:"sm",onClick:()=>M("/invoiceTable"),children:[e.jsx(k,{icon:we,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(oe,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(b,{children:[e.jsxs(l,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:i.invoice_number})})]}),e.jsxs(l,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(Y=i.project)==null?void 0:Y.project_name})})]}),e.jsxs(l,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(Z=i.project)==null?void 0:Z.customer_name})})]}),e.jsxs(l,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(ee=i.project)==null?void 0:ee.work_place})]})]})]}),e.jsxs(Fe,{validated:de,onSubmit:fe,children:[e.jsxs(b,{className:"mb-3",children:[e.jsxs(l,{md:4,children:[e.jsx(x,{children:"Tally Invoice Number"}),e.jsx(g,{type:"text",name:"tally_invoice_number",value:d.tally_invoice_number,onChange:N,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(l,{md:4,children:[e.jsx(x,{children:"Invoice Date *"}),e.jsx(g,{type:"date",name:"invoice_date",value:d.invoice_date,onChange:N,required:!0})]}),e.jsxs(l,{md:4,children:[e.jsx(x,{children:"Delivery Date"}),e.jsx(g,{type:"date",name:"delivery_date",value:d.delivery_date,onChange:N})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),y.map((r,t)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(b,{className:"g-3 mb-2 align-items-end",children:[e.jsx(l,{md:3,children:e.jsx(g,{label:"Work Type *",placeholder:"Work Type",value:r.work_type,onChange:s=>v(t,"work_type",s.target.value),required:!0})}),e.jsx(l,{md:2,children:e.jsx(g,{label:"UOM",placeholder:"Unit",value:r.uom,onChange:s=>v(t,"uom",s.target.value)})}),e.jsx(l,{md:2,children:e.jsx(g,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:r.qty,onChange:s=>v(t,"qty",s.target.value),required:!0})}),e.jsxs(l,{md:2,children:[e.jsx(x,{children:"Rate *"}),e.jsxs(C,{children:[e.jsx(G,{children:"₹"}),e.jsx(g,{type:"number",step:"0.01",min:"0",value:r.price,onChange:s=>v(t,"price",s.target.value),required:!0})]})]}),e.jsxs(l,{md:2,children:[e.jsx(x,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",((r.qty||0)*(r.price||0)).toFixed(2)]})]}),e.jsx(l,{md:1,className:"d-flex align-items-end",children:e.jsx(_,{color:"danger",size:"sm",onClick:()=>_e(t),disabled:y.length===1,children:"×"})})]}),e.jsxs(b,{className:"g-3 align-items-end",children:[e.jsx(l,{md:2,children:e.jsx(g,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:r.gst_percent,onChange:s=>v(t,"gst_percent",s.target.value)})}),e.jsxs(l,{md:2,children:[e.jsx(x,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(r.cgst_amount||0).toFixed(2)]})]}),e.jsxs(l,{md:2,children:[e.jsx(x,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(r.sgst_amount||0).toFixed(2)]})]}),e.jsxs(l,{md:2,children:[e.jsx(x,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",(r.total_price||0).toFixed(2)]})]}),e.jsx(l,{md:4,children:e.jsx(g,{label:"Remark",placeholder:"Remark",value:r.remark,onChange:s=>v(t,"remark",s.target.value)})})]})]},t)),e.jsx(_,{color:"warning",variant:"outline",className:"mb-4",onClick:xe,children:"+ Add Work"}),e.jsxs(b,{className:"mb-3",children:[e.jsxs(l,{md:3,children:[e.jsx(x,{children:"Total Amount before GST"}),e.jsxs(C,{children:[e.jsx(G,{children:"₹"}),e.jsx(g,{type:"number",value:d.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(l,{md:3,children:[e.jsx(x,{children:"Discount"}),e.jsxs(C,{children:[e.jsx(G,{children:"₹"}),e.jsx(g,{type:"number",name:"discount",value:d.discount,onChange:N,min:"0",step:"0.01"})]})]}),e.jsxs(l,{md:3,children:[e.jsx(x,{children:"Total Amount after GST"}),e.jsxs(C,{children:[e.jsx(G,{children:"₹"}),e.jsx(g,{type:"number",value:d.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:S.map((r,t)=>pe===t?e.jsxs(C,{style:{width:"auto"},children:[e.jsx(g,{value:U,onChange:s=>H(s.target.value)}),e.jsx(_,{color:"success",onClick:()=>{const s=[...S];s[t]=U,I(s),W(-1)},children:"Save"}),e.jsx(_,{color:"secondary",onClick:()=>W(-1),children:"Cancel"})]},t):e.jsxs(ae,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[r,e.jsx(k,{icon:ce,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{W(t),H(r)}}),e.jsx(k,{icon:le,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{I(S.filter((s,n)=>n!==t))}})]},t))}),e.jsx(b,{className:"mb-3",children:e.jsx(l,{md:6,children:e.jsxs(C,{children:[e.jsx(g,{placeholder:"Add new payment term...",value:R,onChange:r=>X(r.target.value)}),e.jsx(_,{color:"primary",onClick:()=>{R.trim()&&(I([...S,R.trim()]),X(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:A.map((r,t)=>je===t?e.jsxs(C,{style:{width:"auto"},children:[e.jsx(g,{value:$,onChange:s=>J(s.target.value)}),e.jsx(_,{color:"success",onClick:()=>{const s=[...A];s[t]=$,E(s),O(-1)},children:"Save"}),e.jsx(_,{color:"secondary",onClick:()=>O(-1),children:"Cancel"})]},t):e.jsxs(ae,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[r,e.jsx(k,{icon:ce,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{O(t),J(r)}}),e.jsx(k,{icon:le,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{E(A.filter((s,n)=>n!==t))}})]},t))}),e.jsx(b,{className:"mb-3",children:e.jsx(l,{md:6,children:e.jsxs(C,{children:[e.jsx(g,{placeholder:"Add new condition...",value:D,onChange:r=>K(r.target.value)}),e.jsx(_,{color:"primary",onClick:()=>{D.trim()&&(E([...A,D.trim()]),K(""))},children:"Add"})]})})}),e.jsx(b,{className:"mb-3",children:e.jsxs(l,{md:12,children:[e.jsx(x,{children:"Additional Notes"}),e.jsx(Ge,{name:"notes",value:d.notes,onChange:N,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(_,{color:"primary",type:"submit",disabled:L,children:[L?e.jsx(Se,{size:"sm"}):e.jsx(k,{icon:Me,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{tt as default};

import{e as xe,u as je,b as ye,r as d,j as e,C as be}from"./index-fatTeUCR.js";import{a as y,b as n,c as S}from"./index.esm-Mmat67Is.js";import{p as _e}from"./api-CIBCEetx.js";import{C as Y,a as Z}from"./CCardBody-CWs2rFEf.js";import{C as fe}from"./cil-mobile-D_M5GP1R.js";import{C as x}from"./CButton-Dnh0eu3x.js";import{C as Ce}from"./CCardHeader-DIjx7CZA.js";import{c as ve}from"./cil-arrow-left-D66Kb3Zq.js";import{C as ke}from"./CForm-BbEA8t0A.js";import{C as m}from"./CFormLabel-Cp8KupB2.js";import{C as i}from"./CFormInput-wID138bU.js";import{C as h}from"./CInputGroup-B1hWyDLI.js";import{C}from"./CInputGroupText-5zhABSqH.js";import{C as ee}from"./DefaultLayout-Dto4nkGD.js";import{c as te}from"./cil-pencil-m516yCOw.js";import{c as se}from"./cil-x-0440B5Ce.js";import{C as Pe}from"./CFormTextarea-cNlJlc5V.js";import{c as Se}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-BGWL0obt.js";import"./RawMaterial-BtjEDAbB.js";const Xe=()=>{var $,J,K;const re=xe(),F=je(),{showToast:N}=ye(),{workOrderId:z,workOrderData:u}=re.state||{},[V,B]=d.useState(!1),[ne,ae]=d.useState(!1);d.useState([]);const[oe,Ne]=d.useState([]),[a,G]=d.useState({work_order_id:z||null,project_id:(u==null?void 0:u.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[b,w]=d.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:"",gst_percent:18,cgst_amount:0,sgst_amount:0}]),ce=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[T,q]=d.useState(ce),[le,I]=d.useState(-1),[L,M]=d.useState(""),[W,Q]=d.useState(""),ie=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[A,R]=d.useState(ie),[me,E]=d.useState(-1),[U,H]=d.useState(""),[O,X]=d.useState("");d.useState(""),d.useEffect(()=>{if(u&&(G(s=>({...s,work_order_id:u.id,project_id:u.project_id})),u.items&&u.items.length>0)){const s=u.items.map(t=>({work_type:t.work_type||"",uom:t.uom||"",qty:t.qty||0,price:t.price||0,total_price:t.total_price||0,remark:t.remark||"",gst_percent:parseFloat(t.gst_percent)||0,cgst_amount:parseFloat(t.cgst_amount)||0,sgst_amount:parseFloat(t.sgst_amount)||0}));w(s),D(s)}},[u]);const _=s=>{const{name:t,value:r}=s.target;G(o=>{let l={...o,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(r)||0:r};if(t==="gstPercentage"){const g=(parseFloat(r)||0)/2;l={...l,sgstPercentage:g,cgstPercentage:g}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const c=t==="sgstPercentage"?parseFloat(r)||0:o.sgstPercentage,g=t==="cgstPercentage"?parseFloat(r)||0:o.cgstPercentage;l={...l,gstPercentage:c+g}}if(t==="discount"||t.endsWith("Percentage")){const c=b.reduce((pe,he)=>pe+(he.total_price||0),0),g=c-l.discount,f=g*(l.sgstPercentage/100),P=g*(l.cgstPercentage/100),v=g*(l.igstPercentage/100),p=f+P+v,j=g+p;l={...l,subtotal:c,taxableAmount:g,gstAmount:p,sgstAmount:f,cgstAmount:P,igstAmount:v,finalAmount:j}}return l})},k=(s,t,r)=>{const o=[...b];t==="qty"||t==="price"?o[s][t]=parseFloat(r)||0:t==="gst_percent"?o[s].gst_percent=r===""?0:parseFloat(r)||0:o[s][t]=r;const l=o[s].qty||0,c=o[s].price||0,g=o[s].gst_percent||0,f=l*c,P=g/2,v=f*(P/100),p=f*(P/100);o[s].cgst_amount=v,o[s].sgst_amount=p,o[s].total_price=f+v+p,w(o),D(o)},de=()=>{w([...b,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:0,sgst_amount:0,remark:""}])},ue=s=>{const t=[...b];t.splice(s,1),w(t),D(t)},D=s=>{G(t=>{const r=s.reduce((p,j)=>p+j.qty*j.price,0);s.reduce((p,j)=>p+(j.cgst_amount||0),0),s.reduce((p,j)=>p+(j.sgst_amount||0),0);const o=s.reduce((p,j)=>p+(j.total_price||0),0),l=o*(t.sgstPercentage/100),c=o*(t.cgstPercentage/100),g=o*(t.igstPercentage/100),f=l+c+g,v=o+f-(t.discount||0);return{...t,subtotal:r,taxableAmount:o,gstAmount:f,cgstAmount:c,sgstAmount:l,igstAmount:g,finalAmount:v}})},ge=async s=>{if(s.preventDefault(),!s.currentTarget.checkValidity()){ae(!0);return}if(!a.work_order_id||!a.project_id){N("danger","Work order and project information missing");return}if(b.length===0||b.every(r=>!r.work_type||r.qty<=0)){N("danger","Please add at least one valid work item");return}try{B(!0);const r=b.filter(c=>c.work_type&&c.qty>0).map(c=>({work_type:c.work_type,uom:c.uom||null,qty:parseFloat(c.qty)||0,price:parseFloat(c.price)||0,total_price:parseFloat(c.total_price)||0,remark:c.remark||null,gst_percent:parseFloat(c.gst_percent)||18,cgst_amount:parseFloat(c.cgst_amount)||0,sgst_amount:parseFloat(c.sgst_amount)||0})),o={work_order_id:a.work_order_id,project_id:a.project_id,tally_invoice_number:a.tally_invoice_number||null,invoice_date:a.invoice_date,delivery_date:a.delivery_date||null,items:r,discount:a.discount,gst_percentage:a.gstPercentage,cgst_percentage:a.cgstPercentage,sgst_percentage:a.sgstPercentage,igst_percentage:a.igstPercentage,rule_ids:oe,notes:a.notes||null,payment_terms:T.join(`
`),terms_conditions:A.join(`
`)},l=await _e("/api/proforma-invoices",o);l&&l.success?(N("success","Proforma invoice created successfully"),setTimeout(()=>{F(`/proforma-invoice-details/${l.data.id}`)},1500)):N("danger",l.message||"Failed to create proforma invoice",8e3)}catch(r){console.error("Submit error:",r);const o=r.message||"Failed to create proforma invoice";N("danger",o,8e3)}finally{B(!1)}};return!z||!u?e.jsx(Y,{children:e.jsx(Z,{children:e.jsxs(fe,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(x,{color:"primary",onClick:()=>F("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(y,{children:e.jsx(n,{xs:12,children:e.jsxs(Y,{className:"mb-4",children:[e.jsx(Ce,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(x,{color:"secondary",size:"sm",onClick:()=>F("/invoiceTable"),children:[e.jsx(S,{icon:ve,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(Z,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(y,{children:[e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:u.invoice_number})})]}),e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:($=u.project)==null?void 0:$.project_name})})]}),e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(J=u.project)==null?void 0:J.customer_name})})]}),e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(K=u.project)==null?void 0:K.work_place})]})]})]}),e.jsxs(ke,{validated:ne,onSubmit:ge,children:[e.jsxs(y,{className:"mb-3",children:[e.jsxs(n,{md:4,children:[e.jsx(m,{children:"Tally Invoice Number"}),e.jsx(i,{type:"text",name:"tally_invoice_number",value:a.tally_invoice_number,onChange:_,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(n,{md:4,children:[e.jsx(m,{children:"Invoice Date *"}),e.jsx(i,{type:"date",name:"invoice_date",value:a.invoice_date,onChange:_,required:!0})]}),e.jsxs(n,{md:4,children:[e.jsx(m,{children:"Delivery Date"}),e.jsx(i,{type:"date",name:"delivery_date",value:a.delivery_date,onChange:_})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),b.map((s,t)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(y,{className:"g-3 mb-2 align-items-end",children:[e.jsx(n,{md:3,children:e.jsx(i,{label:"Work Type *",placeholder:"Work Type",value:s.work_type,onChange:r=>k(t,"work_type",r.target.value),required:!0})}),e.jsx(n,{md:2,children:e.jsx(i,{label:"UOM",placeholder:"Unit",value:s.uom,onChange:r=>k(t,"uom",r.target.value)})}),e.jsx(n,{md:2,children:e.jsx(i,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:s.qty,onChange:r=>k(t,"qty",r.target.value),required:!0})}),e.jsxs(n,{md:2,children:[e.jsx(m,{children:"Rate *"}),e.jsxs(h,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",step:"0.01",min:"0",value:s.price,onChange:r=>k(t,"price",r.target.value),required:!0})]})]}),e.jsxs(n,{md:2,children:[e.jsx(m,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",((s.qty||0)*(s.price||0)).toFixed(2)]})]}),e.jsx(n,{md:1,className:"d-flex align-items-end",children:e.jsx(x,{color:"danger",size:"sm",onClick:()=>ue(t),disabled:b.length===1,children:"×"})})]}),e.jsxs(y,{className:"g-3 align-items-end",children:[e.jsx(n,{md:2,children:e.jsx(i,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:s.gst_percent,onChange:r=>k(t,"gst_percent",r.target.value)})}),e.jsxs(n,{md:2,children:[e.jsx(m,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(s.cgst_amount||0).toFixed(2)]})]}),e.jsxs(n,{md:2,children:[e.jsx(m,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",Number(s.sgst_amount||0).toFixed(2)]})]}),e.jsxs(n,{md:2,children:[e.jsx(m,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",(s.total_price||0).toFixed(2)]})]}),e.jsx(n,{md:4,children:e.jsx(i,{label:"Remark",placeholder:"Remark",value:s.remark,onChange:r=>k(t,"remark",r.target.value)})})]})]},t)),e.jsx(x,{color:"warning",variant:"outline",className:"mb-4",onClick:de,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(y,{className:"mb-3",children:[e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Total GST (%)"}),e.jsxs(h,{children:[e.jsx(i,{type:"number",name:"gstPercentage",value:a.gstPercentage,onChange:_,min:"0",max:"100",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.gstAmount]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"SGST (%)"}),e.jsxs(h,{children:[e.jsx(i,{type:"number",name:"sgstPercentage",value:a.sgstPercentage,onChange:_,min:"0",max:"50",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.sgstAmount]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"CGST (%)"}),e.jsxs(h,{children:[e.jsx(i,{type:"number",name:"cgstPercentage",value:a.cgstPercentage,onChange:_,min:"0",max:"50",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.cgstAmount]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"IGST (%)"}),e.jsxs(h,{children:[e.jsx(i,{type:"number",name:"igstPercentage",value:a.igstPercentage,onChange:_,min:"0",max:"100",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.igstAmount]})]})]}),e.jsxs(y,{className:"mb-3",children:[e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Subtotal"}),e.jsxs(h,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",value:a.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Discount"}),e.jsxs(h,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",name:"discount",value:a.discount,onChange:_,min:"0",step:"0.01"})]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Taxable Amount"}),e.jsxs(h,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",value:a.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Final Amount"}),e.jsxs(h,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",value:a.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:T.map((s,t)=>le===t?e.jsxs(h,{style:{width:"auto"},children:[e.jsx(i,{value:L,onChange:r=>M(r.target.value)}),e.jsx(x,{color:"success",onClick:()=>{const r=[...T];r[t]=L,q(r),I(-1)},children:"Save"}),e.jsx(x,{color:"secondary",onClick:()=>I(-1),children:"Cancel"})]},t):e.jsxs(ee,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[s,e.jsx(S,{icon:te,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{I(t),M(s)}}),e.jsx(S,{icon:se,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{q(T.filter((r,o)=>o!==t))}})]},t))}),e.jsx(y,{className:"mb-3",children:e.jsx(n,{md:6,children:e.jsxs(h,{children:[e.jsx(i,{placeholder:"Add new payment term...",value:W,onChange:s=>Q(s.target.value)}),e.jsx(x,{color:"primary",onClick:()=>{W.trim()&&(q([...T,W.trim()]),Q(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:A.map((s,t)=>me===t?e.jsxs(h,{style:{width:"auto"},children:[e.jsx(i,{value:U,onChange:r=>H(r.target.value)}),e.jsx(x,{color:"success",onClick:()=>{const r=[...A];r[t]=U,R(r),E(-1)},children:"Save"}),e.jsx(x,{color:"secondary",onClick:()=>E(-1),children:"Cancel"})]},t):e.jsxs(ee,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[s,e.jsx(S,{icon:te,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{E(t),H(s)}}),e.jsx(S,{icon:se,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{R(A.filter((r,o)=>o!==t))}})]},t))}),e.jsx(y,{className:"mb-3",children:e.jsx(n,{md:6,children:e.jsxs(h,{children:[e.jsx(i,{placeholder:"Add new condition...",value:O,onChange:s=>X(s.target.value)}),e.jsx(x,{color:"primary",onClick:()=>{O.trim()&&(R([...A,O.trim()]),X(""))},children:"Add"})]})})}),e.jsx(y,{className:"mb-3",children:e.jsxs(n,{md:12,children:[e.jsx(m,{children:"Additional Notes"}),e.jsx(Pe,{name:"notes",value:a.notes,onChange:_,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(x,{color:"primary",type:"submit",disabled:V,children:[V?e.jsx(be,{size:"sm"}):e.jsx(S,{icon:Se,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{Xe as default};

import{d as De,u as Ee,b as Re,r as u,j as e,C as pe}from"./index-95D3pMM8.js";import{a as v,b as c,c as F}from"./index.esm-DxutiY6j.js";import{a as he,b as We}from"./api-CIBCEetx.js";import{C as H,a as X}from"./CCardBody-dOzHbfOa.js";import{C as Oe}from"./cil-mobile-DjllxSOU.js";import{C as f}from"./CButton-B_ZYbnJ4.js";import{C as ze}from"./CCardHeader-Cq-j3fyp.js";import{c as Be}from"./cil-arrow-left-D66Kb3Zq.js";import{C as Ve}from"./CForm-DyhjnECG.js";import{C as m}from"./CFormLabel-C_2Vxs-X.js";import{C as i}from"./CFormInput-C_VETgxc.js";import{C as Le}from"./CFormSelect-uqS5fg-9.js";import{C as j}from"./CInputGroup-B3cbnFfp.js";import{C}from"./CInputGroupText-CMKr1FZN.js";import{C as xe}from"./DefaultLayout-CJHw--2-.js";import{c as je}from"./cil-pencil-m516yCOw.js";import{c as ye}from"./cil-x-0440B5Ce.js";import{C as $e}from"./CFormTextarea-B-FmTaE-.js";import{c as Ue}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-DhbFIWP9.js";import"./RawMaterial-BtjEDAbB.js";const ht=()=>{var oe,ce,le;const{id:N}=De(),T=Ee(),{showToast:w}=Re(),[fe,J]=u.useState(!0),[V,K]=u.useState(!1),[_e,be]=u.useState(!1),[Me,ve]=u.useState([]),[Ce,Y]=u.useState([]),[A,Se]=u.useState(null),[l,L]=u.useState({tally_invoice_number:"",invoice_date:"",delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",status:"draft",terms_conditions:"",payment_terms:""}),[S,E]=u.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}]),[G,q]=u.useState([]),[Pe,$]=u.useState(-1),[Z,ee]=u.useState(""),[U,te]=u.useState(""),[I,D]=u.useState([]),[Ne,M]=u.useState(-1),[se,ne]=u.useState(""),[Q,re]=u.useState("");u.useEffect(()=>{Te(),Ae()},[N]);const Te=async()=>{var n,s;try{J(!0);const r=await he(`/api/proforma-invoices/${N}`);if(r&&r.success&&r.data){const t=r.data;Se(t);let a=[];t.details&&t.details.length>0?a=t.details.map(o=>{const p=parseFloat(o.qty)||0,qe=parseFloat(o.price)||0,Ie=parseFloat(o.total_price)||0;let O=0;o.gst_percent!==null&&o.gst_percent!==void 0&&(O=parseFloat(o.gst_percent),isNaN(O)&&(O=0));let z=0;o.cgst_amount!==null&&o.cgst_amount!==void 0&&(z=parseFloat(o.cgst_amount),isNaN(z)&&(z=0));let B=0;return o.sgst_amount!==null&&o.sgst_amount!==void 0&&(B=parseFloat(o.sgst_amount),isNaN(B)&&(B=0)),{work_type:o.work_type||"",uom:o.uom||"",qty:p,price:qe,total_price:Ie,gst_percent:O,cgst_amount:z,sgst_amount:B,remark:o.remark||""}}):a=[{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:0,cgst_amount:0,sgst_amount:0,remark:""}];const y=a.reduce((o,p)=>o+p.qty*p.price,0),d=a.reduce((o,p)=>o+(p.cgst_amount||0),0),_=a.reduce((o,p)=>o+(p.sgst_amount||0),0),P=d+_,h=a.reduce((o,p)=>o+(p.total_price||0),0),g=parseFloat(t.gst_percentage)||0,x=parseFloat(t.sgst_percentage)||0,R=parseFloat(t.cgst_percentage)||0,W=parseFloat(t.igst_percentage)||0,ie=h*(x/100),me=h*(R/100),de=h*(W/100),ue=ie+me+de,ge=parseFloat(t.discount)||0,Ge=h+ue-ge;if(L({tally_invoice_number:t.tally_invoice_number||"",invoice_date:((n=t.invoice_date)==null?void 0:n.split("T")[0])||"",delivery_date:((s=t.delivery_date)==null?void 0:s.split("T")[0])||"",discount:ge,subtotal:y,taxableAmount:h,gstAmount:ue,sgstAmount:ie,cgstAmount:me,igstAmount:de,finalAmount:Ge,gstPercentage:g,sgstPercentage:x,cgstPercentage:R,igstPercentage:W,notes:t.notes||"",status:t.status||"draft",terms_conditions:t.terms_conditions||"",payment_terms:t.payment_terms||""}),E(a),t.payment_terms){const o=t.payment_terms.split(`
`).filter(p=>p.trim()!=="");q(o.length>0?o:[])}else q([]);if(t.terms_conditions){const o=t.terms_conditions.split(`
`).filter(p=>p.trim()!=="");D(o.length>0?o:[])}else D([]);t.invoice_rules&&t.invoice_rules.length>0?Y(t.invoice_rules.map(o=>o.rules_id)):Y([])}else w("danger","Failed to load proforma invoice"),setTimeout(()=>T("/invoiceTable"),2e3)}catch(r){console.error("Error fetching proforma invoice:",r),w("danger","Failed to load proforma invoice"),setTimeout(()=>T("/invoiceTable"),2e3)}finally{J(!1)}},Ae=async()=>{try{const n=await he("/api/rules");ve(Array.isArray(n)?n:[])}catch(n){console.error("Error fetching rules:",n)}},b=n=>{const{name:s,value:r}=n.target;L(t=>{let a={...t,[s]:s==="discount"||s.endsWith("Percentage")?parseFloat(r)||0:r};if(s==="gstPercentage"){const d=(parseFloat(r)||0)/2;a={...a,sgstPercentage:d,cgstPercentage:d}}else if(s==="sgstPercentage"||s==="cgstPercentage"){const y=s==="sgstPercentage"?parseFloat(r)||0:t.sgstPercentage,d=s==="cgstPercentage"?parseFloat(r)||0:t.cgstPercentage;a={...a,gstPercentage:y+d}}if(s==="discount"||s.endsWith("Percentage")){const y=S.reduce((R,W)=>R+(W.total_price||0),0),d=y-a.discount,_=d*(a.sgstPercentage/100),P=d*(a.cgstPercentage/100),h=d*(a.igstPercentage/100),g=_+P+h,x=d+g;a={...a,subtotal:y,taxableAmount:d,gstAmount:g,sgstAmount:_,cgstAmount:P,igstAmount:h,finalAmount:x}}return a})},k=(n,s,r)=>{const t=[...S];s==="qty"||s==="price"?t[n][s]=r===""?0:parseFloat(r)||0:s==="gst_percent"?t[n].gst_percent=r===""||r===null||r===void 0?0:parseFloat(r)||0:t[n][s]=r;const a=t[n].qty||0,y=t[n].price||0,d=t[n].gst_percent??0,_=a*y,P=d/2,h=_*(P/100),g=_*(P/100);t[n].cgst_amount=h,t[n].sgst_amount=g,t[n].total_price=_+h+g,E(t),ae(t)},ke=()=>{E([...S,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:0,sgst_amount:0,remark:""}])},Fe=n=>{if(S.length===1)return;const s=[...S];s.splice(n,1),E(s),ae(s)},ae=n=>{L(s=>{const r=n.reduce((g,x)=>g+x.qty*x.price,0);n.reduce((g,x)=>g+(x.cgst_amount||0),0),n.reduce((g,x)=>g+(x.sgst_amount||0),0);const t=n.reduce((g,x)=>g+(x.total_price||0),0),a=t*(s.sgstPercentage/100),y=t*(s.cgstPercentage/100),d=t*(s.igstPercentage/100),_=a+y+d,h=t+_-(s.discount||0);return{...s,subtotal:r,taxableAmount:t,gstAmount:_,cgstAmount:y,sgstAmount:a,igstAmount:d,finalAmount:h}})},we=async n=>{if(n.preventDefault(),!n.currentTarget.checkValidity()){be(!0);return}try{K(!0);const r={tally_invoice_number:l.tally_invoice_number||null,invoice_date:l.invoice_date,delivery_date:l.delivery_date||null,items:S.filter(a=>a.work_type&&a.qty>0).map(a=>({work_type:a.work_type,uom:a.uom,qty:a.qty,price:a.price,total_price:a.total_price,remark:a.remark||"",gst_percent:a.gst_percent,cgst_amount:a.cgst_amount,sgst_amount:a.sgst_amount})),discount:l.discount,gst_percentage:l.gstPercentage,cgst_percentage:l.cgstPercentage,sgst_percentage:l.sgstPercentage,igst_percentage:l.igstPercentage,rule_ids:Ce,notes:l.notes||null,status:l.status,terms_conditions:I.join(`
`)||null,payment_terms:G.join(`
`)||null},t=await We(`/api/proforma-invoices/${N}`,r);t&&t.success?(w("success","Proforma invoice updated successfully"),setTimeout(()=>{T(`/proforma-invoice-details/${N}`)},1500)):w("danger",t.message||"Failed to update proforma invoice",8e3)}catch(r){console.error("Update error:",r);const t=r.message||"Failed to update proforma invoice";w("danger",t,8e3)}finally{K(!1)}};return fe?e.jsx(H,{children:e.jsxs(X,{className:"text-center py-5",children:[e.jsx(pe,{color:"primary"}),e.jsx("div",{className:"mt-3",children:"Loading proforma invoice..."})]})}):A?e.jsx(v,{children:e.jsx(c,{xs:12,children:e.jsxs(H,{className:"mb-4",children:[e.jsx(ze,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("strong",{children:["Edit Proforma Invoice #",A.proforma_invoice_number]}),e.jsxs(f,{color:"secondary",size:"sm",onClick:()=>T(`/proforma-invoice-details/${N}`),children:[e.jsx(F,{icon:Be,className:"me-1"}),"Back to Details"]})]})}),e.jsxs(X,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(v,{children:[e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order #:"}),e.jsx("div",{children:e.jsx("strong",{children:(oe=A.work_order)==null?void 0:oe.invoice_number})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(ce=A.project)==null?void 0:ce.project_name})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(le=A.customer)==null?void 0:le.name})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Payment Status:"}),e.jsx("div",{children:e.jsx("strong",{className:"text-capitalize",children:A.payment_status})})]})]})]}),e.jsxs(Ve,{validated:_e,onSubmit:we,children:[e.jsxs(v,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Tally Invoice Number"}),e.jsx(i,{type:"text",name:"tally_invoice_number",value:l.tally_invoice_number,onChange:b,placeholder:"Optional"})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Invoice Date *"}),e.jsx(i,{type:"date",name:"invoice_date",value:l.invoice_date,onChange:b,required:!0})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Delivery Date"}),e.jsx(i,{type:"date",name:"delivery_date",value:l.delivery_date,onChange:b})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Status"}),e.jsxs(Le,{name:"status",value:l.status,onChange:b,children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"sent",children:"Sent"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),S.map((n,s)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(v,{className:"g-3 mb-2 align-items-end",children:[e.jsx(c,{md:3,children:e.jsx(i,{label:"Work Type *",placeholder:"Work Type",value:n.work_type,onChange:r=>k(s,"work_type",r.target.value),required:!0})}),e.jsx(c,{md:2,children:e.jsx(i,{label:"UOM",placeholder:"Unit",value:n.uom,onChange:r=>k(s,"uom",r.target.value)})}),e.jsx(c,{md:2,children:e.jsx(i,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:n.qty,onChange:r=>k(s,"qty",r.target.value),required:!0})}),e.jsxs(c,{md:2,children:[e.jsx(m,{children:"Rate *"}),e.jsxs(j,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",step:"0.01",min:"0",value:n.price,onChange:r=>k(s,"price",r.target.value),required:!0})]})]}),e.jsxs(c,{md:2,children:[e.jsx(m,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",(n.qty*n.price).toFixed(2)]})]}),e.jsx(c,{md:1,className:"d-flex align-items-end",children:e.jsx(f,{color:"danger",size:"sm",onClick:()=>Fe(s),disabled:S.length===1,children:"×"})})]}),e.jsxs(v,{className:"g-3 align-items-end",children:[e.jsx(c,{md:2,children:e.jsx(i,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:n.gst_percent,onChange:r=>k(s,"gst_percent",r.target.value)})}),e.jsxs(c,{md:2,children:[e.jsx(m,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",n.cgst_amount.toFixed(2)]})]}),e.jsxs(c,{md:2,children:[e.jsx(m,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",n.sgst_amount.toFixed(2)]})]}),e.jsxs(c,{md:2,children:[e.jsx(m,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",n.total_price.toFixed(2)]})]}),e.jsx(c,{md:4,children:e.jsx(i,{label:"Remark",placeholder:"Remark",value:n.remark,onChange:r=>k(s,"remark",r.target.value)})})]})]},s)),e.jsx(f,{color:"warning",variant:"outline",className:"mb-4",onClick:ke,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(v,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Total GST (%)"}),e.jsxs(j,{children:[e.jsx(i,{type:"number",name:"gstPercentage",value:l.gstPercentage,onChange:b,min:"0",max:"100",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.gstAmount.toFixed(2)]})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"SGST (%)"}),e.jsxs(j,{children:[e.jsx(i,{type:"number",name:"sgstPercentage",value:l.sgstPercentage,onChange:b,min:"0",max:"50",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.sgstAmount.toFixed(2)]})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"CGST (%)"}),e.jsxs(j,{children:[e.jsx(i,{type:"number",name:"cgstPercentage",value:l.cgstPercentage,onChange:b,min:"0",max:"50",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.cgstAmount.toFixed(2)]})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"IGST (%)"}),e.jsxs(j,{children:[e.jsx(i,{type:"number",name:"igstPercentage",value:l.igstPercentage,onChange:b,min:"0",max:"100",step:"0.01"}),e.jsx(C,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",l.igstAmount.toFixed(2)]})]})]}),e.jsxs(v,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Subtotal"}),e.jsxs(j,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",value:l.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Discount"}),e.jsxs(j,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",name:"discount",value:l.discount,onChange:b,min:"0",step:"0.01"})]})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Taxable Amount"}),e.jsxs(j,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",value:l.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(c,{md:3,children:[e.jsx(m,{children:"Final Amount"}),e.jsxs(j,{children:[e.jsx(C,{children:"₹"}),e.jsx(i,{type:"number",value:l.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:G.map((n,s)=>Pe===s?e.jsxs(j,{style:{width:"auto"},children:[e.jsx(i,{value:Z,onChange:r=>ee(r.target.value)}),e.jsx(f,{color:"success",onClick:()=>{const r=[...G];r[s]=Z.trim(),q(r),$(-1)},children:"Save"}),e.jsx(f,{color:"secondary",onClick:()=>$(-1),children:"Cancel"})]},s):e.jsxs(xe,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(F,{icon:je,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{$(s),ee(n)}}),e.jsx(F,{icon:ye,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{q(G.filter((r,t)=>t!==s))}})]},s))}),e.jsx(v,{className:"mb-3",children:e.jsx(c,{md:6,children:e.jsxs(j,{children:[e.jsx(i,{placeholder:"Add new payment term...",value:U,onChange:n=>te(n.target.value)}),e.jsx(f,{color:"primary",onClick:()=>{U.trim()&&(q([...G,U.trim()]),te(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:I.map((n,s)=>Ne===s?e.jsxs(j,{style:{width:"auto"},children:[e.jsx(i,{value:se,onChange:r=>ne(r.target.value)}),e.jsx(f,{color:"success",onClick:()=>{const r=[...I];r[s]=se.trim(),D(r),M(-1)},children:"Save"}),e.jsx(f,{color:"secondary",onClick:()=>M(-1),children:"Cancel"})]},s):e.jsxs(xe,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(F,{icon:je,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{M(s),ne(n)}}),e.jsx(F,{icon:ye,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{D(I.filter((r,t)=>t!==s))}})]},s))}),e.jsx(v,{className:"mb-3",children:e.jsx(c,{md:6,children:e.jsxs(j,{children:[e.jsx(i,{placeholder:"Add new condition...",value:Q,onChange:n=>re(n.target.value)}),e.jsx(f,{color:"primary",onClick:()=>{Q.trim()&&(D([...I,Q.trim()]),re(""))},children:"Add"})]})})}),e.jsx(v,{className:"mb-3",children:e.jsxs(c,{md:12,children:[e.jsx(m,{children:"Additional Notes"}),e.jsx($e,{name:"notes",value:l.notes,onChange:b,rows:3,placeholder:"Enter any additional notes..."})]})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(f,{color:"primary",type:"submit",disabled:V,children:[V?e.jsx(pe,{size:"sm"}):e.jsx(F,{icon:Ue,className:"me-1"}),"Update Proforma Invoice"]}),e.jsx(f,{color:"secondary",onClick:()=>T(`/proforma-invoice-details/${N}`),disabled:V,children:"Cancel"})]})]})]})]})})}):e.jsx(H,{children:e.jsx(X,{children:e.jsxs(Oe,{color:"danger",children:[e.jsx("h5",{children:"Proforma Invoice Not Found"}),e.jsx("p",{children:"The requested proforma invoice could not be found."}),e.jsx(f,{color:"primary",onClick:()=>T("/invoiceTable"),children:"Back to Orders"})]})})})};export{ht as default};

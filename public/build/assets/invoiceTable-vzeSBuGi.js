import{u as Ye,r as x,j as e,C as oe}from"./index-C2yVeD7S.js";import{a as he,b as tt,g as st,d as nt}from"./api-CIBCEetx.js";import{c as O,a as ue,b as S}from"./index.esm-BfesGHR4.js";import{R as at}from"./RecordPaymentModal-D4yJqWF7.js";import{a as ke,b as Fe,c as Ae,d as Pe,C as Ce,e as Te,m as lt}from"./DefaultLayout-BQzMumzV.js";import{c as we}from"./cil-history-D-FQjjfl.js";import{C as ve}from"./cil-mobile-YEmBCbC2.js";import{c as _e}from"./cil-calendar-B69zOQSH.js";import{C as b}from"./CButton-pXUvGqWL.js";import{C as ot}from"./CCollapse-DKhOZC2e.js";import{c as Be}from"./cil-pencil-m516yCOw.js";import{c as rt}from"./cil-credit-card-KG5pHjdT.js";import{c as Ue}from"./cil-x-0440B5Ce.js";import{C as He}from"./CForm-9WpppnGX.js";import{C as H}from"./CFormLabel-eLpXnSYX.js";import{C as Q}from"./CFormInput-CXoXZ5N_.js";import{C as it}from"./CFormSelect-Cs5qoCpd.js";import{C as Se}from"./CFormCheck-BVuPHuFe.js";import{C as ct}from"./CFormTextarea-CPboTIMv.js";import{c as Ze}from"./cil-cloud-download-CPU_poQw.js";import{E as Ge}from"./jspdf.es.min-DXUXeSrX.js";import"./jspdf.plugin.autotable-nrCojwMH.js";import{C as dt,a as mt}from"./CCardBody-D-jAy6vr.js";import{C as ht}from"./CCardHeader-6bNqU1xa.js";import{C as xt,a as ut,b as Ne,c as se,d as gt,e as K}from"./CTable-BcsPMDrs.js";import{c as pt}from"./cil-trash-CBbKHhHb.js";import"./Feilds-BHjWXeSc.js";import"./RawMaterial-BtjEDAbB.js";import"./CFormControlWrapper-D7XNeBGJ.js";import"./typeof-QjJsDpFa.js";import"./jspdf.es.min-NBB-aZqm.js";var jt=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M256.684,16.736A239.3,239.3,0,0,0,87.475,425.245,239.3,239.3,0,0,0,425.894,86.825,237.736,237.736,0,0,0,256.684,16.736Zm-9.9,32.242L146.033,224.237,92.048,130.226A207.136,207.136,0,0,1,246.787,48.978Zm56.437,127.035,45.912,79.413-46.2,80.791h-92.6l-45.859-79.859,46.189-80.345ZM72.648,160.7,173.436,336.217H65.526A207.1,207.1,0,0,1,72.648,160.7Zm9.791,207.515h202.2l-53.494,93.542A207.584,207.584,0,0,1,82.439,368.217Zm184.818,94.849L367.668,287.48l54.168,93.692A207.167,207.167,0,0,1,267.257,463.066ZM441.125,350.6,340.187,176.013H447.908A207.133,207.133,0,0,1,441.125,350.6ZM229.063,144.013l53.825-93.627a207.609,207.609,0,0,1,148.147,93.627Z' class='ci-primary'/>"],ft=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='359.873 121.377 337.246 144.004 433.243 240.001 16 240.001 16 240.002 16 272.001 16 272.002 433.24 272.002 337.246 367.996 359.873 390.623 494.498 256 359.873 121.377' class='ci-primary'/>"],vt=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M256.072,424l-11.421-11.313-85.808-85.809.053-.054L16,183.928l97.122-97.122,142.9,142.9,142.9-142.9,97.122,97.122L353.243,326.722l-11.361,11.469Zm-.107-45.254.054.053,51.835-51.835L319.2,315.511,450.783,183.928,398.915,132.06l-142.9,142.9-142.9-142.9L61.254,183.928l142.9,142.9-.053.054Z' class='ci-primary'/>"],bt=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M398.986,424.715,256,281.73,113.014,424.715l-97.17-97.169L158.8,184.59l11.29-11.4L256,87.285l5.481,5.531,5.89,5.834,85.907,85.908-.054.054L496.156,327.546ZM61.1,327.546l51.915,51.915L256,236.474,398.986,379.461,450.9,327.546,307.863,184.508l.054-.053-51.812-51.813-.051.051-.1-.106-51.866,51.869-11.312,11.418Z' class='ci-primary'/>"],yt=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M19.409,431.289v41.468a24.124,24.124,0,0,0,24.1,24.1H76.877A149.445,149.445,0,0,0,183.25,452.792L383.966,252.075l55.846,56.069,22.671-22.582-55.889-56.114,1.287-1.288-.021-.02,63.287-63.287a84.853,84.853,0,0,0,0-120l-4-4a84.852,84.852,0,0,0-120,0l-64.326,64.326L230.947,53.1,208.275,75.68,260.387,128,63.471,324.916A149.449,149.449,0,0,0,19.409,431.289ZM369.774,63.48a52.854,52.854,0,0,1,74.747,0l4,4a52.913,52.913,0,0,1,0,74.745L387.147,203.6,308.4,124.853Zm-85.72,86.107,78.573,78.573-69.176,69.176v-.483H136.788ZM104.788,328.853H261.935L160.623,430.165a117.662,117.662,0,0,1-83.746,34.688H51.409V431.289A117.664,117.664,0,0,1,86.1,347.543Z' class='ci-primary'/>"],Ve=["512 512","<rect width='288' height='32' x='112' y='152' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='288' height='32' x='112' y='240' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='152' height='32' x='112' y='328' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M480,48H32V464H480ZM448,432H64V80H448Z' class='ci-primary'/>"];const ne=i=>new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i),Nt=({visible:i,onClose:t,incomeData:a,onPaymentUpdated:T})=>{var R,te,A,le,p,U;const s=Ye(),[h,f]=x.useState([]),[d,m]=x.useState(!1),[l,u]=x.useState(""),[W,y]=x.useState({}),[P,w]=x.useState(!1),[z,L]=x.useState(null),Z=o=>{if(!o)return"N/A";try{return new Date(o).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})}catch{return"N/A"}};x.useEffect(()=>{i?i&&a&&$():(u(""),f([]),y({}))},[i,a]);const $=async()=>{if(a){m(!0),u("");try{const o=a.workOrderId||a.id,_=await he(`/api/proforma-invoices?work_order_id=${o}`);if(_&&_.success&&_.data){const Y=_.data.data||_.data;Array.isArray(Y)?f(Y):(f([]),u("Invalid data format received"))}else f([]),u("No proforma invoices found for this work order")}catch(o){console.error("Error fetching proforma invoices:",o),f([]),u("Failed to load proforma invoices")}finally{m(!1)}}},c=o=>{y(_=>({..._,[o]:!_[o]}))},r=o=>{var _;L({id:o.id,proforma_invoice_id:o.id,invoice_number:o.proforma_invoice_number,project_name:(_=o.project)==null?void 0:_.project_name,finalAmount:o.final_amount,paidAmount:o.paid_amount,isProformaInvoice:!0}),w(!0)},C=(o,_)=>{var Y;L({incomeId:o.id,originalIncomeId:o.id,proforma_invoice_id:_.id,id:_.id,received_amount:o.received_amount,received_by:o.received_by,payment_type:o.payment_type,senders_bank:o.senders_bank,receivers_bank:o.receivers_bank,remark:o.remark,payment_date:o.payment_date||o.invoice_date||o.created_at,invoice_number:_.proforma_invoice_number,project_name:(Y=_.project)==null?void 0:Y.project_name,finalAmount:_.final_amount,totalAmount:_.final_amount,paidAmount:o.received_amount,isProformaInvoice:!0,isEdit:!0}),w(!0)},M=o=>{s(`/edit-proforma-invoice/${o}`),t()},D=()=>{$(),T&&T(a.workOrderId||a.id),w(!1),L(null)},j=o=>{switch(o){case"paid":return"success";case"partial":return"warning";case"pending":return"danger";default:return"secondary"}},g=()=>{var re,ie,de,F;const o=((re=a.workOrder)==null?void 0:re.finalAmount)||((ie=a.workOrder)==null?void 0:ie.totalAmount)||0,_=((F=(de=a.workOrder)==null?void 0:de.project)==null?void 0:F.project_cost)||0,Y=h.reduce((q,G)=>q+parseFloat(G.final_amount||0),0),N=h.reduce((q,G)=>q+parseFloat(G.paid_amount||0),0),V=h.reduce((q,G)=>q+parseFloat(G.pending_amount||0),0),k=o-Y;return{workOrderTotal:o,projectValuation:_,totalBilled:Y,totalReceived:N,totalPending:V,remainingToBill:k,invoiceCount:h.length}};if(!a)return null;const I=g();return e.jsxs(e.Fragment,{children:[e.jsxs(ke,{visible:i,onClose:t,size:"xl",backdrop:"static",keyboard:!1,children:[e.jsx(Fe,{children:e.jsxs(Ae,{children:[e.jsx(O,{icon:we,className:"me-2"}),"Proforma Invoices - Work Order #",((R=a.workOrder)==null?void 0:R.invoice_number)||a.id]})}),e.jsxs(Pe,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-3",children:"Work Order Summary"}),e.jsxs(ue,{children:[e.jsxs(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:[e.jsx("small",{className:"text-muted d-block",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:((A=(te=a.workOrder)==null?void 0:te.project)==null?void 0:A.project_name)||"N/A"})})]}),e.jsxs(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:[e.jsx("small",{className:"text-muted d-block",children:"Work Order #:"}),e.jsx("div",{children:e.jsx("strong",{children:((le=a.workOrder)==null?void 0:le.invoice_number)||"N/A"})})]}),e.jsxs(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:[e.jsx("small",{className:"text-muted d-block",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:((U=(p=a.workOrder)==null?void 0:p.project)==null?void 0:U.customer_name)||"N/A"})})]}),e.jsxs(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:[e.jsx("small",{className:"text-muted d-block",children:"Total Proforma Invoices:"}),e.jsx("div",{children:e.jsx("strong",{children:I.invoiceCount})})]})]}),e.jsx("hr",{className:"my-3"}),e.jsxs(ue,{children:[e.jsx(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-info bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Project Valuation"}),e.jsxs("div",{className:"h6 text-info mb-0",children:["â‚¹",ne(I.projectValuation)]})]})}),e.jsx(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-secondary bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Work Order Total"}),e.jsxs("div",{className:"h6 text-secondary mb-0",children:["â‚¹",ne(I.workOrderTotal)]})]})}),e.jsx(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-primary bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Total Billed (PI)"}),e.jsxs("div",{className:"h6 text-primary mb-0",children:["â‚¹",ne(I.totalBilled)]})]})}),e.jsx(S,{lg:3,md:6,sm:6,xs:6,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-warning bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Remaining to Bill"}),e.jsxs("div",{className:"h6 text-warning mb-0",children:["â‚¹",ne(I.remainingToBill)]})]})})]}),e.jsx("hr",{className:"my-3"}),e.jsxs(ue,{children:[e.jsx(S,{lg:4,md:6,sm:6,xs:6,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-success bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Total Received"}),e.jsxs("div",{className:"h6 text-success mb-0",children:["â‚¹",ne(I.totalReceived)]})]})}),e.jsx(S,{lg:4,md:6,sm:6,xs:6,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-danger bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Total Pending"}),e.jsxs("div",{className:"h6 text-danger mb-0",children:["â‚¹",ne(I.totalPending)]})]})}),e.jsx(S,{lg:4,md:6,sm:12,xs:12,className:"mb-2",children:e.jsxs("div",{className:"text-center p-2 bg-primary bg-opacity-10 rounded",children:[e.jsx("small",{className:"text-muted d-block",children:"Payment Progress"}),e.jsxs("div",{className:"h6 text-primary mb-0",children:[I.totalBilled>0?(I.totalReceived/I.totalBilled*100).toFixed(1):0,"%"]})]})})]})]}),e.jsx("div",{className:"mb-3",children:e.jsx("h6",{children:"Proforma Invoices"})}),l&&e.jsx(ve,{color:"warning",dismissible:!0,onClose:()=>u(""),children:l}),d?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(oe,{}),e.jsx("div",{className:"mt-2",children:"Loading proforma invoices..."})]}):h.length>0?e.jsx("div",{style:{maxHeight:"500px",overflowY:"auto"},children:h.map((o,_)=>{var Y;return e.jsx("div",{className:"card mb-3 border",children:e.jsxs("div",{className:"card-body p-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"mb-1",children:e.jsxs("strong",{children:["Proforma Invoice: ",o.proforma_invoice_number]})}),o.tally_invoice_number&&e.jsxs("small",{className:"text-muted",children:["Tally #: ",o.tally_invoice_number]}),e.jsxs("div",{className:"small text-muted mt-1",children:[e.jsx(O,{icon:_e,className:"me-1"}),Z(o.invoice_date)]})]}),e.jsxs("div",{className:"d-flex gap-1 align-items-start flex-wrap",children:[e.jsx(Ce,{color:j(o.payment_status),children:(Y=o.payment_status)==null?void 0:Y.toUpperCase()}),e.jsx(b,{color:"info",size:"sm",onClick:()=>s(`/proforma-invoice-details/${o.id}`),title:"View Details",children:e.jsx(O,{icon:yt})}),e.jsx(b,{color:"warning",size:"sm",onClick:()=>M(o.id),title:"Edit Proforma Invoice",children:e.jsx(O,{icon:Ve})})]})]}),e.jsxs("div",{className:"row mb-2",children:[e.jsxs("div",{className:"col-4",children:[e.jsx("small",{className:"text-muted",children:"Final Amount"}),e.jsxs("div",{className:"fw-bold",children:["â‚¹",ne(o.final_amount)]})]}),e.jsxs("div",{className:"col-4",children:[e.jsx("small",{className:"text-muted",children:"Paid Amount"}),e.jsxs("div",{className:"text-success fw-bold",children:["â‚¹",ne(o.paid_amount)]})]}),e.jsxs("div",{className:"col-4",children:[e.jsx("small",{className:"text-muted",children:"Pending"}),e.jsxs("div",{className:"text-danger fw-bold",children:["â‚¹",ne(o.pending_amount)]})]})]}),o.incomes&&o.incomes.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs(b,{color:"link",size:"sm",onClick:()=>c(o.id),className:"p-0 text-decoration-none",children:[e.jsx(O,{icon:W[o.id]?bt:vt,className:"me-1"}),e.jsxs("small",{className:"fw-bold",children:["Payment History (",o.incomes.length," ",o.incomes.length===1?"payment":"payments",")"]})]}),e.jsx(ot,{visible:W[o.id],children:e.jsx("div",{className:"table-responsive mt-2",children:e.jsxs("table",{className:"table table-sm table-bordered mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Payment Date"}),e.jsx("th",{children:"Received Amount"}),e.jsx("th",{children:"Sent By"}),e.jsx("th",{children:"Payment Type"}),e.jsx("th",{children:"Transaction ID"}),e.jsx("th",{children:"Received Bank"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:o.incomes.map((N,V)=>{var k;return e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx(O,{icon:_e,className:"me-1 text-muted",size:"sm"}),Z(N.payment_date||N.invoice_date||N.created_at)]}),e.jsxs("td",{className:"text-success fw-bold",children:["â‚¹",ne(N.received_amount)]}),e.jsx("td",{children:N.received_by||"N/A"}),e.jsx("td",{children:e.jsx(Ce,{color:"primary",children:(k=N.payment_type)==null?void 0:k.toUpperCase()})}),e.jsx("td",{children:N.remark||"N/A"}),e.jsx("td",{children:N.receivers_bank||"N/A"}),e.jsx("td",{children:e.jsx(b,{color:"warning",size:"sm",onClick:()=>C(N,o),title:"Edit Payment",children:e.jsx(O,{icon:Be})})})]},V)})})]})})})]}),o.pending_amount>0&&e.jsx("div",{className:"mt-2",children:e.jsxs(b,{color:"success",size:"sm",onClick:()=>r(o),children:[e.jsx(O,{icon:rt,className:"me-1"}),"Record Payment"]})})]})},o.id)})}):e.jsx("div",{className:"text-center py-4",children:e.jsxs("div",{className:"text-muted",children:[e.jsx(O,{icon:we,size:"xl",className:"mb-3 opacity-50"}),e.jsx("h6",{children:"No Proforma Invoices Found"}),e.jsx("p",{children:"No proforma invoices have been created for this work order yet."})]})})]}),e.jsx(Te,{children:e.jsxs(b,{color:"secondary",onClick:t,children:[e.jsx(O,{icon:Ue,className:"me-1"}),"Close"]})})]}),P&&z&&e.jsx(at,{visible:P,onClose:()=>{w(!1),L(null)},orderData:z,onPaymentRecorded:D})]})},Ct=({visible:i,onClose:t,orderData:a,onUpdated:T})=>{const[s,h]=x.useState({}),[f,d]=x.useState(!1),[m,l]=x.useState([]);console.log(a),x.useEffect(()=>{(async()=>{try{const P=await he("/api/usersData");if(P.status&&P.users){const w=P.users.filter(z=>z.type===2);l(w)}}catch(P){console.error("Error fetching accountants:",P)}})()},[]),x.useEffect(()=>{a&&a.project&&h({customer_name:a.project.customer_name||"",mobile_number:a.project.mobile_number||"",project_name:a.project.project_name||"",project_cost:a.project.project_cost||"",work_place:a.project.work_place||"",start_date:a.project.start_date?a.project.start_date.split("T")[0]:"",end_date:a.project.end_date?a.project.end_date.split("T")[0]:"",is_confirm:!!a.project.is_confirm,is_visible:!!a.project.is_visible,remark:a.project.remark||"",supervisor_id:a.project.supervisor_id||"",commission:a.project.commission||"",gst_number:a.project.gst_number||"",pan_number:a.project.pan_number||""})},[a]);const u=y=>{const{name:P,value:w,type:z,checked:L}=y.target;h(Z=>({...Z,[P]:z==="checkbox"?L:w}))},W=async()=>{var y,P;d(!0);try{const w={...s,invoiceType:2},z=await tt(`/api/updateInvoiceStatus/${a.id}`,w);if(z.success)T(z.data),t();else throw new Error(z.message||"Update failed")}catch(w){console.error("Failed to update:",w),alert(((P=(y=w.response)==null?void 0:y.data)==null?void 0:P.message)||"Failed to update")}finally{d(!1)}};return!a||!a.project?null:e.jsxs(ke,{visible:i,onClose:t,size:"lg",backdrop:"static",keyboard:!0,scrollable:!0,children:[e.jsx(Fe,{closeButton:!0,children:e.jsxs(Ae,{children:["Update Project: ",a.project.project_name]})}),e.jsx(Pe,{className:"p-3 p-md-4",children:e.jsx(He,{children:e.jsxs(ue,{className:"g-3",children:[e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Customer Name"}),e.jsx(Q,{name:"customer_name",value:s.customer_name,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Mobile Number"}),e.jsx(Q,{type:"tel",name:"mobile_number",value:s.mobile_number,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Project Name"}),e.jsx(Q,{name:"project_name",value:s.project_name,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Project Cost"}),e.jsx(Q,{type:"number",name:"project_cost",value:s.project_cost,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Work Place"}),e.jsx(Q,{name:"work_place",value:s.work_place,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Start Date"}),e.jsx(Q,{type:"date",name:"start_date",value:s.start_date,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"End Date"}),e.jsx(Q,{type:"date",name:"end_date",value:s.end_date,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"GST Number"}),e.jsx(Q,{name:"gst_number",value:s.gst_number,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"PAN Number"}),e.jsx(Q,{name:"pan_number",value:s.pan_number,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Commission"}),e.jsx(Q,{type:"number",name:"commission",value:s.commission,onChange:u})]}),e.jsxs(S,{xs:12,sm:6,md:4,children:[e.jsx(H,{children:"Accountant"}),e.jsxs(it,{name:"supervisor_id",value:s.supervisor_id,onChange:u,children:[e.jsx("option",{value:"",children:"Select Accountant"}),m.map(y=>e.jsxs("option",{value:y.id,children:[y.name," (",y.mobile,")"]},y.id))]})]}),e.jsx(S,{xs:12,sm:6,md:4,className:"d-flex align-items-end pb-2",children:e.jsx(Se,{label:"Visible",name:"is_visible",checked:s.is_visible,onChange:u})}),e.jsxs(S,{xs:12,children:[e.jsx(H,{children:"Remark"}),e.jsx(ct,{name:"remark",rows:3,value:s.remark,onChange:u})]})]})})}),e.jsxs(Te,{className:"d-flex gap-2",children:[e.jsx(b,{color:"secondary",onClick:t,children:"Cancel"}),e.jsx(b,{color:"primary",onClick:W,disabled:f,children:f?"Saving...":"Save Changes & Convert"})]})]})},wt=({visible:i,onClose:t,onDownload:a,isAllProjects:T=!1})=>{const[s,h]=x.useState(""),[f,d]=x.useState(""),[m,l]=x.useState(""),u=()=>{if(!s||!f){l("Please select both start and end dates");return}if(new Date(s)>new Date(f)){l("Start date cannot be after end date");return}l(""),a(s,f),W()},W=()=>{h(""),d(""),l(""),t()},y=c=>{const r=new Date,C=new Date;C.setDate(C.getDate()-c),h(C.toISOString().split("T")[0]),d(r.toISOString().split("T")[0]),l("")},P=()=>{const c=new Date,r=new Date(c.getFullYear(),c.getMonth(),1),C=new Date(c.getFullYear(),c.getMonth()+1,0);h(r.toISOString().split("T")[0]),d(C.toISOString().split("T")[0]),l("")},w=()=>{const c=new Date,r=new Date(c.getFullYear(),c.getMonth()-1,1),C=new Date(c.getFullYear(),c.getMonth(),0);h(r.toISOString().split("T")[0]),d(C.toISOString().split("T")[0]),l("")},z=()=>{const c=new Date,r=new Date(c.getFullYear(),0,1),C=new Date(c.getFullYear(),11,31);h(r.toISOString().split("T")[0]),d(C.toISOString().split("T")[0]),l("")},L=()=>{const c=new Date,r=new Date(c.getFullYear()-1,0,1),C=new Date(c.getFullYear()-1,11,31);h(r.toISOString().split("T")[0]),d(C.toISOString().split("T")[0]),l("")},Z=()=>{const c=new Date,r=Math.floor(c.getMonth()/3),C=new Date(c.getFullYear(),r*3,1),M=new Date(c.getFullYear(),r*3+3,0);h(C.toISOString().split("T")[0]),d(M.toISOString().split("T")[0]),l("")},$=()=>{const c=new Date,r=new Date;r.setFullYear(r.getFullYear()-5),h(r.toISOString().split("T")[0]),d(c.toISOString().split("T")[0]),l("")};return e.jsxs(ke,{visible:i,onClose:W,backdrop:"static",size:"lg",children:[e.jsx(Fe,{children:e.jsxs(Ae,{children:[e.jsx(O,{icon:_e,className:"me-2"}),"Select Date Range for Income Report"]})}),e.jsxs(Pe,{children:[m&&e.jsx(ve,{color:"danger",dismissible:!0,onClose:()=>l(""),children:m}),T&&e.jsxs(ve,{color:"info",className:"mb-3",children:[e.jsx("strong",{children:"ðŸ“Š Income Report for All Projects"}),e.jsx("p",{className:"mb-0 mt-1 small",children:"This report will include income/payment records from all projects within the selected date range."})]}),e.jsxs(He,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h6",{className:"mb-3",children:"ðŸ“… Custom Date Range"}),e.jsxs(ue,{children:[e.jsxs(S,{md:6,className:"mb-3 mb-md-0",children:[e.jsxs(H,{htmlFor:"startDate",className:"fw-bold",children:["Start Date ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(Q,{type:"date",id:"startDate",value:s,onChange:c=>{h(c.target.value),l("")},max:f||void 0})]}),e.jsxs(S,{md:6,children:[e.jsxs(H,{htmlFor:"endDate",className:"fw-bold",children:["End Date ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(Q,{type:"date",id:"endDate",value:f,onChange:c=>{d(c.target.value),l("")},min:s||void 0})]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"mb-3",children:"âš¡ Quick Select:"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("small",{className:"text-muted d-block mb-2 fw-bold",children:"Days:"}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(b,{size:"sm",color:"secondary",variant:"outline",onClick:()=>y(7),children:"Last 7 Days"}),e.jsx(b,{size:"sm",color:"secondary",variant:"outline",onClick:()=>y(15),children:"Last 15 Days"}),e.jsx(b,{size:"sm",color:"secondary",variant:"outline",onClick:()=>y(30),children:"Last 30 Days"}),e.jsx(b,{size:"sm",color:"secondary",variant:"outline",onClick:()=>y(90),children:"Last 90 Days"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("small",{className:"text-muted d-block mb-2 fw-bold",children:"Months:"}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(b,{size:"sm",color:"info",variant:"outline",onClick:P,children:"Current Month"}),e.jsx(b,{size:"sm",color:"info",variant:"outline",onClick:w,children:"Last Month"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("small",{className:"text-muted d-block mb-2 fw-bold",children:"Quarters & Years:"}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(b,{size:"sm",color:"warning",variant:"outline",onClick:Z,children:"Current Quarter"}),e.jsx(b,{size:"sm",color:"warning",variant:"outline",onClick:z,children:"Current Year"}),e.jsx(b,{size:"sm",color:"warning",variant:"outline",onClick:L,children:"Last Year"})]})]}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block mb-2 fw-bold",children:"All Time:"}),e.jsx("div",{className:"d-flex flex-wrap gap-2",children:e.jsx(b,{size:"sm",color:"dark",variant:"outline",onClick:$,children:"All Time (Last 5 Years)"})})]})]}),s&&f&&e.jsxs("div",{className:"alert alert-success mb-0",children:[e.jsx("strong",{children:"âœ“ Selected Range:"})," ",new Date(s).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})," to ",new Date(f).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})]})]})]}),e.jsxs(Te,{children:[e.jsxs(b,{color:"secondary",onClick:W,children:[e.jsx(O,{icon:Ue,className:"me-1"}),"Cancel"]}),e.jsxs(b,{color:"success",onClick:u,disabled:!s||!f,children:[e.jsx(O,{icon:Ze,className:"me-1"}),"Download Income Report"]})]})]})},_t=i=>{const t=parseFloat(i)||0;return new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t)},ce=i=>{const t=parseFloat(i)||0;return _t(t)},me=i=>i?new Date(i).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}):"N/A",St=async i=>{try{const t=await fetch(i);if(!t.ok)return console.error("Image not found:",i),null;const a=await t.blob();return await new Promise(T=>{const s=new FileReader;s.onloadend=()=>T(s.result),s.readAsDataURL(a)})}catch(t){return console.error("Logo conversion failed:",t),null}},kt=async i=>{try{const t=await he(`/api/proforma-invoices?work_order_id=${i}`);if(t&&t.success&&t.data){const a=t.data.data||t.data;return Array.isArray(a)?a:[]}return[]}catch(t){return console.error("Error fetching proforma invoices:",t),[]}},Ft=async i=>{var y,P,w,z,L,Z;if(!i||i.length===0)throw new Error("No work orders selected");const t=new Ge("p","mm","a4"),a=t.internal.pageSize.getWidth(),T=t.internal.pageSize.getHeight(),s=10,h=a-2*s,f=st();console.log(f);const d=f.company_info||{},m={name:d.company_name||"NA",address:d.land_mark||"NA",phone:d.phone_no||"NA",email:d.email_id||"NA",website:d.website||"NA",logo:d.logo||"NA",gstin:d.gst_number||"NA"};console.log(m.logo);let l=null,u=null;m.logo&&m.logo!=="NA"&&(m.logo.startsWith("invoice/")?l=`http://localhost:8000/img/${m.logo}`:m.logo.startsWith("http")?l=m.logo:l=`http://localhost:8000/${m.logo}`,console.log("Final resolved logo URL:",l),u=await St(l));for(let $=0;$<i.length;$++){const c=i[$];$>0&&t.addPage(),t.setDrawColor(0,0,0),t.setLineWidth(1),t.rect(s,s,h,T-2*s);let r=s+8;if(t.setFont("helvetica","bold"),t.setFontSize(18),t.setTextColor(0,0,0),t.text(m.name,s+5,r),u)try{t.addImage(u,"PNG",a-s-25,s+3,20,20)}catch(G){console.warn("LOGO FAILED:",G)}else console.warn("Logo not loaded.");r+=6,t.setFont("helvetica","normal"),t.setFontSize(9),t.text(m.address,s+5,r),r+=4,t.text(`Phone: ${m.phone}`,s+5,r),r+=6,t.setLineWidth(.5),t.setDrawColor(0,0,0),t.line(s+3,r,a-s-3,r),r+=6,t.setDrawColor(0,0,0),t.setLineWidth(.5),t.setFillColor(173,216,230),t.rect(s+3,r,h-6,12,"FD"),t.setFont("helvetica","bold"),t.setFontSize(14),t.setTextColor(0,0,0),t.text("Work Order Details Report",a/2,r+5.5,{align:"center"}),t.setFont("helvetica","normal"),t.setFontSize(8),t.text(`Generated on: ${me(new Date)} | Total Work Orders: ${i.length}`,a/2,r+9.5,{align:"center"}),r+=15;const C=(h-14)/3,M=s+7,D=M+C+3,j=D+C+3,g=r,I=48;t.setLineWidth(.3),t.setDrawColor(100,100,100),t.rect(s+3,g,h-6,I),t.line(D-1.5,g,D-1.5,g+I),t.line(j-1.5,g,j-1.5,g+I),t.line(s+3,g+8,a-s-3,g+8),t.setFillColor(173,216,230),t.rect(s+3,g,D-1.5-(s+3),8,"F"),t.rect(D-1.5,g,j-1.5-(D-1.5),8,"F"),t.rect(j-1.5,g,a-s-3-(j-1.5),8,"F"),t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(0,0,0),t.text("FROM :",M,g+5.5),t.text("TO :",D,g+5.5),t.text("DETAILS :",j,g+5.5);let R=g+12;t.setFont("helvetica","bold"),t.setFontSize(8.5),t.text(m.name,M,R),R+=4,t.setFont("helvetica","normal"),t.setFontSize(7.5),t.text("Tata",M,R),R+=3.5;const te=t.splitTextToSize(m.address,C-4);t.text(te,M,R),R+=te.length*3.2,t.text(`Phone: ${m.phone}`,M,R),R+=3.2,t.text(`Email: ${m.email}`,M,R),R+=3.2,t.text(`GSTIN: ${m.gstin}`,M,R),R+=3.2,t.text("UId: Retail",M,R);let A=g+12;t.setFont("helvetica","bold"),t.setFontSize(8);const le=((y=c.project)==null?void 0:y.project_name)||"N/A",p=t.splitTextToSize(`Project Name: ${le}`,C-4);t.text(p,D,A),A+=p.length*3.5,t.setFont("helvetica","normal"),t.setFontSize(7.5);const U=((P=c.project)==null?void 0:P.customer_name)||"N/A",o=t.splitTextToSize(`Customer: ${U}`,C-4);t.text(o,D,A),A+=o.length*3.2;const _=((w=c.project)==null?void 0:w.work_place)||"N/A",Y=t.splitTextToSize(`Site: ${_}`,C-4);t.text(Y,D,A),A+=Y.length*3.2,t.text(`Phone: ${((z=c.project)==null?void 0:z.mobile_number)||"N/A"}`,D,A),A+=3.2,t.text(`Start Date: ${me((L=c.project)==null?void 0:L.start_date)}`,D,A),A+=3.2,t.text(`End Date: ${me((Z=c.project)==null?void 0:Z.end_date)}`,D,A),A+=3.2,t.text("GSTIN: N/A",D,A),A+=3.2,t.text("PAN: -",D,A);let N=g+12;t.setFont("helvetica","normal"),t.setFontSize(7.5),t.text(`Invoice No: ${c.invoice_number||"N/A"}`,j,N),N+=3.2,t.text(`Invoice Date: ${me(c.invoiceDate)}`,j,N),N+=3.2,t.text(`Work Order ID: D-${c.id||"N/A"}`,j,N),N+=3.2;const V=await kt(c.id);if(V.length>0){const G=V.map(ge=>ge.proforma_invoice_number).join(", "),B=t.splitTextToSize(`PI Numbers: ${G}`,C-4);t.text(B,j,N),N+=B.length*3.2}else t.text("PI Numbers: N/A",j,N),N+=3.2;r=g+I+6,t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0);const k=s+3;t.text("Work Order Information:",k+4,r),r+=6;const re=c.finalAmount||c.totalAmount||0,ie=c.paidAmount||0,de=re-ie,F=h-6;if(t.autoTable({startY:r,head:[["Status","Total Amount","Paid Amount","Pending Amount"]],body:[[c.invoiceType===2?"Work Order":"Quotation",ce(re),ce(ie),ce(de)]],theme:"grid",headStyles:{fillColor:[173,216,230],textColor:0,fontStyle:"bold",fontSize:9,halign:"center",lineWidth:.3,lineColor:[100,100,100]},bodyStyles:{fontSize:9,halign:"center",lineWidth:.3,lineColor:[100,100,100],cellPadding:4},columnStyles:{0:{cellWidth:F/4,halign:"center"},1:{cellWidth:F/4,halign:"right"},2:{cellWidth:F/4,halign:"right"},3:{cellWidth:F/4,halign:"right"}},margin:{left:k,right:s+3},tableWidth:F}),r=t.lastAutoTable.finalY+8,V.length>0){t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("Proforma Invoice Details:",k+4,r),r+=6;const G=V.map(B=>[B.proforma_invoice_number||"N/A",me(B.invoice_date),ce(B.final_amount||0),ce(B.paid_amount||0),ce(B.pending_amount||0),(B.payment_status||"Pending").toUpperCase()]);t.autoTable({startY:r,head:[["PI Number","Invoice Date","Final Amount","Paid Amount","Pending Amount","Payment Status"]],body:G,theme:"grid",headStyles:{fillColor:[173,216,230],textColor:0,fontStyle:"bold",fontSize:9,halign:"center",lineWidth:.3,lineColor:[100,100,100]},bodyStyles:{fontSize:9,lineWidth:.3,lineColor:[100,100,100],cellPadding:4},columnStyles:{0:{cellWidth:F/6,halign:"center"},1:{cellWidth:F/6,halign:"center"},2:{cellWidth:F/6,halign:"right"},3:{cellWidth:F/6,halign:"right"},4:{cellWidth:F/6,halign:"right"},5:{cellWidth:F/6,halign:"center"}},margin:{left:k,right:s+3},tableWidth:F}),r=t.lastAutoTable.finalY+8,V.forEach((B,ge)=>{if(B.incomes&&B.incomes.length>0){r>T-70&&(t.addPage(),t.setDrawColor(0,0,0),t.setLineWidth(1),t.rect(s,s,h,T-2*s),r=s+15),t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(0,0,0),t.text(`Payment History - ${B.proforma_invoice_number}:`,k+4,r),r+=6;const be=B.incomes.map(ae=>[me(ae.invoice_date),ce(ae.received_amount||0),(ae.payment_type||"N/A").toUpperCase(),ae.received_by||"N/A",ae.senders_bank||"-",ae.receivers_bank||"-",ae.remark||"-"]);t.autoTable({startY:r,head:[["Date","Amount","Payment Type","Received By","From Bank","To Bank","Remark"]],body:be,theme:"grid",headStyles:{fillColor:[46,204,113],textColor:255,fontSize:8,halign:"center",lineWidth:.3,lineColor:[100,100,100]},bodyStyles:{fontSize:8,lineWidth:.3,lineColor:[100,100,100],cellPadding:3},columnStyles:{0:{cellWidth:F/7,halign:"center"},1:{cellWidth:F/7,halign:"right"},2:{cellWidth:F/7,halign:"center"},3:{cellWidth:F/7,halign:"center"},4:{cellWidth:F/7,halign:"center"},5:{cellWidth:F/7,halign:"center"},6:{cellWidth:F/7,halign:"center"}},margin:{left:k,right:s+3},tableWidth:F}),r=t.lastAutoTable.finalY+8}})}else t.setFont("helvetica","italic"),t.setFontSize(9),t.setTextColor(80,80,80),t.text("No proforma invoices found for this work order.",k+4,r);const q=T-s-10;t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(0,0,0),t.setLineWidth(.3),t.setDrawColor(150,150,150),t.line(s+5,q,a-s-5,q),t.setFontSize(7),t.setFont("helvetica","italic"),t.text("This is a computer generated work order.",a/2,q+4,{align:"center"}),t.setFontSize(8)}const W=new Date().toISOString().slice(0,10);t.save(`WorkOrders_Report_${W}.pdf`)},At=i=>new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i),X=i=>`Rs ${At(i)}`,ee=i=>i?new Date(i).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}):"N/A",Pt=async(i,t)=>{try{const a=new URLSearchParams;a.append("per_page","1000");const T=await he(`/api/income?${a.toString()}`);let s=[];if(T&&T.incomes&&T.incomes.data&&(s=T.incomes.data),i&&t){const m=new Date(i),l=new Date(t);s=s.filter(u=>{const W=u.payment_date||u.invoice_date||u.created_at;if(!W)return!1;const y=new Date(W);return y>=m&&y<=l})}const h=s.reduce((m,l)=>m+parseFloat(l.billing_amount||0),0),f=s.reduce((m,l)=>m+parseFloat(l.received_amount||0),0),d=h-f;return{incomes:s,summary:{total_amount:h,received_amount:f,pending_amount:d}}}catch(a){throw console.error("Error fetching income data:",a),new Error("Failed to fetch income data from server")}},Tt=async(i,t)=>{if(!i||!t)throw new Error("Please select date range");const{incomes:a,summary:T}=await Pt(i,t);if(!a||a.length===0)throw new Error("No income records found for the selected date range");const s=new Ge("l","mm","a4"),h=s.internal.pageSize.getWidth(),f=s.internal.pageSize.getHeight(),d=10,m=h-2*d;let l=15;s.setFontSize(20),s.setFont("helvetica","bold"),s.setTextColor(41,128,185),s.text("INCOME REPORT",h/2,l,{align:"center"}),l+=7,s.setFontSize(10),s.setFont("helvetica","normal"),s.setTextColor(0,0,0),s.text(`Period: ${ee(i)} to ${ee(t)}`,h/2,l,{align:"center"}),l+=5,s.setFontSize(8),s.setTextColor(100,100,100),s.text(`Generated on: ${ee(new Date)}`,h/2,l,{align:"center"}),s.text("(Based on Payment Date)",h/2,l+3,{align:"center"}),l+=10;const u=a.reduce((j,g)=>j+parseFloat(g.billing_amount||0),0),W=a.reduce((j,g)=>j+parseFloat(g.received_amount||0),0),y=u-W,P=a.length;s.setFillColor(240,248,255),s.setDrawColor(41,128,185),s.setLineWidth(.3),s.rect(d,l,m,18,"FD"),l+=5,s.setFontSize(10),s.setFont("helvetica","bold"),s.setTextColor(41,128,185),s.text("SUMMARY",d+3,l),l+=6,s.setFontSize(9),s.setFont("helvetica","normal"),s.setTextColor(0,0,0);const w=d+3,z=d+75,L=d+145,Z=d+215;s.text(`Total Records: ${P}`,w,l),s.text(`Total Billed: ${X(u)}`,z,l),s.setTextColor(22,160,133),s.setFont("helvetica","bold"),s.text(`Received: ${X(W)}`,L,l),s.setTextColor(231,76,60),s.text(`Pending: ${X(y)}`,Z,l),s.setTextColor(0,0,0),s.setFont("helvetica","normal"),l+=18;const $={};a.forEach(j=>{const g=j.project_id||"unassigned",I=j.project_name||"Unassigned Project";$[g]||($[g]={id:g,name:I,incomes:[]}),$[g].incomes.push(j)});const c=Object.values($);for(let j=0;j<c.length;j++){const g=c[j];l>f-60&&(s.addPage(),l=15),s.setFillColor(52,152,219),s.setDrawColor(41,128,185),s.setLineWidth(.2),s.rect(d,l,m,8,"FD"),s.setTextColor(255,255,255),s.setFontSize(10),s.setFont("helvetica","bold"),s.text(`Project: ${g.name}`,d+2,l+5.5),l+=10,s.setTextColor(0,0,0);const I=g.incomes.map((p,U)=>{const o=p.payment_date||p.invoice_date||p.created_at;return[p.id||"N/A",p.project_name||"N/A",p.po_no||"N/A",ee(p.po_date),p.invoice_no||"N/A",ee(p.invoice_date),ee(o),X(parseFloat(p.basic_amount||0)),X(parseFloat(p.gst_amount||0)),X(parseFloat(p.billing_amount||0)),X(parseFloat(p.received_amount||0)),p.received_by||"N/A",(p.payment_type||"N/A").toUpperCase(),p.remark||"N/A",p.receivers_bank||"N/A"]}),R=g.incomes.reduce((p,U)=>p+parseFloat(U.basic_amount||0),0),te=g.incomes.reduce((p,U)=>p+parseFloat(U.gst_amount||0),0),A=g.incomes.reduce((p,U)=>p+parseFloat(U.billing_amount||0),0),le=g.incomes.reduce((p,U)=>p+parseFloat(U.received_amount||0),0);s.autoTable({startY:l,head:[["ID","Project Name","PO No","PO Date","Invoice No","Invoice Date","Payment Date","Amount Before GST","GST Amount","Amount With GST","Received Amount","Received By","Payment Type","Transaction ID","Received Bank"]],body:I,foot:[["","","","","","","Total:",X(R),X(te),X(A),X(le),"","","",""]],theme:"striped",styles:{fontSize:6,cellPadding:1.5,overflow:"linebreak",halign:"right",valign:"middle",lineColor:[200,200,200],lineWidth:.1},headStyles:{fillColor:[46,204,113],textColor:255,fontStyle:"bold",halign:"center",fontSize:6},footStyles:{fillColor:[236,240,241],textColor:[52,73,94],fontStyle:"bold",halign:"right",fontSize:7},columnStyles:{0:{cellWidth:10,halign:"center"},1:{cellWidth:20},2:{cellWidth:15},3:{cellWidth:16},4:{cellWidth:18},5:{cellWidth:16},6:{cellWidth:16,halign:"center"},7:{cellWidth:20,halign:"right"},8:{cellWidth:18,halign:"right"},9:{cellWidth:20,halign:"right"},10:{cellWidth:20,halign:"right"},11:{cellWidth:18},12:{cellWidth:16,halign:"center"},13:{cellWidth:18},14:{cellWidth:20}},margin:{left:d,right:d},didDrawPage:function(p){s.setFontSize(7),s.setTextColor(128,128,128),s.text(`Page ${s.internal.getCurrentPageInfo().pageNumber}`,h-d-15,f-5)}}),l=s.lastAutoTable.finalY+6,j<c.length-1&&(l>f-40?(s.addPage(),l=15):(s.setDrawColor(200,200,200),s.setLineWidth(.3),s.line(d,l,h-d,l),l+=8))}l>f-30?(s.addPage(),l=15):l+=5,s.setFillColor(41,128,185),s.setDrawColor(52,73,94),s.setLineWidth(.5),s.rect(d,l,m,12,"FD"),s.setTextColor(255,255,255),s.setFontSize(11),s.setFont("helvetica","bold"),s.text("GRAND TOTAL RECEIVED AMOUNT:",d+3,l+8),s.setFontSize(12),s.text(X(W),h-d-3,l+8,{align:"right"}),s.setTextColor(0,0,0);const r=s.internal.getNumberOfPages();for(let j=1;j<=r;j++)s.setPage(j),s.setFontSize(7),s.setFont("helvetica","normal"),s.setTextColor(128,128,128),s.text(`Income Report | Period: ${ee(i)} to ${ee(t)} | Generated: ${ee(new Date)}`,h/2,f-5,{align:"center"});new Date().toISOString().split("T")[0];const C=ee(i).replace(/\s/g,"_"),M=ee(t).replace(/\s/g,"_"),D=`Income_Report_${C}_to_${M}.pdf`;s.save(D)},cs=()=>{const[i,t]=x.useState([]),[a,T]=x.useState(!0),[s,h]=x.useState({}),[f,d]=x.useState({show:!1,message:"",type:"success"}),[m,l]=x.useState([]),[u,W]=x.useState(!1),[y,P]=x.useState(!1),[w,z]=x.useState(!1),[L,Z]=x.useState(!0),[$,c]=x.useState(null),r=x.useRef(null),[C,M]=x.useState(!1),[D,j]=x.useState(!1),[g,I]=x.useState(null),[R,te]=x.useState(null),A=Ye(),[le,p]=x.useState(!1),[U,o]=x.useState(null),_=n=>{o(n),p(!0)},Y=n=>{switch(n){case 1:return{text:"Quotation",color:"secondary",nextAction:"Convert to Work Order"};case 2:return{text:"Work Order",color:"success",nextAction:null};case 0:return{text:"Cancelled",color:"danger",nextAction:null};default:return{text:"Unknown",color:"light",nextAction:null}}},N=async(n=null,v=!1)=>{try{v?z(!0):T(!0);const E=n?`/api/getAllData?cursor=${n}&perPage=25`:"/api/getAllData?perPage=25",J=await he(E);t(v?xe=>[...xe,...J.data||[]]:J.data||[]),c(J.next_cursor),Z(J.has_more_pages)}catch(E){console.error("Error fetching orders:",E),k("Failed to fetch orders","danger")}finally{T(!1),z(!1)}};x.useEffect(()=>{N()},[]);const V=x.useCallback(()=>{!w&&!a&&L&&$&&N($,!0)},[w,a,L,$]);x.useEffect(()=>{const n=new IntersectionObserver(E=>{E[0].isIntersecting&&L&&!w&&!a&&V()},{threshold:.1,rootMargin:"100px"}),v=r.current;return v&&n.observe(v),()=>{v&&n.unobserve(v)}},[L,w,a,V]);const k=(n,v="success")=>{d({show:!0,message:n,type:v}),setTimeout(()=>d({show:!1,message:"",type:"success"}),5e3)},re=n=>{if(n.target.checked){const v=i.filter(E=>E.invoiceType===2);l(v)}else l([])},ie=n=>{l(v=>v.some(J=>J.id===n.id)?v.filter(J=>J.id!==n.id):[...v,n])},de=n=>m.some(v=>v.id===n),F=async()=>{if(m.length===0){k("Please select at least one work order to download","warning");return}W(!0);try{await Ft(m),k(`PDF generated successfully for ${m.length} work order(s)`,"success"),l([])}catch(n){console.error("Error generating PDF:",n),k("Failed to generate PDF. Please try again.","danger")}finally{W(!1)}},q=()=>{j(!0)},G=async(n,v)=>{P(!0),j(!1);try{await Tt(n,v),k("Income report generated successfully for all projects","success")}catch(E){console.error("Error generating income report:",E),k(E.message||"Failed to generate income report. Please try again.","danger")}finally{P(!1)}},B=n=>{A("/create-proforma-invoice",{state:{workOrderId:n.id,workOrderData:n}})},ge=async n=>{try{h(E=>({...E,[`log_${n.id}`]:!0}));const v=await he(`/api/proforma-invoices?work_order_id=${n.id}`);I(n),te({workOrderId:n.id,workOrder:n,proformaInvoices:v.data||[]}),M(!0)}catch(v){console.error("Error fetching proforma invoices:",v),k(`Failed to open payment log for order ${n.id}`,"danger")}finally{h(v=>({...v,[`log_${n.id}`]:!1}))}},be=(n,v)=>{k("Payment updated successfully!","success"),N()},ae=n=>A(`/invoice-details/${n}`),Xe=n=>A(`/edit-order/${n}`),ye=i.filter(n=>n.invoiceType===2).length,Qe=ye>0&&m.length===ye,[qe,pe]=x.useState(!1),[je,Je]=x.useState(null),[De,Ie]=x.useState(!1),Ke=n=>{Je(n),pe(!0)},et=async n=>{try{Ie(!0);const v=await nt(`/api/ClearAllOrderDetailsById/${n}`);v.status?(k("Order deleted successfully","success"),N()):k(v.msg||"Failed to delete order","danger")}catch(v){console.error("Delete Error:",v),k("Error deleting order","danger")}finally{Ie(!1),pe(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(dt,{children:[e.jsx(ht,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("h5",{className:"mb-0",children:"Invoice Management"}),e.jsxs("div",{className:"text-muted small",children:[i.length," invoice",i.length!==1?"s":""," loaded",L&&" (scroll for more)"]})]})}),e.jsxs(mt,{children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2",children:[e.jsx("div",{children:m.length>0&&e.jsxs("span",{className:"text-muted small",children:[m.length," work order(s) selected"]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(b,{color:"primary",onClick:F,disabled:m.length===0||u,className:"d-flex align-items-center",size:"sm",children:u?e.jsxs(e.Fragment,{children:[e.jsx(oe,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{icon:Ze,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Work Order PDF"}),e.jsx("span",{className:"d-inline d-sm-none",children:"WO"}),m.length>0&&` (${m.length})`]})}),e.jsx(b,{color:"success",onClick:q,disabled:y,className:"d-flex align-items-center",size:"sm",children:y?e.jsxs(e.Fragment,{children:[e.jsx(oe,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{icon:lt,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Income Report"}),e.jsx("span",{className:"d-inline d-sm-none",children:"Income"})]})})]})]})}),f.show&&e.jsx(ve,{color:f.type,dismissible:!0,onClose:()=>d({show:!1,message:"",type:"success"}),children:f.message}),a?e.jsx("div",{className:"text-center my-3",children:e.jsx(oe,{color:"primary"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs(xt,{bordered:!0,hover:!0,children:[e.jsx(ut,{color:"dark",children:e.jsxs(Ne,{children:[e.jsx(se,{style:{width:"50px"},children:e.jsx(Se,{checked:Qe,onChange:re,disabled:ye===0,title:"Select all work orders"})}),e.jsx(se,{className:"d-none d-md-table-cell",children:"Sr.No."}),e.jsx(se,{children:"Invoice Number"}),e.jsx(se,{className:"d-none d-lg-table-cell",children:"Project Name"}),e.jsx(se,{className:"d-none d-xl-table-cell",children:"Customer Name"}),e.jsx(se,{className:"d-none d-lg-table-cell",children:"Date"}),e.jsx(se,{className:"d-none d-md-table-cell",children:"Total (Rs)"}),e.jsx(se,{className:"d-none d-md-table-cell",children:"Paid (Rs)"}),e.jsx(se,{children:"Status"}),e.jsx(se,{children:"Actions"})]})}),e.jsx(gt,{children:i.length>0?i.map((n,v)=>{var We,ze,Le,Re,$e,Me,Ee;const E=Y(n.invoiceType),J=n.finalAmount||n.totalAmount||0,xe=n.paidAmount||0,Oe=J-xe,fe=n.invoiceType===2;return e.jsxs(Ne,{children:[e.jsx(K,{children:fe?e.jsx(Se,{checked:de(n.id),onChange:()=>ie(n)}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx(K,{className:"d-none d-md-table-cell",children:v+1}),e.jsxs(K,{children:[e.jsx("strong",{children:n.invoice_number||`ORD-${n.id}`}),e.jsxs("div",{className:"d-lg-none",children:[e.jsx("small",{className:"text-muted d-block",children:((We=n.project)==null?void 0:We.project_name)||"N/A"}),e.jsx("small",{className:"text-muted d-xl-none",children:((ze=n.project)==null?void 0:ze.customer_name)||"N/A"})]})]}),e.jsxs(K,{className:"d-none d-lg-table-cell",children:[((Le=n.project)==null?void 0:Le.project_name)||"N/A",((Re=n.project)==null?void 0:Re.work_place)&&e.jsxs("div",{className:"text-muted small",children:["ðŸ“ ",n.project.work_place]})]}),e.jsxs(K,{className:"d-none d-xl-table-cell",children:[(($e=n.project)==null?void 0:$e.customer_name)||((Me=n.customer)==null?void 0:Me.name)||"N/A",((Ee=n.project)==null?void 0:Ee.mobile_number)&&e.jsxs("div",{className:"text-muted small",children:["ðŸ“ž ",n.project.mobile_number]})]}),e.jsx(K,{className:"d-none d-lg-table-cell",children:n.invoiceDate?new Date(n.invoiceDate).toLocaleDateString():"N/A"}),e.jsx(K,{className:"d-none d-md-table-cell",children:e.jsxs("strong",{children:["Rs ",J.toLocaleString()]})}),e.jsx(K,{className:"d-none d-md-table-cell",children:e.jsxs("span",{className:xe>0?"text-success":"text-muted",children:["Rs ",xe.toLocaleString()]})}),e.jsxs(K,{children:[e.jsx(Ce,{color:E.color,className:"mb-1",children:E.text}),Oe>0&&fe&&e.jsx("div",{className:"text-danger small",children:e.jsxs("strong",{children:["Rs ",Oe.toLocaleString()]})})]}),e.jsx(K,{children:e.jsxs("div",{className:"d-flex gap-1 flex-wrap",children:[e.jsx(b,{color:"info",size:"sm",onClick:()=>ae(n.id),title:"View Details",children:e.jsx(O,{icon:jt})}),e.jsx(b,{color:"success",size:"sm",onClick:()=>Xe(n.id),title:"Edit Invoice",children:e.jsx(O,{icon:Be})}),E.nextAction&&n.invoiceType===1&&e.jsx(b,{color:"warning",size:"sm",onClick:()=>_(n),disabled:s[`progress_${n.id}`],title:E.nextAction,children:s[`progress_${n.id}`]?e.jsx(oe,{size:"sm"}):e.jsx(O,{icon:ft})}),fe&&e.jsx(b,{color:"primary",size:"sm",onClick:()=>B(n),title:"Create Proforma Invoice",children:e.jsx(O,{icon:Ve})}),fe&&e.jsx(b,{color:"secondary",size:"sm",onClick:()=>ge(n),disabled:s[`log_${n.id}`],title:"View Proforma Invoices & Payments",children:s[`log_${n.id}`]?e.jsx(oe,{size:"sm"}):e.jsx(O,{icon:we})}),e.jsx(b,{color:"danger",size:"sm",onClick:()=>Ke(n),title:"Delete Order",children:e.jsx(O,{icon:pt})})]})})]},n.id)}):e.jsx(Ne,{children:e.jsx(K,{colSpan:10,className:"text-center py-4",children:e.jsxs("div",{className:"text-muted",children:[e.jsx("h6",{children:"No invoices found"}),e.jsx("p",{children:"Create your first invoice to get started"})]})})})})]})}),e.jsxs("div",{ref:r,style:{height:"20px",margin:"20px 0"},children:[w&&e.jsxs("div",{className:"text-center",children:[e.jsx(oe,{color:"primary",size:"sm"}),e.jsx("span",{className:"ms-2 text-muted small",children:"Loading more invoices..."})]}),!L&&i.length>0&&e.jsxs("div",{className:"text-center text-muted small",children:[e.jsx("hr",{}),e.jsxs("p",{children:["All invoices loaded (",i.length," total)"]})]})]})]})]})]}),e.jsx(Nt,{visible:C,onClose:()=>{M(!1),te(null)},incomeData:R,onPaymentUpdated:be}),e.jsx(wt,{visible:D,onClose:()=>j(!1),onDownload:G,isAllProjects:!0}),e.jsx(Ct,{visible:le,onClose:()=>{p(!1),o(null)},orderData:U,onUpdated:()=>{k("Status & project updated successfully","success"),N()}}),qe&&je&&e.jsx("div",{className:"modal fade show",style:{display:"block",background:"rgba(0,0,0,0.5)"},children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:["Delete order - ",je.invoice_number||`ORD-${je.id}`,"?"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>pe(!1)})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("p",{children:["Do you really want to ",e.jsx("span",{className:"text-danger fw-bold",children:"Delete"})," this transaction?"]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx(b,{color:"secondary",onClick:()=>pe(!1),children:"Close"}),e.jsx(b,{color:"danger",onClick:()=>et(je.id),disabled:De,children:De?e.jsx(oe,{size:"sm"}):"Yes"})]})]})})})]})};export{cs as default};

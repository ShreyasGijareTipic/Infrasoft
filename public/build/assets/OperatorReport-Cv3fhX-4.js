import{r as o,j as e,C as se}from"./index-BjGmA7Bo.js";import{a as te,p as fe}from"./api-CIBCEetx.js";import{a as ge,b as f,c as O}from"./index.esm-Dt7Qe3Av.js";import{r as be,p as Ce}from"./Feilds-BHjWXeSc.js";import{P as ve}from"./ProjectSelectionModal-CwgmrRvW.js";import{C as Se,a as Pe}from"./CCardBody-C0Yq84MQ.js";import{C as Ne}from"./CCardHeader-AnyY50zi.js";import{C as ae}from"./cil-mobile-D36DLDwv.js";import{C as i}from"./CButton-CC7WAWlS.js";import{C as _e}from"./CInputGroup-ByShXRUz.js";import{C as oe}from"./CFormInput-DF8ie22K.js";import{c as re}from"./cil-search-CDkY_4k-.js";import{c as Me}from"./cil-x-0440B5Ce.js";import{C as g}from"./CFormSelect-CFPHA-xf.js";import{a as Te,b as we,c as ke,d as Ie,e as Fe}from"./DefaultLayout-B3RBETEZ.js";import"./CTable-L_woAYa2.js";import"./CFormControlWrapper-BkxhhPL_.js";import"./CFormLabel-B_oLSbD9.js";import"./RawMaterial-BtjEDAbB.js";const Ve=()=>{const[B,b]=o.useState([]),[E,C]=o.useState([]),[p,L]=o.useState(!1),[r,v]=o.useState(""),[S,d]=o.useState([]),[n,P]=o.useState(""),[h,z]=o.useState(""),[N,D]=o.useState("2025"),[ne,l]=o.useState(!1),[u,Y]=o.useState(null),[le,ce]=o.useState(""),[ie,de]=o.useState(""),[me,_]=o.useState(!1),[$,M]=o.useState(""),[m,T]=o.useState([]),[w,H]=o.useState(""),[k,J]=o.useState(""),[I,Q]=o.useState(""),[U,G]=o.useState(!1),[pe,W]=o.useState(!1),F=o.useRef(null),A=o.useRef(null),X=["January","February","March","April","May","June","July","August","September","October","November","December"],q=new Date().getFullYear(),K=[];for(let s=q-5;s<=q+5;s++)K.push(s);const j=(s,t)=>{ce(s),de(t),_(!0),setTimeout(()=>_(!1),5e3)},V=o.useCallback(async s=>{try{const t=await te(`/api/projects?searchQuery=${s}`);d(t||[]),l(!0)}catch(t){console.error("Error fetching projects:",t),d([]),l(!1)}},[]);o.useEffect(()=>{const s=setTimeout(()=>{r&&r.length>2?V(r):(d([]),l(!1))},300);return()=>clearTimeout(s)},[r,V]),o.useEffect(()=>{const s=t=>{F.current&&!F.current.contains(t.target)&&l(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const Z=s=>{v(s.project_name),P(s.id),d([]),l(!1),A.current&&A.current.blur()},he=()=>{S.length>0&&l(!0)},ue=s=>{const t=s.target.value;v(t),n&&t!==r&&P("")},R=async(s=null,t=null)=>{const a=s||h,y=t||N;if(!n||!a){alert("Please select a project and month");return}L(!0);try{const c=await te(`/api/operators-by-product?product_id=${n}&month=${a}&year=${y}`);c.success?(b(c.operators||[]),C(c.supervisors||[]),M(c.previous_payment_msg||""),T(c.previous_pending_months||[])):(b([]),C([]),M(""),T([]))}catch(c){console.error("API Error:",c),b([]),C([]),M(""),T([])}finally{L(!1)}},je=s=>{Y(s),H(""),J(""),Q("")},x=()=>{Y(null)},xe=async()=>{if(!w||!k||!I){j("Please fill all payment details","danger");return}G(!0);const s=u,t={id:s.id,payment:s.payment,total_commission:s.total_commission,total_work_point:s.total_work_point,month:h,year:parseInt(N),project_id:n,payment_by:w,payment_type:k,transaction_id:I};try{const a=await fe("/api/transactions/pay",t);a.success?(await R(),j("Payment Successfully Done!","success"),x()):j(a.message||"Payment failed","danger")}catch(a){console.error("Payment error:",a),j("Payment failed. Please try again.","danger")}finally{G(!1)}},ye=()=>{if(!m||m.length===0)return;const s=m.sort()[0],[t,a]=s.split("-"),y=X[parseInt(a,10)-1];D(t),z(y),R(y,t)},ee=(s,t=!1)=>e.jsxs("div",{className:"table-responsive mb-5",children:[e.jsx("h6",{className:"mb-3",children:t?"Supervisors":"Oprators"}),e.jsxs("table",{className:"table table-striped table-bordered",children:[e.jsx("thead",{className:t?"table-info":"table-primary",children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Mobile"}),e.jsx("th",{children:"Address"}),t?null:e.jsx("th",{children:"Total Work Point"}),e.jsx("th",{children:"Salary"}),t?null:e.jsx("th",{children:"Commission"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Action"})]})}),e.jsx("tbody",{children:s.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.id}),e.jsx("td",{children:a.name}),e.jsx("td",{children:a.mobile}),e.jsx("td",{children:a.address}),t?null:e.jsx("td",{children:a.total_work_point}),e.jsx("td",{children:a.payment}),t?null:e.jsxs("td",{children:[a.commission," × ",a.total_work_point," = ",a.total_commission]}),e.jsx("td",{children:(parseFloat(a.payment||0)+parseFloat(a.total_commission||0)).toFixed(2)}),e.jsx("td",{children:e.jsx(i,{color:a.is_paid?"success":"warning",size:"sm",disabled:a.is_paid,onClick:()=>je(a),children:a.is_paid?"Paid":"Pay"})})]},a.id))})]})]});return e.jsxs("div",{className:"container-fluid py-4",children:[e.jsxs(Se,{children:[e.jsx(Ne,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:e.jsx("h5",{className:"mb-0",children:"Oprator Salary and Commission Report"})}),e.jsxs(Pe,{children:[me&&e.jsx(ae,{color:ie,dismissible:!0,onClose:()=>_(!1),children:le}),$&&m.length>0&&e.jsxs(ae,{color:"warning",className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("strong",{children:$}),"   (Pending Months: ",m.join(", "),")"]}),e.jsx(i,{color:"danger",size:"sm",onClick:ye,children:"Pay Previous"})]}),e.jsxs(ge,{className:"mb-4 d-flex flex-wrap gap-2",children:[e.jsx(f,{md:4,children:e.jsxs("div",{className:"position-relative",ref:F,children:[e.jsxs(_e,{children:[e.jsx(oe,{ref:A,type:"text",value:r,onChange:ue,onFocus:he,placeholder:"Search for a project...",className:"border",autoComplete:"off"}),n?e.jsx(i,{color:"danger",variant:"outline",onClick:()=>{v(""),P(""),d([]),l(!1)},style:{position:"absolute",right:"0",top:"0",bottom:"0",zIndex:5,borderTopLeftRadius:0,borderBottomLeftRadius:0},children:e.jsx(O,{icon:Me})}):e.jsx(i,{color:"primary",variant:"outline",onClick:()=>W(!0),style:{position:"absolute",right:"0",top:"0",bottom:"0",zIndex:5,borderTopLeftRadius:0,borderBottomLeftRadius:0},children:e.jsx(O,{icon:re})})]}),ne&&S.length>0&&e.jsx("div",{className:"dropdown-menu show w-100",style:{maxHeight:"200px",overflowY:"auto",position:"absolute",zIndex:1e3,marginTop:"2px"},children:S.map(s=>e.jsx("div",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>Z(s),children:s.project_name},s.id))}),n&&e.jsxs("div",{className:"text-success mt-1 small",children:["✓ Selected: ",r]})]})}),e.jsx(f,{md:3,children:e.jsxs(g,{value:h,onChange:s=>z(s.target.value),className:"border",children:[e.jsx("option",{value:"",children:"Select Month"}),X.map((s,t)=>e.jsx("option",{value:s,children:s},t))]})}),e.jsx(f,{md:3,children:e.jsxs(g,{value:N,onChange:s=>D(s.target.value),className:"border",children:[e.jsx("option",{value:"",children:"Select Year"}),K.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsx(f,{md:2,children:e.jsx(i,{color:"primary",onClick:()=>R(),disabled:p||!n||!h,className:"w-100",children:p?e.jsxs(e.Fragment,{children:[e.jsx(se,{size:"sm",className:"me-2"})," Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{icon:re,className:"me-2"})," Fetch"]})})})]}),!p&&B.length>0&&ee(B),!p&&E.length>0&&ee(E,!0),e.jsxs(Te,{visible:!!u,onClose:x,backdrop:"static",children:[e.jsx(we,{onClose:x,children:e.jsx(ke,{children:"Make Payment"})}),e.jsx(Ie,{children:u&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"fw-bold",children:["Oprator: ",u.name]}),e.jsxs(g,{className:"mb-3",value:w,onChange:s=>H(s.target.value),children:[e.jsx("option",{value:"",children:"Select Payment By"}),be.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsxs(g,{className:"mb-3",value:k,onChange:s=>J(s.target.value),children:[e.jsx("option",{value:"",children:"Select Payment Type"}),Ce.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx(oe,{type:"text",placeholder:"Transaction Number",value:I,onChange:s=>Q(s.target.value)})]})}),e.jsxs(Fe,{children:[e.jsx(i,{color:"secondary",onClick:x,children:"Cancel"}),e.jsx(i,{color:"primary",disabled:U,onClick:xe,children:U?e.jsx(se,{size:"sm"}):"Submit"})]})]})]})]}),e.jsx(ve,{visible:pe,onClose:()=>W(!1),onSelectProject:Z})]})};export{Ve as default};

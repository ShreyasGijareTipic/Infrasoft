import{r as n,j as e,C as ee}from"./index-Cs-5ghpe.js";import{a as k,p as $}from"./api-CIBCEetx.js";import{w as re}from"./Feilds-BHjWXeSc.js";import{a as N,b as l,c as q}from"./index.esm-DS-fhHF9.js";import{P as te}from"./ProjectSelectionModal-DcIBGY6o.js";import{C as se}from"./cil-mobile-CqmbNfnm.js";import{C as ae,a as oe}from"./CCardBody-CWVv-Bam.js";import{C as ne}from"./CCardHeader-B5GdMtlk.js";import{C as le}from"./CForm-BcOVBk6n.js";import{C as m}from"./CFormLabel-DHukGEEc.js";import{C as v}from"./CInputGroup-BJM5fT4R.js";import{C as h}from"./CFormInput-BnDllJdd.js";import{C as b}from"./CButton-n5jldtHI.js";import{c as de}from"./cil-search-CDkY_4k-.js";import{c as ce}from"./cil-x-0440B5Ce.js";import{C as A}from"./CInputGroupText-CpxPBx2W.js";import{C as z}from"./CFormSelect-DaxkqWsS.js";import"./DefaultLayout-05E0ZdWa.js";import"./RawMaterial-BtjEDAbB.js";import"./CTable-CVLQWVEb.js";import"./CFormControlWrapper-fc1Ss_Cu.js";const Ie=()=>{const[ie,B]=n.useState([]),[G,I]=n.useState(!1),[H,E]=n.useState([]),[me,F]=n.useState(!1),[W,L]=n.useState(!1),[P,S]=n.useState({show:!1,message:"",color:""}),[j,w]=n.useState(null),[o,x]=n.useState({projectName:"",projectId:"",budget:"",projectAmount:"",startDate:"",endDate:"",workPlace:""}),[X,y]=n.useState([]),[g,T]=n.useState(""),[Y,_]=n.useState(!1),[d,p]=n.useState([{operator:"",workType:"",points:0,rate:0}]),c=(r,t="success")=>{S({show:!0,message:r,color:t}),setTimeout(()=>S({show:!1,message:"",color:""}),5e3)},D=n.useCallback(async()=>{try{F(!0);const r=await k("/api/budgets");B(r||[])}catch(r){console.error("Error fetching budgets:",r),c("Failed to fetch budgets","danger"),B([])}finally{F(!1)}},[]),O=n.useCallback(async r=>{try{const t=await k(`/api/projects?searchQuery=${r}`);y(t||[])}catch(t){console.error("Error fetching projects:",t),y([])}},[]),R=n.useCallback(async()=>{try{const r=await k("/api/vendors");if(!r)throw new Error("Failed to fetch vendors");E(r)}catch(r){console.error("Error fetching vendors:",r),E([])}},[]);n.useEffect(()=>{R(),D()},[R,D]),n.useEffect(()=>{const r=setTimeout(()=>{g&&g.length>2?O(g):y([])},300);return()=>clearTimeout(r)},[g,O]),n.useEffect(()=>{const r=d.reduce((t,s)=>t+Number(s.points||0)*Number(s.rate||0),0);x(t=>({...t,budget:r.toString()}))},[d]);const M=(X||[]).filter(r=>((r==null?void 0:r.project_name)||"").toLowerCase().includes(g.toLowerCase())),f=r=>{x({...o,[r.target.name]:r.target.value})},U=async r=>{try{const t=[{operator:"",workType:"",points:0,rate:0}];p(t),x(a=>({...a,projectId:r.id,projectName:r.project_name,projectAmount:r.project_cost||"",startDate:r.start_date?r.start_date.split("T")[0]:"",endDate:r.end_date?r.end_date.split("T")[0]:"",workPlace:r.work_place||""}));const s=await k(`/api/budgets?project_id=${r.id}`);if(s&&s.length>0){const a=s[0];if(w(a.id),a.works&&a.works.length>0){const u=a.works.map(i=>{var V;return{operator:((V=i.operator_id)==null?void 0:V.toString())||"",workType:i.work_type||"",points:i.points||0,rate:i.rate||0}});p(u)}x(u=>{var i;return{...u,budget:((i=a.budget)==null?void 0:i.toString())||""}})}else w(null),p(t)}catch(t){console.error("Error fetching project budget:",t),w(null),p([{operator:"",workType:"",points:0,rate:0}])}T(r.project_name),y([]),_(!1)},Q=()=>{x({projectName:"",projectId:"",budget:"",projectAmount:"",startDate:"",endDate:"",workPlace:""}),T(""),_(!1),w(null),p([{operator:"",workType:"",points:0,rate:0}])},C=(r,t,s)=>{const a=[...d];a[r][t]=s,p(a)},J=()=>{p([...d,{operator:"",workType:"",points:0,rate:0}])},K=r=>{if(d.length>1){const t=[...d];t.splice(r,1),p(t)}},Z=async()=>{var t,s;if(!o.projectName.trim()){c("Project name is required.","warning");return}if(!o.budget){c("Budget is required.","warning");return}if(!o.projectAmount){c("Project amount is required.","warning");return}if(d.some(a=>!a.operator)){c("Please select a vendor for all work entries.","warning");return}if(d.some(a=>!a.workType)){c("Please select a work type for all work entries.","warning");return}if(d.some(a=>!a.points||a.points<=0)){c("Points must be greater than 0 for all work entries.","warning");return}if(d.some(a=>!a.rate||a.rate<=0)){c("Rate must be greater than 0 for all work entries.","warning");return}if(d.reduce((a,u)=>a+Number(u.points||0)*Number(u.rate||0),0)>Number(o.projectAmount)){c("Total work cost cannot exceed the project amount.","danger");return}try{L(!0);const a={project_id:o.projectId||null,project_name:o.projectName,budget:parseFloat(o.budget),project_amount:parseFloat(o.projectAmount),start_date:o.startDate||null,end_date:o.endDate||null,work_place:o.workPlace||null,works:d.map(i=>({operator:parseInt(i.operator),workType:i.workType,points:parseInt(i.points),rate:parseFloat(i.rate)}))};let u;j?(u=await $(`/api/budgets/${j}`,a,"PUT"),c("Budget updated successfully!","success")):(u=await $("/api/budgets",a),c("Budget created successfully!","success")),Q(),D()}catch(a){console.error("Error saving budget:",a),c(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to save budget. Please try again.","danger")}finally{L(!1)}};return e.jsxs("div",{className:"",children:[P.show&&e.jsx(se,{color:P.color,dismissible:!0,onClose:()=>S({show:!1,message:"",color:""}),children:P.message}),e.jsxs(ae,{className:"border-grey rounded-3",children:[e.jsx(ne,{className:"bg-primary bg-gradient text-white fw-semibold fs-5 rounded-top-3 p-2",children:j?"Update Budget":"Budget"}),e.jsx(oe,{className:"p-4",children:e.jsxs(le,{children:[e.jsxs(N,{className:"g-3 mb-4",children:[e.jsxs(l,{md:6,children:[e.jsx(m,{className:"fw-medium text-dark",children:"Project Name *"}),e.jsxs(v,{children:[e.jsx(h,{type:"text",value:g,onChange:r=>{T(r.target.value),_(!0)},placeholder:"Search for a project...",className:"rounded-2 border-grey"}),o.projectName?e.jsx(b,{type:"button",color:"danger",variant:"outline",onClick:Q,className:"rounded-2",children:e.jsx(q,{icon:ce})}):e.jsx(b,{color:"primary",variant:"outline",onClick:()=>I(!0),className:"rounded-2",children:e.jsx(q,{icon:de})})]}),Y&&M.length>0&&e.jsx("div",{className:"border rounded bg-white mt-1 shadow-sm",style:{maxHeight:"200px",overflowY:"auto",position:"absolute",zIndex:1e3,width:"calc(100% - 30px)"},children:M.map(r=>e.jsxs("div",{className:"p-2 border-bottom cursor-pointer hover-bg-light",style:{cursor:"pointer"},onClick:()=>U(r),onMouseEnter:t=>t.target.style.backgroundColor="#f8f9fa",onMouseLeave:t=>t.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium",children:r.project_name}),r.project_cost&&e.jsxs("small",{className:"text-muted",children:["Amount: ₹",r.project_cost]})]},r.id))})]}),e.jsxs(l,{md:3,children:[e.jsx(m,{className:"fw-medium text-dark",children:"Project Amount *"}),e.jsxs(v,{children:[e.jsx(A,{children:"₹"}),e.jsx(h,{name:"projectAmount",type:"number",value:o.projectAmount,onChange:f,className:"rounded-2 border-grey",readOnly:!!o.projectId})]})]}),e.jsxs(l,{md:3,children:[e.jsx(m,{className:"fw-medium text-dark",children:"Budget *"}),e.jsxs(v,{children:[e.jsx(A,{children:"₹"}),e.jsx(h,{name:"budget",type:"number",value:o.budget,onChange:f,className:"rounded-2 border-grey",readOnly:!0})]})]})]}),e.jsxs(N,{className:"g-3 mb-4",children:[e.jsxs(l,{md:4,children:[e.jsx(m,{className:"fw-medium text-dark",children:"Work Place"}),e.jsx(h,{name:"workPlace",value:o.workPlace,onChange:f,className:"rounded-2 border-grey",readOnly:!!o.projectId})]}),e.jsxs(l,{md:4,children:[e.jsx(m,{className:"fw-medium text-dark",children:"Start Date"}),e.jsx(h,{type:"date",name:"startDate",value:o.startDate,onChange:f,className:"rounded-2 border-grey",readOnly:!!o.projectId})]}),e.jsxs(l,{md:4,children:[e.jsx(m,{className:"fw-medium text-dark",children:"End Date"}),e.jsx(h,{type:"date",name:"endDate",value:o.endDate,onChange:f,className:"rounded-2 border-grey",readOnly:!!o.projectId})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),e.jsxs(N,{className:"g-3 mb-2",children:[e.jsx(l,{md:3,children:e.jsx(m,{className:"fw-medium text-dark",children:"Vendor"})}),e.jsx(l,{md:3,children:e.jsx(m,{className:"fw-medium text-dark",children:"Work Type"})}),e.jsx(l,{md:2,children:e.jsx(m,{className:"fw-medium text-dark",children:"Quantity"})}),e.jsx(l,{md:2,children:e.jsx(m,{className:"fw-medium text-dark",children:"Price"})}),e.jsx(l,{md:1,children:e.jsx(m,{className:"fw-medium text-dark",children:"Total"})}),e.jsx(l,{md:1,children:e.jsx(m,{className:"fw-medium text-dark",children:"Action"})})]}),d.map((r,t)=>e.jsxs(N,{className:"g-3 mb-3 align-items-center",children:[e.jsx(l,{md:3,children:e.jsxs(z,{value:r.operator,onChange:s=>C(t,"operator",s.target.value),className:"rounded-2 border-grey",children:[e.jsx("option",{value:"",children:"Select Vendor"}),H.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.gst_no?`(${s.gst_no})`:""]},s.id))]})}),e.jsx(l,{md:3,children:e.jsxs(z,{value:r.workType,onChange:s=>C(t,"workType",s.target.value),className:"rounded-2 border-grey",children:[e.jsx("option",{value:"",children:"Select Work Type"}),re.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})}),e.jsx(l,{md:2,children:e.jsx(h,{type:"number",value:r.points,onChange:s=>C(t,"points",s.target.value),placeholder:"Points",className:"rounded-2 border-grey",min:"1"})}),e.jsx(l,{md:2,children:e.jsxs(v,{children:[e.jsx(A,{children:"₹"}),e.jsx(h,{type:"number",value:r.rate,onChange:s=>C(t,"rate",s.target.value),placeholder:"Rate",className:"rounded-2 border-grey",min:"0.01",step:"0.01"})]})}),e.jsx(l,{md:1,className:"d-flex align-items-center",children:e.jsxs("span",{className:"text-success fw-medium",children:["₹",(r.points||0)*(r.rate||0)]})}),e.jsx(l,{md:1,className:"d-flex align-items-center",children:e.jsx(b,{color:"danger",size:"sm",shape:"rounded-pill",className:"shadow-sm",onClick:()=>K(t),disabled:d.length===1,children:"×"})})]},t)),e.jsx(b,{color:"warning",variant:"outline",className:"mb-4 rounded-pill shadow-sm px-4",onClick:J,children:"+ Add Work"}),e.jsx("div",{className:"mt-3",children:e.jsx(b,{color:"primary",className:"bg-gradient rounded-pill shadow-sm px-5 py-2 me-2",onClick:Z,disabled:W,children:W?e.jsxs(e.Fragment,{children:[e.jsx(ee,{size:"sm",className:"me-2"}),j?"Updating...":"Creating..."]}):j?"Update Budget":"Create Budget"})})]})})]}),e.jsx(te,{visible:G,onClose:()=>I(!1),onSelectProject:U})]})};export{Ie as default};

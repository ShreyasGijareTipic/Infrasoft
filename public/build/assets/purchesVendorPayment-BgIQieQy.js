import{r as y,j as e,C as pe,b as st}from"./index-DsLCqE06.js";import{a as I,b as v,c as E}from"./index.esm-BlJU5mne.js";import{h as lt,a as te,c as ot,b as ct,p as dt}from"./api-CIBCEetx.js";import{P as mt}from"./ProjectSelectionModal-DNu_Hs6-.js";import{r as ht,p as pt}from"./Feilds-BHjWXeSc.js";import{a as ae,b as re,c as ne,d as ie,f as ut,g as Ne,h as ke,i as xt,j as Te,e as se,C as he,n as yt}from"./DefaultLayout-5pHqimqm.js";import{C as Be}from"./CForm-D8EjkW87.js";import{C as S}from"./CFormLabel-CVJu7LBr.js";import{C as Ae}from"./CFormSelect-84oUtJFR.js";import{C as D}from"./CFormInput-Db5B42Su.js";import{C as ue}from"./cil-mobile-CNtzZ120.js";import{C as T}from"./CButton-DirJQzUR.js";import{c as Le}from"./cil-file-CeQgYs_D.js";import{C as Me,a as qe}from"./CCardBody-DQWRa7c4.js";import{C as $e}from"./CCardHeader-PfItfEOJ.js";import{C as Ee,a as Ie,b as le,c as N,d as ze,e as k}from"./CTable-BAKI_IEN.js";import{E as xe}from"./jspdf.es.min-cKyHKAYl.js";import"./jspdf.plugin.autotable-B41L-UUw.js";import{utils as q,writeFile as ye}from"./xlsx-B6sNpj_1.js";import{C as jt}from"./CInputGroup-DRcn0dWJ.js";import{c as ft}from"./cil-search-CDkY_4k-.js";import{c as _t}from"./cil-x-0440B5Ce.js";import{c as gt}from"./cil-pencil-m516yCOw.js";import{c as De}from"./cil-plus-D8mtC-W5.js";import"./RawMaterial-BtjEDAbB.js";import"./CFormControlWrapper-D9cjubv0.js";import"./typeof-QjJsDpFa.js";import"./jspdf.es.min-ButOjYP_.js";var bt=["512 512","<rect width='264' height='32' x='208' y='80' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M40,96a64,64,0,1,0,64-64A64.072,64.072,0,0,0,40,96Zm64-32A32,32,0,1,1,72,96,32.036,32.036,0,0,1,104,64Z' class='ci-primary'/><rect width='264' height='32' x='208' y='240' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M104,320a64,64,0,1,0-64-64A64.072,64.072,0,0,0,104,320Zm0-96a32,32,0,1,1-32,32A32.036,32.036,0,0,1,104,224Z' class='ci-primary'/><rect width='264' height='32' x='208' y='400' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M104,480a64,64,0,1,0-64-64A64.072,64.072,0,0,0,104,480Zm0-96a32,32,0,1,1-32,32A32.036,32.036,0,0,1,104,384Z' class='ci-primary'/>"],We=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M16,64V456H496V64ZM464,424H48V96H464Z' class='ci-primary'/><rect width='88' height='32' x='88' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/>"];const Ft=({visible:r,onClose:n,payForm:a={},payError:m,payLoading:h,onChange:s,onSubmit:p,selectedVendorPayment:l})=>{var g,w,C,b;const[o,j]=y.useState("upload"),P=()=>{if(!a.payment_file)return null;const u=a.payment_file,F=u.type.startsWith("image/"),L=u.type==="application/pdf";return e.jsxs("div",{className:"mt-3 p-3 border rounded bg-light",children:[e.jsx("strong",{children:"Selected file:"})," ",u.name," (",(u.size/1024).toFixed(2)," KB)",F&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:URL.createObjectURL(u),alt:"Preview",style:{maxWidth:"100%",maxHeight:"200px",objectFit:"contain"}})}),L&&e.jsx("div",{className:"mt-2 text-primary",children:e.jsx("strong",{children:"PDF file selected"})})]})},d=["imps","neft","rtgs"].includes((g=a.payment_type)==null?void 0:g.toLowerCase()),f=((w=a.payment_type)==null?void 0:w.toLowerCase())==="upi",c=u=>{u&&u.preventDefault(),p(o)};return e.jsxs(ae,{visible:r,onClose:n,backdrop:"static",size:"xl",children:[e.jsx(re,{onClose:n,children:e.jsx(ne,{children:"Make Payment"})}),e.jsx(ie,{children:e.jsxs(Be,{onSubmit:c,children:[e.jsxs(I,{className:"g-3 mb-4",children:[e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Vendor Name"}),e.jsx("div",{className:"form-control bg-light",children:((b=(C=l==null?void 0:l.purchase)==null?void 0:C.vendor)==null?void 0:b.name)||"—"})]}),e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Remaining Balance"}),e.jsxs("div",{className:"form-control text-danger fw-bold",children:["₹",parseFloat((l==null?void 0:l.balance_amount)||0).toFixed(2)]})]})]}),e.jsxs(I,{className:"g-3 mb-4",children:[e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Paid By *"}),e.jsxs(Ae,{name:"paid_by",value:a.paid_by||"",onChange:s,required:!0,children:[e.jsx("option",{value:"",children:"Select Paid By"}),ht.map(u=>e.jsx("option",{value:u.value,children:u.label},u.value))]})]}),e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Payment Type *"}),e.jsxs(Ae,{name:"payment_type",value:a.payment_type||"",onChange:s,required:!0,children:[e.jsx("option",{value:"",children:"Select Payment Type"}),pt.map(u=>e.jsx("option",{value:u.value,children:u.label},u.value))]})]})]}),e.jsxs(I,{className:"g-3 mb-4",children:[e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Amount *"}),e.jsx(D,{type:"number",name:"amount",value:a.amount||"",onChange:s,step:"0.01",min:"0.01",placeholder:"0.00",required:!0})]}),e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Payment Date *"}),e.jsx(D,{type:"date",name:"payment_date",value:a.payment_date||"",onChange:s,max:new Date().toISOString().split("T")[0],required:!0})]})]}),d&&e.jsxs("div",{className:"border rounded p-4 mb-4 bg-light",children:[e.jsx("h6",{className:"mb-3 text-primary",children:"Bank Transfer Details"}),e.jsxs(I,{className:"g-3",children:[e.jsxs(v,{md:6,lg:3,children:[e.jsx(S,{htmlFor:"bank_name",children:"Bank Name *"}),e.jsx(D,{type:"text",id:"bank_name",name:"bank_name",placeholder:"Enter bank name",value:a.bank_name||"",onChange:s,required:!0})]}),e.jsxs(v,{md:6,lg:3,children:[e.jsx(S,{htmlFor:"acc_number",children:"Account Number *"}),e.jsx(D,{type:"text",id:"acc_number",name:"acc_number",placeholder:"Enter account number",value:a.acc_number||"",onChange:s,required:!0})]}),e.jsxs(v,{md:6,lg:3,children:[e.jsx(S,{htmlFor:"ifsc",children:"IFSC Code *"}),e.jsx(D,{type:"text",id:"ifsc",name:"ifsc",placeholder:"Enter IFSC code",value:a.ifsc||"",onChange:s,required:!0})]}),e.jsxs(v,{md:6,lg:3,children:[e.jsx(S,{htmlFor:"transaction_id",children:"Transaction ID / UTR *"}),e.jsx(D,{type:"text",id:"transaction_id",name:"transaction_id",placeholder:"Enter transaction ID",value:a.transaction_id||"",onChange:s,required:!0})]})]})]}),f&&e.jsxs("div",{className:"border rounded p-4 mb-4 bg-light",children:[e.jsx("h6",{className:"mb-3 text-primary",children:"UPI Details"}),e.jsx(I,{className:"g-3",children:e.jsxs(v,{md:6,lg:4,children:[e.jsx(S,{htmlFor:"transaction_id",children:"UPI Transaction ID *"}),e.jsx(D,{type:"text",id:"transaction_id",name:"transaction_id",placeholder:"Enter UPI transaction ID",value:a.transaction_id||"",onChange:s,required:!0})]})})]}),e.jsx(I,{className:"mb-4",children:e.jsxs(v,{children:[e.jsx(S,{children:"Description (optional)"}),e.jsx(D,{name:"description",value:a.description||"",onChange:s,placeholder:"e.g. Payment for material delivery"})]})}),e.jsxs(ut,{variant:"pills",className:"mb-3",children:[e.jsx(Ne,{children:e.jsx(ke,{active:o==="upload",onClick:()=>j("upload"),style:{cursor:"pointer"},children:"Upload Photo / File"})}),e.jsx(Ne,{children:e.jsx(ke,{active:o==="remark",onClick:()=>j("remark"),style:{cursor:"pointer"},children:"Remark"})})]}),e.jsxs(xt,{children:[e.jsxs(Te,{visible:o==="upload",children:[e.jsxs(S,{children:["Upload Photo / File",e.jsx("span",{className:"text-danger",children:" *"})]}),e.jsx(D,{type:"file",name:"payment_file",accept:"image/png,image/jpeg,image/jpg,application/pdf",onChange:s}),e.jsx("small",{className:"text-muted d-block mt-1",children:"Payment photo/file is required when on Upload tab. Accepted formats: JPG, PNG, PDF (Max 5MB)"}),P()]}),e.jsxs(Te,{visible:o==="remark",children:[e.jsxs(S,{children:["Remark ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("textarea",{className:"form-control",name:"remark",rows:"4",value:a.remark||"",onChange:s,placeholder:"Enter any remark..."}),e.jsx("small",{className:"text-muted d-block mt-1",children:"Payment remark is required when on Remark tab"})]})]}),m&&e.jsx(ue,{color:"danger",className:"mt-3",children:m})]})}),e.jsxs(se,{children:[e.jsx(T,{color:"secondary",onClick:n,disabled:h,children:"Cancel"}),e.jsx(T,{color:"primary",onClick:c,disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(pe,{size:"sm",className:"me-2"}),"Processing..."]}):"Submit Payment"})]})]})},vt=({visible:r,onClose:n,isEdit:a=!1,form:m={},vendors:h=[],onChange:s,onSubmit:p,error:l})=>!m||!h?null:e.jsxs(ae,{visible:r,onClose:n,size:"lg",backdrop:"static",children:[e.jsx(re,{onClose:n,children:e.jsxs(ne,{children:[a?"Edit":"Add"," Material"]})}),e.jsx(ie,{children:e.jsxs(Be,{children:[e.jsxs(I,{className:"g-3",children:[e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Vendor *"}),e.jsxs("select",{className:"form-select",name:"vendor_id",value:m.vendor_id||"",onChange:s,children:[e.jsx("option",{value:"",children:"Select Vendor"}),h.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]}),e.jsxs(v,{md:6,children:[e.jsx(S,{children:"Material Name *"}),e.jsx(D,{name:"material_name",value:m.material_name||"",onChange:s,placeholder:"e.g. Cement, Bricks"})]})]}),e.jsx(I,{className:"g-3 mt-3",children:e.jsxs(v,{children:[e.jsx(S,{children:"About (optional)"}),e.jsx(D,{name:"about",value:m.about||"",onChange:s,placeholder:"Any additional details"})]})}),e.jsxs(I,{className:"g-3 mt-3 align-items-end",children:[e.jsxs(v,{md:3,children:[e.jsx(S,{children:"Qty *"}),e.jsx(D,{type:"number",name:"qty",value:m.qty||"",onChange:s,min:"0.01",step:"0.01"})]}),e.jsxs(v,{md:3,children:[e.jsx(S,{children:"Price/Unit *"}),e.jsx(D,{type:"number",name:"price",value:m.price||"",onChange:s,min:"0",step:"0.01"})]}),e.jsxs(v,{md:3,children:[e.jsx(S,{children:"Total"}),e.jsx(D,{value:m.qty&&m.price?(m.qty*m.price).toFixed(2):"0.00",readOnly:!0,className:"bg-light"})]}),e.jsxs(v,{md:3,children:[e.jsx(S,{children:"Date *"}),e.jsx(D,{type:"date",name:"date",value:m.date||"",onChange:s,max:new Date().toISOString().split("T")[0]})]})]}),l&&e.jsx(ue,{color:"danger",className:"mt-3",children:l})]})}),e.jsxs(se,{children:[e.jsx(T,{color:"secondary",onClick:n,children:"Cancel"}),e.jsx(T,{color:"primary",onClick:p,children:a?"Update":"Save"})]})]}),Pt=({visible:r,onClose:n,logsData:a,loading:m,onDownloadPDF:h,onDownloadExcel:s})=>{var o,j,P,d,f;const[p,l]=y.useState(null);return e.jsxs(e.Fragment,{children:[e.jsxs(ae,{visible:r,onClose:n,size:"xl",backdrop:"static",children:[e.jsx(re,{onClose:n,children:e.jsx(ne,{children:"Payment Logs"})}),e.jsx(ie,{children:m?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(pe,{}),e.jsx("p",{children:"Loading..."})]}):a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex justify-content-end gap-2 mb-3",children:[e.jsxs(T,{color:"primary",onClick:h,children:[e.jsx(E,{icon:Le})," PDF"]}),e.jsxs(T,{color:"success",onClick:s,children:[e.jsx(E,{icon:We})," Excel"]})]}),e.jsxs(Me,{className:"mb-4",children:[e.jsx($e,{children:"Summary"}),e.jsx(qe,{children:e.jsxs(I,{children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Vendor:"})," ",(o=a.vendor_details)==null?void 0:o.vendor_name]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Total:"})," ₹",parseFloat(((j=a.payment_master)==null?void 0:j.total_amount)||0).toFixed(2)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Paid:"})," ₹",parseFloat(((P=a.payment_master)==null?void 0:P.paid_amount)||0).toFixed(2)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Balance:"})," ₹",parseFloat(((d=a.payment_master)==null?void 0:d.balance_amount)||0).toFixed(2)]})]})})]}),e.jsxs(Ee,{striped:!0,bordered:!0,hover:!0,children:[e.jsx(Ie,{color:"dark",children:e.jsxs(le,{children:[e.jsx(N,{children:"#"}),e.jsx(N,{children:"Paid By"}),e.jsx(N,{children:"Type"}),e.jsx(N,{children:"Amount"}),e.jsx(N,{children:"Date"}),e.jsx(N,{children:"Description"}),e.jsx(N,{children:"Bank Name"}),e.jsx(N,{children:"A/C No"}),e.jsx(N,{children:"IFSC"}),e.jsx(N,{children:"Transaction ID / UTR"}),e.jsx(N,{children:"File"})]})}),e.jsx(ze,{children:(f=a.payment_logs)==null?void 0:f.map((c,g)=>e.jsxs(le,{children:[e.jsx(k,{children:g+1}),e.jsx(k,{children:c.paid_by}),e.jsx(k,{children:e.jsx(he,{color:c.payment_type==="Cash"?"success":"info",children:c.payment_type})}),e.jsxs(k,{children:["₹",parseFloat(c.amount).toFixed(2)]}),e.jsx(k,{children:new Date(c.payment_date).toLocaleDateString()}),e.jsx(k,{children:c.description||"-"}),e.jsx(k,{children:c.bank_name||"-"}),e.jsx(k,{children:c.acc_number||"-"}),e.jsx(k,{children:c.ifsc||"-"}),e.jsx(k,{children:c.transaction_id||"-"}),e.jsx(k,{children:c.payment_file?e.jsx(T,{size:"sm",color:"info",onClick:()=>l(c.payment_file),children:"View"}):e.jsx(he,{color:"secondary",children:"No File"})})]},c.id))})]})]}):e.jsx(ue,{color:"info",children:"No payment logs found."})}),e.jsx(se,{children:e.jsx(T,{color:"secondary",onClick:n,children:"Close"})})]}),e.jsxs(ae,{visible:!!p,onClose:()=>l(null),size:"lg",children:[e.jsx(re,{children:e.jsx(ne,{children:"View File"})}),e.jsx(ie,{children:p?(()=>{const c=p.split("/").pop(),g=p.startsWith("img/")?p:"img/"+p,w=lt+g,C=c.split(".").pop().toLowerCase();return C==="pdf"?e.jsx("iframe",{src:w,title:"PDF Preview",style:{width:"100%",height:"70vh",border:"none"}}):["jpg","jpeg","png"].includes(C)?e.jsx("img",{src:w,alt:"File",style:{maxWidth:"100%",maxHeight:"70vh",display:"block",margin:"auto",borderRadius:"10px"}}):e.jsx("p",{style:{color:"red",textAlign:"center"},children:"Unsupported file type"})})():e.jsx("p",{style:{color:"red",textAlign:"center"},children:"File not available"})}),e.jsx(se,{children:e.jsx(T,{color:"secondary",onClick:()=>l(null),children:"Close"})})]})]})},wt=(r,n)=>{const a=new xe("landscape");a.setFontSize(22).setFont(void 0,"bold").text("Purchase Vendor Payments Report",14,20),a.setFontSize(14).setFont(void 0,"normal").text(`Project: ${n}`,14,32),a.setFontSize(12).text(`Generated on: ${new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}`,14,42);const m=["Vendor Name","Material","Qty","Price/Unit","Total","Paid","Balance","Status","Created"],h=[];let s=0,p=0,l=0;r.forEach(o=>{var C,b,u,F,L;const j=parseFloat(o.amount),P=parseFloat(o.paid_amount),d=parseFloat(o.balance_amount),f=parseFloat(((C=o==null?void 0:o.purchase)==null?void 0:C.qty)||0),c=parseFloat(((b=o==null?void 0:o.purchase)==null?void 0:b.price_per_unit)||0),g=P/j,w=g===0?"Unpaid":g===1?"Paid":"Partial";s+=j,p+=P,l+=d,h.push([((F=(u=o==null?void 0:o.purchase)==null?void 0:u.vendor)==null?void 0:F.name)||"-",((L=o==null?void 0:o.purchase)==null?void 0:L.material_name)||"-",f.toFixed(2),c.toFixed(2),j.toFixed(2),P.toFixed(2),d.toFixed(2),w,new Date(o.created_at).toLocaleDateString("en-GB")])}),h.push(["Total:","","","",s.toFixed(2),p.toFixed(2),l.toFixed(2),"",""]),a.autoTable({head:[m],body:h,startY:52,theme:"grid",styles:{fontSize:9,cellPadding:3,lineColor:[44,62,80],lineWidth:.1},headStyles:{fillColor:[52,152,219],textColor:[255,255,255],fontStyle:"bold",halign:"center",fontSize:10},columnStyles:{0:{cellWidth:35,halign:"left"},1:{cellWidth:30,halign:"left"},2:{cellWidth:20,halign:"right"},3:{cellWidth:24,halign:"right"},4:{cellWidth:24,halign:"right"},5:{cellWidth:24,halign:"right"},6:{cellWidth:24,halign:"right"},7:{cellWidth:22,halign:"center"},8:{cellWidth:26,halign:"center"}},alternateRowStyles:{fillColor:[245,245,245]},didParseCell:o=>{o.row.index===h.length-1&&(o.cell.styles.fontStyle="bold",o.cell.styles.fillColor=[220,230,241])}}),a.save(`vendor-payments-${n.replace(/\s+/g,"-")}-${Date.now()}.pdf`)},Ct=(r,n)=>{let a=0,m=0,h=0;const s=r.map(d=>{var F,L,U,R,W;const f=parseFloat(d.amount),c=parseFloat(d.paid_amount),g=parseFloat(d.balance_amount),w=parseFloat(((F=d==null?void 0:d.purchase)==null?void 0:F.qty)||0),C=parseFloat(((L=d==null?void 0:d.purchase)==null?void 0:L.price_per_unit)||0),b=c/f,u=b===0?"Unpaid":b===1?"Paid":"Partial";return a+=f,m+=c,h+=g,{"Vendor Name":((R=(U=d==null?void 0:d.purchase)==null?void 0:U.vendor)==null?void 0:R.name)||"-",Material:((W=d==null?void 0:d.purchase)==null?void 0:W.material_name)||"-",Qty:w.toFixed(2),"Price/Unit":C.toFixed(2),Total:f.toFixed(2),Paid:c.toFixed(2),Balance:g.toFixed(2),Status:u,Created:new Date(d.created_at).toLocaleDateString("en-GB")}});s.push({"Vendor Name":"Total:",Material:"",Qty:"","Price/Unit":"",Total:a.toFixed(2),Paid:m.toFixed(2),Balance:h.toFixed(2),Status:"",Created:""});const p=q.book_new(),l=q.aoa_to_sheet([]),o=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});q.sheet_add_aoa(l,[["Purchase Vendor Payments Report"],[`Project: ${n}`],[`Generated on: ${o}`],[]],{origin:"A1"}),q.sheet_add_json(l,s,{origin:"A5",skipHeader:!1});const j=["A","B","C","D","E","F","G","H","I"];j.forEach(d=>{const f=`${d}5`;l[f]&&(l[f].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"3498DB"}},alignment:{horizontal:"center"}})});const P=4+s.length+1;j.forEach(d=>{const f=l[`${d}${P}`];f&&(f.s={font:{bold:!0},fill:{fgColor:{rgb:"DCE6F1"}},alignment:{horizontal:d==="A"?"left":"right"}})}),l["!cols"]=[{wch:25},{wch:25},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15},{wch:12},{wch:18}],l["!merges"]=[{s:{r:0,c:0},e:{r:0,c:8}},{s:{r:1,c:0},e:{r:1,c:8}},{s:{r:2,c:0},e:{r:2,c:8}}],q.book_append_sheet(p,l,"Payments"),ye(p,`vendor-payments-${n.replace(/\s+/g,"-")}-${Date.now()}.xlsx`)},St=(r,n)=>{const a=new xe("landscape");a.setFontSize(18).setFont("helvetica","bold").text("All Vendor Payment Logs",14,15),a.setFontSize(12).setFont("helvetica","normal").text(`Project: ${n}`,14,23),a.setFontSize(10).text(`Generated: ${new Date().toLocaleString("en-GB")}`,14,30);const m=[];let h=0,s=0,p=0;r.forEach(l=>{var c,g,w,C;const o=((g=(c=l.purchase)==null?void 0:c.vendor)==null?void 0:g.name)||"Unknown",j=((w=l.purchase)==null?void 0:w.material_name)||"-",P=parseFloat(l.amount),d=parseFloat(l.paid_amount),f=parseFloat(l.balance_amount);h+=P,s+=d,p+=f,m.push([{content:`Vendor: ${o} | Material: ${j}`,colSpan:6,styles:{fontStyle:"bold",fillColor:[230,240,255],fontSize:10,textColor:[20,40,90]}},{content:P.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:d.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:f.toFixed(2),styles:{fontStyle:"bold",halign:"right",fillColor:f===0?[220,255,220]:[255,230,230]}}]),((C=l.logs)==null?void 0:C.length)>0?l.logs.forEach((b,u)=>{var F;m.push([u+1,b.paid_by||"-",b.payment_type||"-",parseFloat(b.amount).toFixed(2),new Date(b.payment_date).toLocaleDateString("en-GB"),(b.description||"-").substring(0,40)+(((F=b.description)==null?void 0:F.length)>40?"...":""),"","",""])}):m.push([{content:"No payments yet",colSpan:6,styles:{fontStyle:"italic",textColor:[150,150,150]}},"","",""]),m.push(["","","","","","","","",""])}),m.push([{content:"GRAND TOTAL",colSpan:6,styles:{fontStyle:"bold",fillColor:[200,230,200],fontSize:11}},{content:h.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:s.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:p.toFixed(2),styles:{fontStyle:"bold",halign:"right",fillColor:p===0?[180,255,180]:[255,180,180]}}]),a.autoTable({head:[["No.","Paid By","Type","Amount","Date","Description","Total","Paid","Balance"]],body:m,startY:35,theme:"grid",styles:{fontSize:8.5,cellPadding:2.5,lineColor:[180,180,180],lineWidth:.1},headStyles:{fillColor:[30,100,180],textColor:255,fontStyle:"bold",fontSize:9},columnStyles:{0:{cellWidth:12},1:{cellWidth:35},2:{cellWidth:25},3:{cellWidth:28},4:{cellWidth:28},5:{cellWidth:85},6:{cellWidth:30,halign:"right"},7:{cellWidth:30,halign:"right"},8:{cellWidth:30,halign:"right"}},margin:{top:35,left:8,right:8}}),a.save(`All_Logs_${n.replace(/[^a-zA-Z0-9]/g,"_")}_${Date.now()}.pdf`)},Nt=(r,n)=>{const a=[];let m=0,h=0,s=0;r.forEach(j=>{var w,C,b,u;const P=((C=(w=j.purchase)==null?void 0:w.vendor)==null?void 0:C.name)||"Unknown",d=((b=j.purchase)==null?void 0:b.material_name)||"-",f=parseFloat(j.amount),c=parseFloat(j.paid_amount),g=parseFloat(j.balance_amount);m+=f,h+=c,s+=g,a.push({"Vendor → Material":`${P} → ${d}`,"#":"","Paid By":"",Type:"",Amount:"","Payment Date":"",Description:"",Total:f.toFixed(2),Paid:c.toFixed(2),Balance:g.toFixed(2)}),((u=j.logs)==null?void 0:u.length)>0?j.logs.forEach((F,L)=>{a.push({"Vendor → Material":"","#":L+1,"Paid By":F.paid_by||"-",Type:F.payment_type||"-",Amount:parseFloat(F.amount).toFixed(2),"Payment Date":new Date(F.payment_date).toLocaleDateString("en-GB"),Description:F.description||"-",Total:"",Paid:"",Balance:""})}):a.push({"Vendor → Material":"","#":"","Paid By":"No payments yet",Total:"",Paid:"",Balance:""}),a.push({})}),a.push({"Vendor → Material":"GRAND TOTAL",Total:m.toFixed(2),Paid:h.toFixed(2),Balance:s.toFixed(2)});const p=q.book_new(),l=q.aoa_to_sheet([]),o=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});q.sheet_add_aoa(l,[["All Vendor Payment Logs (Detailed)"],[`Project: ${n}`],[`Generated on: ${o}`],[]],{origin:"A1"}),q.sheet_add_json(l,a,{origin:"A5",skipHeader:!1}),l["!cols"]=[{wch:40},{wch:8},{wch:25},{wch:15},{wch:15},{wch:18},{wch:35},{wch:15},{wch:15},{wch:15}],l["!merges"]=[{s:{r:0,c:0},e:{r:0,c:9}},{s:{r:1,c:0},e:{r:1,c:9}},{s:{r:2,c:0},e:{r:2,c:9}}],q.book_append_sheet(p,l,"All Payment Logs"),ye(p,`all-payment-logs-${n.replace(/\s+/g,"-")}-${Date.now()}.xlsx`)},kt=r=>{var c,g,w,C,b,u,F,L,U,R,W,z;const n=new xe("landscape");n.setFontSize(20),n.setFont(void 0,"bold"),n.text("Vendor Payment Report",14,18),n.setFontSize(13),n.setFont(void 0,"normal"),n.text(`Project: ${((g=(c=r.vendor_details)==null?void 0:c.project)==null?void 0:g.project_name)||"N/A"}`,14,28);const a=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});n.setFontSize(11),n.text(`Generated: ${a}`,14,36);const m=((w=r.vendor_details)==null?void 0:w.vendor_name)||"N/A",h=((C=r.vendor_details)==null?void 0:C.material_name)||"N/A",s=parseFloat(((b=r.purchase)==null?void 0:b.qty)||((u=r.vendor_details)==null?void 0:u.qty)||0).toFixed(2),p=parseFloat(((F=r.purchase)==null?void 0:F.price_per_unit)||((L=r.vendor_details)==null?void 0:L.price_per_unit)||0).toFixed(2),l=parseFloat(((U=r.payment_master)==null?void 0:U.total_amount)||0).toFixed(2),o=parseFloat(((R=r.payment_master)==null?void 0:R.paid_amount)||0).toFixed(2),j=parseFloat(((W=r.payment_master)==null?void 0:W.balance_amount)||0).toFixed(2),P=[["Vendor:",m,"Material:",h],["Qty:",s,"Price/Unit:",`Rs ${p}`],["Total:",`Rs ${l}`,"Paid:",`Rs ${o}`],["Balance:",`Rs ${j}`,"",""]];n.autoTable({body:P,startY:44,theme:"grid",styles:{fontSize:11,cellPadding:4,lineColor:[200,200,200],lineWidth:.1},columnStyles:{0:{cellWidth:35,fontStyle:"bold",fillColor:[240,240,240]},1:{cellWidth:65},2:{cellWidth:35,fontStyle:"bold",fillColor:[240,240,240]},3:{cellWidth:65}}});const d=((z=r.payment_logs)==null?void 0:z.map((V,O)=>[O+1,V.paid_by||"-",V.payment_type||"-",`Rs ${Number(V.amount||0).toFixed(2)}`,new Date(V.payment_date).toLocaleDateString("en-GB"),V.description||"-"]))||[];n.autoTable({head:[["No.","Paid By","Type","Amount","Date","Description"]],body:d,startY:n.lastAutoTable.finalY+8,theme:"grid",headStyles:{fillColor:[52,152,219],textColor:255,fontSize:11,fontStyle:"bold",halign:"center"},bodyStyles:{fontSize:10},styles:{lineColor:[200,200,200],lineWidth:.1},columnStyles:{0:{cellWidth:15,halign:"center"},1:{cellWidth:45},2:{cellWidth:30,halign:"center"},3:{cellWidth:35,halign:"right"},4:{cellWidth:30,halign:"center"},5:{cellWidth:85}},alternateRowStyles:{fillColor:[245,245,245]}});const f=`Vendor_Payment_${m.replace(/[^a-zA-Z0-9]/g,"_")}.pdf`;n.save(f)},Tt=r=>{const n=[],a=parseFloat(r.vendor_details.qty||0),m=parseFloat(r.vendor_details.price_per_unit||0);n.push(["Vendor Payment Report"],[],[`Project: ${r.vendor_details.project.project_name}`],[`Generated: ${new Date().toLocaleString()}`],[]),n.push([`Vendor: ${r.vendor_details.vendor_name}`,`Material: ${r.vendor_details.material_name}`,`Qty: ${a.toFixed(2)}`,`Price/Unit: ₹${m.toFixed(2)}`,`Total: ₹${r.payment_master.total_amount}`,`Paid: ₹${r.payment_master.paid_amount}`,`Balance: ₹${r.payment_master.balance_amount}`]),n.push([],["No.","Paid By","Type","Amount","Date","Description"]),r.payment_logs.forEach((p,l)=>{n.push([l+1,p.paid_by,p.payment_type,Number(p.amount).toFixed(2),new Date(p.payment_date).toLocaleDateString("en-GB"),p.description||"-"])});const h=q.aoa_to_sheet(n);h["!cols"]=[{wch:8},{wch:20},{wch:15},{wch:15},{wch:15},{wch:40}];const s=q.book_new();q.book_append_sheet(s,h,"Vendor Logs"),ye(s,`Vendor_Payment_${r.vendor_details.vendor_name.replace(/\s+/g,"_")}.xlsx`)},sa=()=>{const[r,n]=y.useState(""),[a,m]=y.useState(""),[h,s]=y.useState([]),[p,l]=y.useState([]),[o,j]=y.useState(!1),[P,d]=y.useState([]),[f,c]=y.useState(!1),g=y.useRef(null),w=y.useRef(null),[C,b]=y.useState(!1),[u,F]=y.useState(!1),[L,U]=y.useState(!1),[R,W]=y.useState(!1),[z,V]=y.useState(null),[O,je]=y.useState(null),[Ue,fe]=y.useState(!1),[oe,_e]=y.useState(!1),[At,ge]=y.useState(null),[A,ce]=y.useState({vendor_id:"",material_name:"",about:"",qty:"",price:"",total:0,date:"",project_id:"",payment_id:null}),[Re,X]=y.useState(""),[x,ee]=y.useState({purches_vendor_id:"",paid_by:"Admin",payment_type:"Cash",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null,bank_name:"",acc_number:"",ifsc:"",transaction_id:""}),[Ve,B]=y.useState(""),[Ge,be]=y.useState(!1),{showToast:Z}=st(),He=async()=>{try{const t=await te("/api/getPurchesVendor");l(t||[])}catch{Z("danger","Failed to load vendors")}},de=async()=>{if(r){j(!0);try{const t=await te(`/api/getPurchesVedorPayment?project_id=${r}`);t&&t.success&&Array.isArray(t.data)?s(t.data):s([])}catch{Z("danger","Failed to load payments"),s([])}finally{j(!1)}}},Oe=async t=>{fe(!0);try{const i=await te(`/api/getVendorPaymentDetails/${t}`);je(i)}catch{Z("danger","Failed to load payment logs"),je(null)}finally{fe(!1)}},Ze=async t=>{var M,G,H,Q,Y,J,K,we,Ce,Se;if(B(""),!x.paid_by.trim())return B("Paid by is required");if(!x.payment_type.trim())return B("Payment type is required");if(!x.amount||x.amount<=0)return B("Amount must be > 0");if(!x.payment_date)return B("Payment date is required");if(Number(x.amount)>Number(z==null?void 0:z.balance_amount))return B(`Amount cannot be more than pending balance ₹${z==null?void 0:z.balance_amount}`);const i=["imps","neft","rtgs"].includes(x.payment_type.toLowerCase()),$=x.payment_type.toLowerCase()==="upi";if(i){if(!((M=x.bank_name)!=null&&M.trim()))return B("Bank name is required");if(!((G=x.acc_number)!=null&&G.trim()))return B("Account number is required");if(!((H=x.ifsc)!=null&&H.trim()))return B("IFSC code is required");if(!((Q=x.transaction_id)!=null&&Q.trim()))return B("Transaction ID is required")}if($&&!((Y=x.transaction_id)!=null&&Y.trim()))return B("UPI Transaction ID is required");if(t==="upload"&&!x.payment_file)return B("Payment : Photo/file is required");if(t==="remark"&&!((J=x.remark)!=null&&J.trim()))return B("Payment : Remark is required");const _=new FormData;_.append("purches_vendor_id",x.purches_vendor_id),_.append("paid_by",x.paid_by),_.append("payment_type",x.payment_type),_.append("amount",parseFloat(x.amount)),_.append("payment_date",x.payment_date),(K=x.description)!=null&&K.trim()&&_.append("description",x.description),(we=x.remark)!=null&&we.trim()&&_.append("remark",x.remark),x.payment_file&&_.append("payment_file",x.payment_file),_.append("bank_name",x.bank_name||""),_.append("acc_number",x.acc_number||""),_.append("ifsc",x.ifsc||""),_.append("transaction_id",x.transaction_id||""),be(!0);try{const me=await ot("/api/addVendorPayment",_);Z("success",me.message||"Payment added successfully!"),b(!1),at(),de()}catch(me){const it=((Se=(Ce=me.response)==null?void 0:Ce.data)==null?void 0:Se.message)||"Payment failed";B(it)}finally{be(!1)}},Fe=y.useCallback(async t=>{if(!t.trim()){d([]),c(!1);return}try{const i=await te(`/api/projects?searchQuery=${t}`);d(i||[]),i&&i.length>0?c(!0):c(!1)}catch{d([]),c(!1)}},[]);y.useEffect(()=>{const t=setTimeout(()=>{a.length>2?Fe(a):(d([]),c(!1))},300);return()=>clearTimeout(t)},[a,Fe]),y.useEffect(()=>{const t=i=>{g.current&&!g.current.contains(i.target)&&c(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),y.useEffect(()=>{r?de():s([])},[r]);const ve=t=>{m(t.project_name),n(t.id),d([]),c(!1),w.current&&w.current.blur()},Qe=t=>{const i=t.target.value;m(i),r&&i!==a&&n(""),P.length>0&&i.length>2&&c(!0)},Ye=()=>{P.length>0&&a.length>2&&c(!0)},Pe=()=>{_e(!1),ge(null),ce({vendor_id:"",material_name:"",about:"",qty:"",price:"",total:0,date:new Date().toISOString().split("T")[0],project_id:r,payment_id:null}),X(""),F(!0)},Je=t=>{_e(!0),ge(t.id);const i=t.purchase||{};ce({vendor_id:i.vendor_id||"",material_name:i.material_name||"",about:i.about||"",qty:parseFloat(i.qty)||"",price:parseFloat(i.price_per_unit)||"",total:parseFloat(i.total)||0,date:i.date||new Date().toISOString().split("T")[0],project_id:r,payment_id:t.id}),X(""),F(!0)},Ke=t=>{const{name:i,value:$}=t.target;ce(_=>{const M={..._,[i]:$};if(i==="qty"||i==="price"){const G=i==="qty"?parseFloat($)||0:parseFloat(_.qty)||0,H=i==="price"?parseFloat($)||0:parseFloat(_.price)||0;M.total=(G*H).toFixed(2)}return M})},Xe=()=>A.vendor_id?A.material_name.trim()?!A.qty||A.qty<=0?"Qty must be > 0":!A.price||A.price<=0?"Price must be > 0":A.date?"":"Date is required":"Material name is required":"Vendor is required",et=async()=>{var $,_;const t=Xe();if(t)return X(t);const i={project_id:parseInt(r),vendor_id:parseInt(A.vendor_id),material_name:A.material_name,about:A.about||null,price_per_unit:parseFloat(A.price),qty:parseFloat(A.qty),total:parseFloat(A.total),date:A.date};try{oe?await ct("/api/updatePurchesVendorPayment",{...i,payment_id:A.payment_id}):await dt("/api/purchesVendor",i),Z("success",oe?"Updated successfully!":"Added successfully!"),F(!1),de()}catch(M){X(((_=($=M.response)==null?void 0:$.data)==null?void 0:_.message)||"Operation failed")}},tt=t=>{V(t),ee({purches_vendor_id:t.purches_vendor_id,paid_by:"",payment_type:"",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null,bank_name:"",acc_number:"",ifsc:"",transaction_id:""}),B(""),b(!0)},at=()=>{ee({purches_vendor_id:"",paid_by:"Admin",payment_type:"Cash",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null,bank_name:"",acc_number:"",ifsc:"",transaction_id:""})},rt=t=>{const{name:i,value:$,files:_}=t.target;i==="payment_file"&&_&&_[0]?ee(M=>({...M,payment_file:_[0]})):ee(M=>({...M,[i]:$}))},nt=async t=>{U(!0),await Oe(t)};return y.useEffect(()=>{He()},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Me,{className:"mb-4",children:[e.jsxs($e,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Purchase Vendor Payments"}),e.jsxs("div",{children:[r&&h.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(T,{size:"sm",color:"light",className:"me-2",onClick:()=>wt(h,a),children:[e.jsx(E,{icon:Le})," PDF"]}),e.jsxs(T,{size:"sm",color:"light",className:"me-2",onClick:()=>Ct(h,a),children:[e.jsx(E,{icon:We})," Excel"]})]}),h.some(t=>{var i;return((i=t.logs)==null?void 0:i.length)>0})&&e.jsxs(e.Fragment,{children:[e.jsx(T,{size:"sm",color:"light",className:"me-2",onClick:()=>St(h,a),children:"All Logs PDF"}),e.jsx(T,{size:"sm",color:"light",onClick:()=>Nt(h,a),children:"All Logs Excel"})]})]})]}),e.jsxs(qe,{children:[e.jsx(I,{className:"mb-4",children:e.jsx(v,{md:12,children:e.jsxs("div",{className:"position-relative",ref:g,children:[e.jsxs(jt,{children:[e.jsx(D,{ref:w,type:"text",placeholder:"Search and select project...",value:a,onChange:Qe,onFocus:Ye,autoComplete:"off"}),r?e.jsx(T,{color:"danger",variant:"outline",onClick:()=>{m(""),n(""),s([])},children:e.jsx(E,{icon:_t})}):e.jsx(T,{color:"primary",variant:"outline",onClick:()=>W(!0),children:e.jsx(E,{icon:ft})})]}),f&&P.length>0&&e.jsx("div",{className:"border bg-white shadow-sm rounded",style:{position:"absolute",top:"100%",left:0,right:0,maxHeight:"200px",overflowY:"auto",zIndex:1e3,marginTop:"2px"},children:P.map(t=>e.jsx("div",{className:"px-3 py-2 hover-bg-light cursor-pointer",style:{cursor:"pointer"},onClick:()=>ve(t),onMouseEnter:i=>i.currentTarget.style.backgroundColor="#f0f0f0",onMouseLeave:i=>i.currentTarget.style.backgroundColor="white",children:t.project_name},t.id))}),r&&e.jsxs("small",{className:"text-success d-block mt-1",children:["Selected: ",e.jsx("strong",{children:a})]})]})})}),o?e.jsx("div",{className:"text-center py-4",children:e.jsx(pe,{})}):h.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(Ee,{striped:!0,hover:!0,children:[e.jsx(Ie,{color:"light",children:e.jsxs(le,{children:[e.jsx(N,{children:"Vendor Name"}),e.jsx(N,{children:"Material"}),e.jsx(N,{children:"Qty"}),e.jsx(N,{children:"Price/Unit"}),e.jsx(N,{children:"Total"}),e.jsx(N,{children:"Paid"}),e.jsx(N,{children:"Balance"}),e.jsx(N,{children:"Status"}),e.jsx(N,{children:"Created"}),e.jsx(N,{children:"Actions"})]})}),e.jsx(ze,{children:h.map(t=>{var G,H,Q,Y,J,K;const i=parseFloat(t.paid_amount)/parseFloat(t.amount)*100,$=i===0?"danger":i===100?"success":"warning",_=i===0?"Unpaid":i===100?"Paid":"Partial",M=parseFloat(t.balance_amount)>0;return e.jsxs(le,{children:[e.jsx(k,{children:((H=(G=t==null?void 0:t.purchase)==null?void 0:G.vendor)==null?void 0:H.name)||"-"}),e.jsx(k,{children:((Q=t==null?void 0:t.purchase)==null?void 0:Q.material_name)||"-"}),e.jsx(k,{children:parseFloat(((Y=t==null?void 0:t.purchase)==null?void 0:Y.qty)||0).toFixed(2)}),e.jsxs(k,{children:["₹",parseFloat(((J=t==null?void 0:t.purchase)==null?void 0:J.price_per_unit)||0).toFixed(2)]}),e.jsxs(k,{children:["₹",parseFloat(t.amount).toFixed(2)]}),e.jsxs(k,{children:["₹",parseFloat(t.paid_amount).toFixed(2)]}),e.jsxs(k,{children:["₹",parseFloat(t.balance_amount).toFixed(2)]}),e.jsx(k,{children:e.jsx(he,{color:$,children:_})}),e.jsx(k,{children:new Date(t.created_at).toLocaleDateString()}),e.jsxs(k,{children:[e.jsxs(T,{color:"info",size:"sm",className:"me-1",onClick:()=>nt(t.purches_vendor_id),disabled:!t.logs||t.logs.length===0,children:[e.jsx(E,{icon:bt})," Logs (",((K=t.logs)==null?void 0:K.length)||0,")"]}),e.jsxs(T,{color:"success",size:"sm",className:"me-1",onClick:()=>tt(t),disabled:!M,title:M?"Make Payment":"Fully Paid",children:[e.jsx(E,{icon:yt})," Pay"]}),e.jsx(T,{color:"warning",size:"sm",className:"me-1",onClick:()=>Je(t),children:e.jsx(E,{icon:gt})})]})]},t.id)})})]})}):r?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("h5",{className:"text-muted",children:"No payments yet"}),e.jsxs(T,{color:"primary",onClick:Pe,children:[e.jsx(E,{icon:De,className:"me-1"}),"Add First Material"]})]}):e.jsx("div",{className:"text-center py-5",children:e.jsx("h5",{className:"text-muted",children:"Select a project to view payments"})}),r&&!o&&e.jsx("div",{className:"mt-3",children:e.jsxs(T,{color:"success",onClick:Pe,children:[e.jsx(E,{icon:De,className:"me-1"}),"Add Material"]})})]})]}),e.jsx(Ft,{visible:C,onClose:()=>b(!1),payForm:x,payError:Ve,payLoading:Ge,onChange:rt,onSubmit:Ze,selectedVendorPayment:z}),e.jsx(vt,{visible:u,onClose:()=>F(!1),isEdit:oe,form:A,vendors:p,onChange:Ke,onSubmit:et,error:Re}),e.jsx(Pt,{visible:L,onClose:()=>U(!1),logsData:O,loading:Ue,onDownloadPDF:()=>kt(O),onDownloadExcel:()=>Tt(O)}),e.jsx(mt,{visible:R,onClose:()=>W(!1),onSelectProject:t=>{ve(t),W(!1)}})]})};export{sa as default};

import{d as Ee,u as De,b as Me,r as d,j as e,C as pe}from"./index-RpBzfmRP.js";import{a as y,b as c,c as A}from"./index.esm-DUetlGrP.js";import{a as he,b as Re}from"./api-CIBCEetx.js";import{C as H,a as X}from"./CCardBody-CXkOMOvY.js";import{C as We}from"./cil-mobile-BmZiFZXB.js";import{C as f}from"./CButton-L7dQWiht.js";import{C as Oe}from"./CCardHeader-eGsVFHQg.js";import{c as ze}from"./cil-arrow-left-D66Kb3Zq.js";import{C as Be}from"./CForm-HJD6m-Ck.js";import{C as x}from"./CFormLabel-CbpozHkd.js";import{C as u}from"./CFormInput-DA1SntO8.js";import{C as Ve}from"./CFormSelect-C4Gr2yJD.js";import{C}from"./CInputGroup-zC7AuBYL.js";import{C as z}from"./CInputGroupText-CmPlvCyb.js";import{C as xe}from"./DefaultLayout-8YNBKV_4.js";import{c as je}from"./cil-pencil-m516yCOw.js";import{c as fe}from"./cil-x-0440B5Ce.js";import{C as Le}from"./CFormTextarea-CN7028pX.js";import{c as $e}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-D2DOCb2Z.js";import"./RawMaterial-BtjEDAbB.js";const ht=()=>{var ae,ce,ie;const{id:S}=Ee(),T=De(),{showToast:F}=Me(),[_e,J]=d.useState(!0),[B,K]=d.useState(!1),[ye,ve]=d.useState(!1),[Ue,be]=d.useState([]),[Ce,Y]=d.useState([]),[N,Se]=d.useState(null),[i,V]=d.useState({tally_invoice_number:"",invoice_date:"",delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:0,sgstPercentage:0,cgstPercentage:0,igstPercentage:0,notes:"",status:"draft",terms_conditions:"",payment_terms:""}),[v,E]=d.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}]),[w,G]=d.useState([]),[Te,L]=d.useState(-1),[Z,ee]=d.useState(""),[$,te]=d.useState(""),[q,I]=d.useState([]),[Ne,U]=d.useState(-1),[se,ne]=d.useState(""),[Q,re]=d.useState("");d.useEffect(()=>{Pe(),ke()},[S]);const Pe=async()=>{var n,s;try{J(!0);const r=await he(`/api/proforma-invoices/${S}`);if(r&&r.success&&r.data){const t=r.data;Se(t);let o=[];t.details&&t.details.length>0?o=t.details.map(a=>{const m=parseFloat(a.qty)||0,qe=parseFloat(a.price)||0,Ie=parseFloat(a.total_price)||0;let R=0;a.gst_percent!==null&&a.gst_percent!==void 0&&(R=parseFloat(a.gst_percent),isNaN(R)&&(R=0));let W=0;a.cgst_amount!==null&&a.cgst_amount!==void 0&&(W=parseFloat(a.cgst_amount),isNaN(W)&&(W=0));let O=0;return a.sgst_amount!==null&&a.sgst_amount!==void 0&&(O=parseFloat(a.sgst_amount),isNaN(O)&&(O=0)),{id:a.id,work_type:a.work_type||"",uom:a.uom||"",qty:m,price:qe,total_price:Ie,gst_percent:R,cgst_amount:W,sgst_amount:O,remark:a.remark||""}}).sort((a,m)=>(a.id||0)-(m.id||0)):o=[{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:0,cgst_amount:0,sgst_amount:0,remark:""}];const j=o.reduce((a,m)=>a+m.qty*m.price,0),l=o.reduce((a,m)=>a+(m.cgst_amount||0),0),_=o.reduce((a,m)=>a+(m.sgst_amount||0),0),b=l+_,p=o.reduce((a,m)=>a+(m.total_price||0),0),g=parseFloat(t.gst_percentage)||0,h=parseFloat(t.sgst_percentage)||0,D=parseFloat(t.cgst_percentage)||0,M=parseFloat(t.igst_percentage)||0,le=p*(h/100),de=p*(D/100),me=p*(M/100),ue=le+de+me,ge=parseFloat(t.discount)||0,Ge=p+ue-ge;if(V({tally_invoice_number:t.tally_invoice_number||"",invoice_date:((n=t.invoice_date)==null?void 0:n.split("T")[0])||"",delivery_date:((s=t.delivery_date)==null?void 0:s.split("T")[0])||"",discount:ge,subtotal:j,taxableAmount:p,gstAmount:ue,sgstAmount:le,cgstAmount:de,igstAmount:me,finalAmount:Ge,gstPercentage:g,sgstPercentage:h,cgstPercentage:D,igstPercentage:M,notes:t.notes||"",status:t.status||"draft",terms_conditions:t.terms_conditions||"",payment_terms:t.payment_terms||""}),E(o),t.payment_terms){const a=t.payment_terms.split(`
`).filter(m=>m.trim()!=="");G(a.length>0?a:[])}else G([]);if(t.terms_conditions){const a=t.terms_conditions.split(`
`).filter(m=>m.trim()!=="");I(a.length>0?a:[])}else I([]);t.invoice_rules&&t.invoice_rules.length>0?Y(t.invoice_rules.map(a=>a.rules_id)):Y([])}else F("danger","Failed to load proforma invoice"),setTimeout(()=>T("/invoiceTable"),2e3)}catch(r){console.error("Error fetching proforma invoice:",r),F("danger","Failed to load proforma invoice"),setTimeout(()=>T("/invoiceTable"),2e3)}finally{J(!1)}},ke=async()=>{try{const n=await he("/api/rules");be(Array.isArray(n)?n:[])}catch(n){console.error("Error fetching rules:",n)}},P=n=>{const{name:s,value:r}=n.target;V(t=>{let o={...t,[s]:s==="discount"||s.endsWith("Percentage")?parseFloat(r)||0:r};if(s==="gstPercentage"){const l=(parseFloat(r)||0)/2;o={...o,sgstPercentage:l,cgstPercentage:l}}else if(s==="sgstPercentage"||s==="cgstPercentage"){const j=s==="sgstPercentage"?parseFloat(r)||0:t.sgstPercentage,l=s==="cgstPercentage"?parseFloat(r)||0:t.cgstPercentage;o={...o,gstPercentage:j+l}}if(s==="discount"||s.endsWith("Percentage")){const j=v.reduce((D,M)=>D+(M.total_price||0),0),l=j-o.discount,_=l*(o.sgstPercentage/100),b=l*(o.cgstPercentage/100),p=l*(o.igstPercentage/100),g=_+b+p,h=l+g;o={...o,subtotal:j,taxableAmount:l,gstAmount:g,sgstAmount:_,cgstAmount:b,igstAmount:p,finalAmount:h}}return o})},k=(n,s,r)=>{const t=[...v];s==="qty"||s==="price"?t[n][s]=r===""?0:parseFloat(r)||0:s==="gst_percent"?t[n].gst_percent=r===""||r===null||r===void 0?0:parseFloat(r)||0:t[n][s]=r;const o=t[n].qty||0,j=t[n].price||0,l=t[n].gst_percent??0,_=o*j,b=l/2,p=Math.round(_*(b/100)*100)/100,g=Math.round(_*(b/100)*100)/100;t[n].cgst_amount=p,t[n].sgst_amount=g,t[n].total_price=Math.round((_+p+g)*100)/100,E(t),oe(t)},Ae=()=>{E([...v,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:9,sgst_amount:9,remark:""}])},Fe=n=>{if(v.length===1)return;const s=[...v];s.splice(n,1),E(s),oe(s)},oe=n=>{V(s=>{const r=n.reduce((g,h)=>g+h.qty*h.price,0);n.reduce((g,h)=>g+(h.cgst_amount||0),0),n.reduce((g,h)=>g+(h.sgst_amount||0),0);const t=n.reduce((g,h)=>g+(h.total_price||0),0),o=Math.round(t*(s.sgstPercentage/100)*100)/100,j=Math.round(t*(s.cgstPercentage/100)*100)/100,l=Math.round(t*(s.igstPercentage/100)*100)/100,_=Math.round((o+j+l)*100)/100,b=Math.round((t+_)*100)/100,p=Math.round((b-(s.discount||0))*100)/100;return{...s,subtotal:Math.round(r*100)/100,taxableAmount:Math.round(t*100)/100,gstAmount:_,cgstAmount:j,sgstAmount:o,igstAmount:l,finalAmount:p}})},we=async n=>{if(n.preventDefault(),!n.currentTarget.checkValidity()){ve(!0);return}try{K(!0);const r={tally_invoice_number:i.tally_invoice_number||null,invoice_date:i.invoice_date,delivery_date:i.delivery_date||null,items:v.filter(o=>o.work_type&&o.qty>0).map(o=>({work_type:o.work_type,uom:o.uom,qty:o.qty,price:o.price,total_price:o.total_price,remark:o.remark||"",gst_percent:o.gst_percent,cgst_amount:o.cgst_amount,sgst_amount:o.sgst_amount})),discount:i.discount,gst_percentage:i.gstPercentage,cgst_percentage:i.cgstPercentage,sgst_percentage:i.sgstPercentage,igst_percentage:i.igstPercentage,rule_ids:Ce,notes:i.notes||null,status:i.status,terms_conditions:q.join(`
`)||null,payment_terms:w.join(`
`)||null},t=await Re(`/api/proforma-invoices/${S}`,r);t&&t.success?(F("success","Proforma invoice updated successfully"),setTimeout(()=>{T(`/proforma-invoice-details/${S}`)},1500)):F("danger",t.message||"Failed to update proforma invoice",8e3)}catch(r){console.error("Update error:",r);const t=r.message||"Failed to update proforma invoice";F("danger",t,8e3)}finally{K(!1)}};return _e?e.jsx(H,{children:e.jsxs(X,{className:"text-center py-5",children:[e.jsx(pe,{color:"primary"}),e.jsx("div",{className:"mt-3",children:"Loading proforma invoice..."})]})}):N?e.jsx(y,{children:e.jsx(c,{xs:12,children:e.jsxs(H,{className:"mb-4",children:[e.jsx(Oe,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("strong",{children:["Edit Proforma Invoice #",N.proforma_invoice_number]}),e.jsxs(f,{color:"secondary",size:"sm",onClick:()=>T(`/proforma-invoice-details/${S}`),children:[e.jsx(A,{icon:ze,className:"me-1"}),"Back to Details"]})]})}),e.jsxs(X,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(y,{children:[e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order #:"}),e.jsx("div",{children:e.jsx("strong",{children:(ae=N.work_order)==null?void 0:ae.invoice_number})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(ce=N.project)==null?void 0:ce.project_name})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(ie=N.customer)==null?void 0:ie.name})})]}),e.jsxs(c,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Payment Status:"}),e.jsx("div",{children:e.jsx("strong",{className:"text-capitalize",children:N.payment_status})})]})]})]}),e.jsxs(Be,{validated:ye,onSubmit:we,children:[e.jsxs(y,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Tally Invoice Number"}),e.jsx(u,{type:"text",name:"tally_invoice_number",value:i.tally_invoice_number,onChange:P,placeholder:"Optional"})]}),e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Invoice Date *"}),e.jsx(u,{type:"date",name:"invoice_date",value:i.invoice_date,onChange:P,required:!0})]}),e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Delivery Date"}),e.jsx(u,{type:"date",name:"delivery_date",value:i.delivery_date,onChange:P})]}),e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Status"}),e.jsxs(Ve,{name:"status",value:i.status,onChange:P,children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"sent",children:"Sent"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),v.map((n,s)=>e.jsxs("div",{className:"border rounded p-3 mb-3 bg-light",children:[e.jsxs(y,{className:"g-3 mb-2 align-items-end",children:[e.jsx(c,{md:3,children:e.jsx(u,{label:"Work Type *",placeholder:"Work Type",value:n.work_type,onChange:r=>k(s,"work_type",r.target.value),required:!0})}),e.jsx(c,{md:2,children:e.jsx(u,{label:"UOM",placeholder:"Unit",value:n.uom,onChange:r=>k(s,"uom",r.target.value)})}),e.jsx(c,{md:2,children:e.jsx(u,{label:"Qty *",type:"number",placeholder:"Qty",step:"0.01",min:"0",value:n.qty,onChange:r=>k(s,"qty",r.target.value),required:!0})}),e.jsxs(c,{md:2,children:[e.jsx(x,{children:"Rate *"}),e.jsxs(C,{children:[e.jsx(z,{children:"₹"}),e.jsx(u,{type:"number",step:"0.01",min:"0",value:n.price,onChange:r=>k(s,"price",r.target.value),required:!0})]})]}),e.jsxs(c,{md:2,children:[e.jsx(x,{children:"Base Amount"}),e.jsxs("div",{className:"fw-medium",children:["₹",(n.qty*n.price).toFixed(2)]})]}),e.jsx(c,{md:1,className:"d-flex align-items-end",children:e.jsx(f,{color:"danger",size:"sm",onClick:()=>Fe(s),disabled:v.length===1,children:"×"})})]}),e.jsxs(y,{className:"g-3 align-items-end",children:[e.jsx(c,{md:2,children:e.jsx(u,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:n.gst_percent,onChange:r=>k(s,"gst_percent",r.target.value)})}),e.jsxs(c,{md:2,children:[e.jsx(x,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",n.cgst_amount.toFixed(2)]})]}),e.jsxs(c,{md:2,children:[e.jsx(x,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",n.sgst_amount.toFixed(2)]})]}),e.jsxs(c,{md:2,children:[e.jsx(x,{className:"text-primary",children:"Total (with GST)"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",n.total_price.toFixed(2)]})]}),e.jsx(c,{md:4,children:e.jsx(u,{label:"Remark",placeholder:"Remark",value:n.remark,onChange:r=>k(s,"remark",r.target.value)})})]})]},s)),e.jsx(f,{color:"warning",variant:"outline",className:"mb-4",onClick:Ae,children:"+ Add Work"}),e.jsxs(y,{className:"mb-3",children:[e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Total Amount before GST"}),e.jsxs(C,{children:[e.jsx(z,{children:"₹"}),e.jsx(u,{type:"number",value:i.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Discount"}),e.jsxs(C,{children:[e.jsx(z,{children:"₹"}),e.jsx(u,{type:"number",name:"discount",value:i.discount,onChange:P,min:"0",step:"0.01"})]})]}),e.jsxs(c,{md:3,children:[e.jsx(x,{children:"Total Amount after GST"}),e.jsxs(C,{children:[e.jsx(z,{children:"₹"}),e.jsx(u,{type:"number",value:i.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:w.map((n,s)=>Te===s?e.jsxs(C,{style:{width:"auto"},children:[e.jsx(u,{value:Z,onChange:r=>ee(r.target.value)}),e.jsx(f,{color:"success",onClick:()=>{const r=[...w];r[s]=Z.trim(),G(r),L(-1)},children:"Save"}),e.jsx(f,{color:"secondary",onClick:()=>L(-1),children:"Cancel"})]},s):e.jsxs(xe,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:je,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{L(s),ee(n)}}),e.jsx(A,{icon:fe,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{G(w.filter((r,t)=>t!==s))}})]},s))}),e.jsx(y,{className:"mb-3",children:e.jsx(c,{md:6,children:e.jsxs(C,{children:[e.jsx(u,{placeholder:"Add new payment term...",value:$,onChange:n=>te(n.target.value)}),e.jsx(f,{color:"primary",onClick:()=>{$.trim()&&(G([...w,$.trim()]),te(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:q.map((n,s)=>Ne===s?e.jsxs(C,{style:{width:"auto"},children:[e.jsx(u,{value:se,onChange:r=>ne(r.target.value)}),e.jsx(f,{color:"success",onClick:()=>{const r=[...q];r[s]=se.trim(),I(r),U(-1)},children:"Save"}),e.jsx(f,{color:"secondary",onClick:()=>U(-1),children:"Cancel"})]},s):e.jsxs(xe,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(A,{icon:je,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{U(s),ne(n)}}),e.jsx(A,{icon:fe,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{I(q.filter((r,t)=>t!==s))}})]},s))}),e.jsx(y,{className:"mb-3",children:e.jsx(c,{md:6,children:e.jsxs(C,{children:[e.jsx(u,{placeholder:"Add new condition...",value:Q,onChange:n=>re(n.target.value)}),e.jsx(f,{color:"primary",onClick:()=>{Q.trim()&&(I([...q,Q.trim()]),re(""))},children:"Add"})]})})}),e.jsx(y,{className:"mb-3",children:e.jsxs(c,{md:12,children:[e.jsx(x,{children:"Additional Notes"}),e.jsx(Le,{name:"notes",value:i.notes,onChange:P,rows:3,placeholder:"Enter any additional notes..."})]})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(f,{color:"primary",type:"submit",disabled:B,children:[B?e.jsx(pe,{size:"sm"}):e.jsx(A,{icon:$e,className:"me-1"}),"Update Proforma Invoice"]}),e.jsx(f,{color:"secondary",onClick:()=>T(`/proforma-invoice-details/${S}`),disabled:B,children:"Cancel"})]})]})]})]})})}):e.jsx(H,{children:e.jsx(X,{children:e.jsxs(We,{color:"danger",children:[e.jsx("h5",{children:"Proforma Invoice Not Found"}),e.jsx("p",{children:"The requested proforma invoice could not be found."}),e.jsx(f,{color:"primary",onClick:()=>T("/invoiceTable"),children:"Back to Orders"})]})})})};export{ht as default};

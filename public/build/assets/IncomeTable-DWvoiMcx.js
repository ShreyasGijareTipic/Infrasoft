import{u as je,r as l,j as e,C as L}from"./index-DaQ8IcWH.js";import{a as ae,b as ye}from"./api-CIBCEetx.js";import{c as U,a as C,b as f}from"./index.esm-W-SaLQ2H.js";import{g as S}from"./Feilds-BHjWXeSc.js";import{E as be}from"./jspdf.es.min-F4ATsd5K.js";import"./jspdf.plugin.autotable-BzXBgMAn.js";import{utils as D,writeFile as _e}from"./xlsx-B6sNpj_1.js";import{C as fe,a as Fe}from"./CCardBody-BgdPVtOX.js";import{C as ve}from"./CCardHeader-BnYSwQm7.js";import{C as N}from"./CButton-RPa9QO-M.js";import{c as ne}from"./cil-cloud-download-CPU_poQw.js";import{c as Ae}from"./cil-search-CDkY_4k-.js";import{C as Ce}from"./CFormSelect-fqNFrf6e.js";import{a as Se,b as Ne,c as Pe,d as Te,e as De}from"./DefaultLayout-CNbVm5ae.js";import{C as Ie}from"./CForm-BkonVZOq.js";import{C as I}from"./CFormLabel-B6T8hfcB.js";import{C as R}from"./CFormInput-CplwN3WM.js";import"./typeof-QjJsDpFa.js";import"./jspdf.es.min-io4gt093.js";import"./CFormControlWrapper-CkuovpMX.js";import"./RawMaterial-BtjEDAbB.js";import"./cil-mobile-kffaxYCk.js";const n=m=>new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(m),b=m=>m?new Date(m).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}):"N/A",tt=()=>{je();const[m,w]=l.useState([]),[P,H]=l.useState(!1),[k,V]=l.useState(1),[Y,q]=l.useState(!0),[x,J]=l.useState({total_amount:0,pending_amount:0}),[F,re]=l.useState(""),[oe,K]=l.useState([]),[le,E]=l.useState(!1),[j,Re]=l.useState(null),[Q,ie]=l.useState(""),[X,Z]=l.useState(!1),[ee,W]=l.useState(""),T=l.useRef(),ce=10,te=l.useCallback(async()=>{try{const t=await ae("/api/projects");K(t||[])}catch(t){console.error("Error fetching projects:",t),K([])}},[]),v=l.useCallback(async(t=1,o=!1)=>{var i,y,h;H(!0);try{let r=`/api/income?per_page=${ce}&page=${t}`;F&&(r+=`&project_id=${F}`);const c=await ae(r),p=((i=c.incomes)==null?void 0:i.data)||[];w(_=>o?p:[..._,...p]),q((((y=c.incomes)==null?void 0:y.current_page)||1)<(((h=c.incomes)==null?void 0:h.last_page)||1)),J(c.summary||{total_amount:0,pending_amount:0})}catch(r){console.error("Error fetching incomes:",r),w(c=>o?[]:c),J({total_amount:0,pending_amount:0}),q(!1)}finally{H(!1)}},[F]);l.useEffect(()=>{te(),v(1,!0)},[te,F]);const de=l.useCallback(t=>{P||!Y||(T.current&&T.current.disconnect(),T.current=new IntersectionObserver(o=>{o[0].isIntersecting&&V(i=>i+1)}),t&&T.current.observe(t))},[P,Y]);l.useEffect(()=>{k>1&&v(k)},[k,v]);const me=t=>{re(t.target.value),V(1),w([])},se=async t=>{if(t.preventDefault(),!j)return;const o=parseFloat(Q)||0,i=parseFloat(j.pending_amount);if(o>i){W(`Amount to be paid cannot exceed pending amount of Rs ${n(i)}`);return}const y=parseFloat(j.received_amount)+o,h=i-o;Z(!0);try{(await ye(`/api/income/${j.id}`,{received_amount:y.toFixed(2),pending_amount:h.toFixed(2)})).message?(E(!1),v(1,!0)):W("Error updating payment")}catch(r){console.error("Error updating payment:",r),W("Error updating payment")}finally{Z(!1)}},he=()=>{const t=new be("landscape","pt","a4"),o=t.internal.pageSize.getWidth(),i=new Date().toLocaleDateString("en-GB");t.setFontSize(18),t.setFont("helvetica","bold"),t.text("INCOME REPORT",o/2,40,{align:"center"}),t.setFontSize(10),t.setFont("helvetica","normal"),t.text(`Generated on: ${i}`,o/2,60,{align:"center"}),t.text("(Based on Payment Date)",o/2,75,{align:"center"}),t.setFillColor(0,109,118),t.rect(40,90,o-80,30,"F"),t.setTextColor(255,255,255),t.setFontSize(11),t.setFont("helvetica","bold");const y=parseFloat(x.total_amount)*(S/(100+S)),h=parseFloat(x.total_amount)-y;t.text(`Grand Total: Amount: Rs ${n(h)} | GST: Rs ${n(y)} | Total With GST: Rs ${n(parseFloat(x.total_amount))} | Pending: Rs ${n(parseFloat(x.pending_amount))}`,o/2,108,{align:"center"});let r=140;const c=m.reduce((p,_)=>{const u=_.project_name||"N/A";return p[u]||(p[u]=[]),p[u].push(_),p},{});Object.keys(c).forEach((p,_)=>{const u=c[p];r>500&&(t.addPage(),r=40),t.setFillColor(0,172,153),t.rect(40,r,o-80,25,"F"),t.setTextColor(255,255,255),t.setFontSize(12),t.setFont("helvetica","bold"),t.text(`Project: ${p}`,50,r+17),r+=35;const A=u.map((a,d)=>{const M=a.payment_date||a.invoice_date;return[d+1,b(a.po_date),a.po_no,a.invoice_no,b(a.invoice_date),b(M),n(parseFloat(a.basic_amount)),n(parseFloat(a.gst_amount)),n(parseFloat(a.billing_amount)),n(parseFloat(a.received_amount)),n(parseFloat(a.pending_amount)),a.received_by||"-",a.payment_type.toUpperCase(),a.remark||"-",a.receivers_bank||"-"]}),z=u.reduce((a,d)=>a+parseFloat(d.billing_amount),0),B=u.reduce((a,d)=>a+parseFloat(d.received_amount),0),G=u.reduce((a,d)=>a+parseFloat(d.pending_amount),0),$=u.reduce((a,d)=>a+parseFloat(d.basic_amount),0),O=u.reduce((a,d)=>a+parseFloat(d.gst_amount),0);A.push([{content:"Total:",colSpan:6,styles:{fontStyle:"bold",halign:"right"}},n($),n(O),n(z),n(B),n(G),"","","",""]),t.autoTable({startY:r,head:[["Sr","PO Date","PO No","Invoice No","Invoice Date","Payment Date","Base Amount","GST Rs","Total","Received","Pending","Sent By","Payment Type","Txn ID","Bank"]],body:A,theme:"striped",headStyles:{fillColor:[210,224,170],textColor:"black",fontSize:7,fontStyle:"bold",halign:"center"},styles:{fontSize:6,cellPadding:2,halign:"right"},columnStyles:{0:{halign:"center",cellWidth:20},1:{cellWidth:50},2:{cellWidth:45},3:{cellWidth:50},4:{cellWidth:50},5:{cellWidth:50,halign:"center"},6:{cellWidth:55},7:{cellWidth:45},8:{cellWidth:55},9:{cellWidth:55},10:{cellWidth:55},11:{cellWidth:45},12:{cellWidth:45},13:{cellWidth:45},14:{cellWidth:50}},margin:{left:40,right:40},didDrawPage:a=>{t.setFontSize(8),t.setTextColor(128),t.text(`Page ${t.internal.getNumberOfPages()}`,o/2,t.internal.pageSize.getHeight()-20,{align:"center"})}}),r=t.lastAutoTable.finalY+20}),t.save(`Income_Report_${i.replace(/\//g,"-")}.pdf`)},ge=()=>{const t=D.book_new(),o=new Date().toLocaleDateString("en-GB"),i=m.reduce((h,r)=>{const c=r.project_name||"N/A";return h[c]||(h[c]=[]),h[c].push(r),h},{});Object.keys(i).forEach(h=>{const r=i[h],c=parseFloat(x.total_amount)*(S/(100+S)),p=parseFloat(x.total_amount)-c,_=[[{v:"INCOME REPORT",t:"s",s:{font:{bold:!0,sz:18,color:{rgb:"FFFFFF"}},alignment:{horizontal:"center"},fill:{fgColor:{rgb:"006D76"}}}}],[{v:`Generated on: ${o} (Based on Payment Date)`,t:"s",s:{font:{bold:!1,sz:10},alignment:{horizontal:"center"}}}],[{v:`Grand Total: Amount: Rs ${n(p)} | GST: Rs ${n(c)} | Total With GST: Rs ${n(parseFloat(x.total_amount))} | Pending: Rs ${n(parseFloat(x.pending_amount))}`,t:"s",s:{font:{bold:!0,sz:11,color:{rgb:"FFFFFF"}},alignment:{horizontal:"center",wrapText:!0},fill:{fgColor:{rgb:"00AC99"}}}}],[]],u=[["Sr","PO Date","PO No","Invoice No","Invoice Date","Payment Date","Base Amount","GST Rs","Total","Received","Pending","Sent By","Payment Type","Txn ID","Bank"]],A=r.map((s,g)=>{const xe=s.payment_date||s.invoice_date;return[g+1,b(s.po_date),s.po_no,s.invoice_no,b(s.invoice_date),b(xe),parseFloat(s.basic_amount),parseFloat(s.gst_amount),parseFloat(s.billing_amount),parseFloat(s.received_amount),parseFloat(s.pending_amount),s.received_by||"-",s.payment_type.toUpperCase(),s.remark||"-",s.receivers_bank||"-"]}),z=r.reduce((s,g)=>s+parseFloat(g.billing_amount),0),B=r.reduce((s,g)=>s+parseFloat(g.received_amount),0),G=r.reduce((s,g)=>s+parseFloat(g.pending_amount),0),$=r.reduce((s,g)=>s+parseFloat(g.basic_amount),0),O=r.reduce((s,g)=>s+parseFloat(g.gst_amount),0);A.push(["","","","","","TOTAL:",$,O,z,B,G,"","","",""]);const a=[..._,...u,...A],d=D.aoa_to_sheet(a);d["!merges"]=[{s:{r:0,c:0},e:{r:0,c:14}},{s:{r:1,c:0},e:{r:1,c:14}},{s:{r:2,c:0},e:{r:2,c:14}}];const M={font:{bold:!0,sz:10},fill:{fgColor:{rgb:"D2E0AA"}},alignment:{horizontal:"center"},border:{top:{style:"thin",color:{rgb:"006D76"}},bottom:{style:"thin",color:{rgb:"006D76"}},left:{style:"thin",color:{rgb:"006D76"}},right:{style:"thin",color:{rgb:"006D76"}}}},pe=_.length;for(let s=0;s<15;s++){const g=D.encode_cell({r:pe,c:s});d[g]&&(d[g].s=M)}const ue=h.substring(0,31);D.book_append_sheet(t,d,ue)});const y=o.replace(/\//g,"-");_e(t,`Income_Report_${y}.xlsx`)};return e.jsxs("div",{className:"container-fluid py-4",children:[e.jsxs(fe,{children:[e.jsxs(ve,{className:"bg-success text-white d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Income Details"}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(N,{color:"light",size:"sm",onClick:he,disabled:m.length===0,children:[e.jsx(U,{icon:ne,className:"me-1"}),"PDF"]}),e.jsxs(N,{color:"light",size:"sm",onClick:ge,disabled:m.length===0,children:[e.jsx(U,{icon:ne,className:"me-1"}),"Excel"]}),e.jsxs(N,{color:"light",size:"sm",onClick:()=>v(1,!0),children:[e.jsx(U,{icon:Ae,className:"me-1"}),"Refresh"]})]})]}),e.jsxs(Fe,{children:[e.jsx(C,{className:"mb-3",children:e.jsx(f,{md:4,children:e.jsxs(Ce,{value:F,onChange:me,children:[e.jsx("option",{value:"",children:"All Projects"}),oe.map(t=>e.jsx("option",{value:t.id,children:t.project_name},t.id))]})})}),e.jsx(C,{className:"mb-3",children:e.jsx(f,{md:12,children:e.jsx("div",{className:"alert alert-info mb-0",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("strong",{children:"Total Amount With GST:"}),e.jsx("br",{}),"Rs ",n(parseFloat(x.total_amount))]}),e.jsx("div",{className:"col-md-4",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("strong",{children:"ðŸ“… Note:"})," Reports are based on Payment Date when available, otherwise Invoice Date is used."]})})]})})})}),P&&m.length===0?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(L,{}),e.jsx("div",{className:"mt-2",children:"Loading income records..."})]}):m.length>0?e.jsxs("div",{className:"table-responsive",children:[e.jsxs("table",{className:"table table-striped table-bordered",children:[e.jsx("thead",{className:"table-success",children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"right"},children:"ID"}),e.jsx("th",{style:{textAlign:"right"},children:"Project Name"}),e.jsx("th",{style:{textAlign:"right"},children:"PO No"}),e.jsx("th",{style:{textAlign:"right"},children:"PO Date"}),e.jsx("th",{style:{textAlign:"right"},children:"Invoice No"}),e.jsx("th",{style:{textAlign:"right"},children:"Invoice Date"}),e.jsx("th",{style:{textAlign:"right"},children:"Payment Date"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount Before GST"}),e.jsxs("th",{style:{textAlign:"right"},children:["GST ",S,"%"]}),e.jsx("th",{style:{textAlign:"right"},children:"Amount With GST"}),e.jsx("th",{style:{textAlign:"right"},children:"Received Amount"}),e.jsx("th",{style:{textAlign:"right"},children:"Sent By"}),e.jsx("th",{style:{textAlign:"right"},children:"Payment Type"}),e.jsx("th",{style:{textAlign:"right"},children:"Transaction ID"}),e.jsx("th",{style:{textAlign:"right"},children:"Received Bank"})]})}),e.jsx("tbody",{children:m.map((t,o)=>{const i=t.payment_date||t.invoice_date;return e.jsxs("tr",{ref:o===m.length-1?de:null,children:[e.jsx("td",{style:{textAlign:"right"},children:t.id}),e.jsx("td",{style:{textAlign:"right"},children:t.project_name||"N/A"}),e.jsx("td",{style:{textAlign:"right"},children:t.po_no}),e.jsx("td",{style:{textAlign:"right"},children:b(t.po_date)}),e.jsx("td",{style:{textAlign:"right"},children:t.invoice_no}),e.jsx("td",{style:{textAlign:"right"},children:b(t.invoice_date)}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx("span",{className:t.payment_date?"badge bg-success":"text-muted",children:b(i)})}),e.jsx("td",{style:{textAlign:"right"},children:n(parseFloat(t.basic_amount))}),e.jsx("td",{style:{textAlign:"right"},children:n(parseFloat(t.gst_amount))}),e.jsx("td",{style:{textAlign:"right"},children:n(parseFloat(t.billing_amount))}),e.jsx("td",{style:{textAlign:"right"},children:n(parseFloat(t.received_amount))}),e.jsx("td",{style:{textAlign:"right"},children:t.received_by}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx("span",{className:"badge bg-primary",children:t.payment_type.toUpperCase()})}),e.jsx("td",{style:{textAlign:"right"},children:t.remark||"N/A"}),e.jsx("td",{style:{textAlign:"right"},children:t.receivers_bank})]},t.id)})})]}),P&&m.length>0&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(L,{}),e.jsx("div",{className:"mt-2",children:"Loading more records..."})]})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("div",{className:"text-muted",children:"No income records found"})})]})]}),j&&e.jsxs(Se,{visible:le,onClose:()=>E(!1),children:[e.jsx(Ne,{children:e.jsxs(Pe,{children:["Update Payment for Invoice ",j.invoice_no]})}),e.jsx(Te,{children:e.jsxs(Ie,{onSubmit:se,children:[e.jsxs(C,{className:"mb-3",children:[e.jsxs(f,{md:6,children:[e.jsx(I,{htmlFor:"billing_amount",children:"Amount With GST Rs"}),e.jsx(R,{step:"0.01",value:n(parseFloat(j.billing_amount)),disabled:!0})]}),e.jsxs(f,{md:6,children:[e.jsx(I,{htmlFor:"received_amount",children:"Received Amount Rs"}),e.jsx(R,{step:"0.01",value:n(parseFloat(j.received_amount)),disabled:!0})]})]}),e.jsxs(C,{className:"mb-3",children:[e.jsxs(f,{md:6,children:[e.jsx(I,{htmlFor:"pending_amount",children:"Pending Amount Rs"}),e.jsx(R,{step:"0.01",value:n(parseFloat(j.pending_amount)),disabled:!0})]}),e.jsxs(f,{md:6,children:[e.jsx(I,{htmlFor:"amount_to_be_paid",children:"Amount To Be Paid Rs *"}),e.jsx(R,{type:"number",step:"0.01",value:Q,onChange:t=>ie(t.target.value),placeholder:"Enter amount to be paid",required:!0})]})]}),ee&&e.jsx(C,{children:e.jsx(f,{children:e.jsx("div",{className:"alert alert-danger",role:"alert",children:ee})})})]})}),e.jsxs(De,{children:[e.jsx(N,{color:"secondary",onClick:()=>E(!1),children:"Cancel"}),e.jsx(N,{color:"primary",onClick:se,disabled:X,children:X?e.jsxs(e.Fragment,{children:[e.jsx(L,{size:"sm",className:"me-2"}),"Updating..."]}):"Update Payment"})]})]})]})};export{tt as default};

import{r as m,u as je,b as ye,j as e}from"./index-DsLCqE06.js";import{a as Z,e as ge,d as Se}from"./api-CIBCEetx.js";import{utils as L,writeFile as fe}from"./xlsx-B6sNpj_1.js";import{E as ve}from"./jspdf.es.min-cKyHKAYl.js";import"./jspdf.plugin.autotable-B41L-UUw.js";import{a as Te,b as F,c as ee}from"./index.esm-BlJU5mne.js";import{C as te,a as ke}from"./CCardBody-DQWRa7c4.js";import{C as Ce}from"./CCardHeader-PfItfEOJ.js";import{C as j}from"./CButton-DirJQzUR.js";import{C as ae}from"./CFormInput-Db5B42Su.js";import{C as Re}from"./CFormSelect-84oUtJFR.js";import{C as be,a as _e,b as H,c as l,d as Fe,e as r,f as Ne}from"./CTable-BAKI_IEN.js";import{c as Pe}from"./cil-pencil-m516yCOw.js";import{c as we}from"./cil-trash-CBbKHhHb.js";import{a as De,b as Ee,c as Le,d as He,e as Me}from"./DefaultLayout-5pHqimqm.js";import"./typeof-QjJsDpFa.js";import"./jspdf.es.min-ButOjYP_.js";import"./CFormControlWrapper-D9cjubv0.js";import"./CFormLabel-CVJu7LBr.js";import"./RawMaterial-BtjEDAbB.js";import"./cil-mobile-CNtzZ120.js";function ot(){const[d,re]=m.useState([]),[h,M]=m.useState(""),[x,W]=m.useState(""),[oe,se]=m.useState(""),[N,v]=m.useState(!1),[ne,le]=m.useState([]),[u,I]=m.useState(""),[ie,g]=m.useState(!1),[A,$]=m.useState(null),ce=je(),{showToast:P}=ye(),de=async()=>{try{const t=await Z("/api/myProjects");le(t||[])}catch(t){console.error("Error fetching projects:",t)}},T=async(t={})=>{try{const a=ge();let p="/api/drilling";a===2&&(p="/api/getDataByUserId");const c=new URLSearchParams;t.start_date&&t.end_date&&(c.append("start_date",t.start_date),c.append("end_date",t.end_date)),t.project_name&&c.append("project_name",t.project_name),t.max_point&&c.append("max_point",t.max_point),[...c].length>0&&(p=`${p}?${c.toString()}`),v(!0);const w=(await Z(p)).data,k=[];w.forEach((i,C)=>{var O,z,G,U,Y,V,q,J,K,Q,X;const D=((O=i.work_point_detail)==null?void 0:O.length)||0,s=((z=i.survey_detail)==null?void 0:z.length)||0,R=((G=i.machine_reading)==null?void 0:G.length)||0,b=((U=i.compressor_rpm)==null?void 0:U.length)||0,B=Math.max(D,s,R,b,1);for(let y=0;y<B;y++){const S=((Y=i.work_point_detail)==null?void 0:Y[y])||{},f=((V=i.survey_detail)==null?void 0:V[y])||{},_=((q=i.machine_reading)==null?void 0:q[y])||{},E=((J=i.compressor_rpm)==null?void 0:J[y])||{};k.push({srNo:C+1,date:i.date,site:((K=i.project)==null?void 0:K.project_name)||"",operator:((Q=_.operator)==null?void 0:Q.name)||((X=i.operator)==null?void 0:X.name)||"",machineStart:_.machine_start||"",machineEnd:_.machine_end||"",machineHr:_.actual_machine_hr||"",compressorStart:E.comp_rpm_start||"",compressorEnd:E.comp_rpm_end||"",compressorHr:E.com_actul_hr||"",workType:S.work_type||"",workPoint:S.work_point||"",workRate:S.rate||"",workTotal:Number(S.total)||0,surveyType:f.survey_type||"",surveyPoint:f.survey_point||"",surveyRate:f.rate||"",surveyTotal:Number(f.total)||0,rowTotal:(Number(S.total)||0)+(Number(f.total)||0),isFirstRow:y===0,rowSpan:B,drillingRecordId:i.id})}}),re(k)}catch(a){console.error("Error fetching records:",a)}finally{v(!1)}},n=m.useMemo(()=>({workPoint:d.reduce((t,a)=>t+(parseFloat(a.workPoint)||0),0),workRate:d.reduce((t,a)=>t+(parseFloat(a.workRate)||0),0),workTotal:d.reduce((t,a)=>t+(Number(a.workTotal)||0),0),surveyPoint:d.reduce((t,a)=>t+(parseFloat(a.surveyPoint)||0),0),surveyRate:d.reduce((t,a)=>t+(parseFloat(a.surveyRate)||0),0),surveyTotal:d.reduce((t,a)=>t+(Number(a.surveyTotal)||0),0),grandTotal:d.reduce((t,a)=>t+(Number(a.rowTotal)||0),0)}),[d]),pe=()=>{const t=["Work Log Report"],a=[],p=[];(h||x||u)&&(p.push(["Applied Filters:"]),h&&x&&p.push(["Date Range:",`${new Date(h).toLocaleDateString()} to ${new Date(x).toLocaleDateString()}`]),u&&p.push(["Project:",u]),p.push(a));const c=["Sr.No.","Date","Site","Operator/Helper","Machine Start","Machine End","Machine Hr","Compressor rpm Start","Compressor rpm End","Compressor rpm Hr","Work Type","Point","Rate","Work Total","Survey Type","Survey Point","Survey Rate","Survey Total","Grand Total"],o=d.map(s=>[s.srNo,new Date(s.date).toLocaleDateString(),s.site,s.operator,s.machineStart,s.machineEnd,s.machineHr,s.compressorStart,s.compressorEnd,s.compressorHr,s.workType,s.workPoint,s.workRate,s.workTotal,s.surveyType,s.surveyPoint,s.surveyRate,s.surveyTotal,s.rowTotal]),w=["","","","","","","","","","","TOTAL",n.workPoint.toFixed(2),n.workRate.toFixed(2),n.workTotal.toFixed(2),"",n.surveyPoint.toFixed(2),n.surveyRate.toFixed(2),n.surveyTotal.toFixed(2),n.grandTotal.toFixed(2)],k=[t,a,...p,c,...o,a,w],i=L.aoa_to_sheet(k),C=L.book_new();L.book_append_sheet(C,i,"WorkLogReport"),i["!merges"]=[{s:{r:0,c:0},e:{r:0,c:18}}];const D=c.map((s,R)=>({wch:Math.max(s.length,...o.map(b=>b[R]?b[R].toString().length:0))+2}));i["!cols"]=D,fe(C,"WorkLogReport.xlsx")},me=()=>{const t=new ve("l","mm","a4");t.setFontSize(16),t.setFont(void 0,"bold"),t.text("Work Log Report",t.internal.pageSize.getWidth()/2,10,{align:"center"});let a=20;(h||x||u)&&(t.setFontSize(10),t.setFont(void 0,"normal"),t.text("Applied Filters:",14,a),a+=5,h&&x&&(t.text(`Date Range: ${new Date(h).toLocaleDateString()} to ${new Date(x).toLocaleDateString()}`,14,a),a+=5),u&&(t.text(`Project: ${u}`,14,a),a+=5),a+=3);const p=["Sr.No.","Date","Site","Operator","Machine Start","Machine End","Machine Hr","Comp Start","Comp End","Comp Hr","Work Type","Point","Rate","Work Total","Survey Type","Point","Rate","Survey Total","Grand Total"],c=d.map(o=>[o.srNo,new Date(o.date).toLocaleDateString(),o.site,o.operator,o.machineStart,o.machineEnd,o.machineHr,o.compressorStart,o.compressorEnd,o.compressorHr,o.workType,o.workPoint,o.workRate,o.workTotal,o.surveyType,o.surveyPoint,o.surveyRate,o.surveyTotal,o.rowTotal]);c.push(["","","","","","","","","","","TOTAL",n.workPoint.toFixed(2),n.workRate.toFixed(2),n.workTotal.toFixed(2),"",n.surveyPoint.toFixed(2),n.surveyRate.toFixed(2),n.surveyTotal.toFixed(2),n.grandTotal.toFixed(2)]),t.autoTable({head:[p],body:c,startY:a,theme:"grid",styles:{fontSize:7,cellPadding:2,overflow:"linebreak",halign:"center",valign:"middle"},headStyles:{fillColor:[41,128,185],textColor:255,fontSize:7,fontStyle:"bold"},footStyles:{fillColor:[220,220,220],textColor:0,fontStyle:"bold"},tableWidth:"auto",pageBreak:"auto",didParseCell:function(o){o.row.index===c.length-1&&(o.cell.styles.fontStyle="bold",o.cell.styles.fillColor=[240,240,240])}}),t.save("WorkLogReport.pdf")};m.useEffect(()=>{de(),T()},[]);const he=()=>{T({start_date:h||void 0,end_date:x||void 0,project_name:u||void 0,max_point:oe||void 0})},xe=t=>{$(t),g(!0)},ue=async()=>{if(A){v(!0);try{await Se(`/api/drilling/${A}`)?(P("success","Entry deleted successfully!"),T()):P("danger","Failed to delete entry")}catch(t){console.error(t),P("danger","Something went wrong while deleting.")}finally{v(!1),g(!1),$(null)}}};return e.jsxs("div",{children:[e.jsx(te,{className:"mb-4",children:e.jsxs(Ce,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2",children:[e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(j,{color:"success",className:"me-2",onClick:pe,children:"Download Excel"}),e.jsx(j,{color:"danger",className:"pe-3",onClick:me,children:"Download PDF"})]}),e.jsxs("h4",{className:"mb-0",children:["Total Amount : ",n.grandTotal.toFixed(2)]})]}),e.jsxs(Te,{className:"align-items-end d-flex flex-wrap gap-2",children:[e.jsx(F,{md:3,children:e.jsx(ae,{type:"date",label:"Start Date",value:h,onChange:t=>M(t.target.value)})}),e.jsx(F,{md:3,children:e.jsx(ae,{type:"date",label:"End Date",value:x,onChange:t=>W(t.target.value)})}),e.jsx(F,{md:3,children:e.jsxs(Re,{label:"Project Name",value:u,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"",children:"-- Select Project --"}),ne.map(t=>e.jsx("option",{value:t.project_name,children:t==null?void 0:t.project_name},t.id))]})}),e.jsxs(F,{md:3,children:[e.jsx(j,{color:"primary",onClick:he,children:"Apply"}),e.jsx(j,{color:"secondary",className:"ms-2",onClick:()=>{M(""),W(""),I(""),se(""),T()},children:"Reset"})]})]})]})}),d.length>0&&e.jsx(te,{className:"mt-4",children:e.jsx(ke,{className:"p-0",children:e.jsx("div",{className:"table-responsive",children:e.jsxs(be,{bordered:!0,hover:!0,children:[e.jsx(_e,{color:"dark",children:e.jsxs(H,{children:[e.jsx(l,{children:"Sr.No."}),e.jsx(l,{children:"Date"}),e.jsx(l,{children:"Site"}),e.jsx(l,{children:"Operator/Helper"}),e.jsx(l,{children:"Machine Start"}),e.jsx(l,{children:"Machine End"}),e.jsx(l,{children:"Machine Hr"}),e.jsx(l,{children:"Compressor rpm Start"}),e.jsx(l,{children:"Compressor rpm End"}),e.jsx(l,{children:"Compressor rpm Hr"}),e.jsx(l,{children:"Work Type"}),e.jsx(l,{children:"Point"}),e.jsx(l,{children:"Rate"}),e.jsx(l,{children:"Work Total"}),e.jsx(l,{children:"Survey Type"}),e.jsx(l,{children:"Survey Point"}),e.jsx(l,{children:"Survey Rate"}),e.jsx(l,{children:"Survey Total"}),e.jsx(l,{children:"Grand Total"}),e.jsx(l,{children:"Action"})]})}),e.jsx(Fe,{children:d.map((t,a)=>e.jsxs(H,{children:[t.isFirstRow&&e.jsxs(e.Fragment,{children:[e.jsx(r,{rowSpan:t.rowSpan,children:t.srNo}),e.jsx(r,{rowSpan:t.rowSpan,children:new Date(t.date).toLocaleDateString("en-GB")}),e.jsx(r,{rowSpan:t.rowSpan,children:t.site})]}),e.jsx(r,{children:t.operator}),e.jsx(r,{children:t.machineStart}),e.jsx(r,{children:t.machineEnd}),e.jsx(r,{children:t.machineHr}),e.jsx(r,{children:t.compressorStart}),e.jsx(r,{children:t.compressorEnd}),e.jsx(r,{children:t.compressorHr}),e.jsx(r,{children:t.workType}),e.jsx(r,{children:t.workPoint}),e.jsx(r,{children:t.workRate}),e.jsx(r,{className:"fw-bold text-primary",children:t.workTotal}),e.jsx(r,{children:t.surveyType}),e.jsx(r,{children:t.surveyPoint}),e.jsx(r,{children:t.surveyRate}),e.jsx(r,{className:"fw-bold text-primary",children:t.surveyTotal}),e.jsx(r,{className:"fw-bold text-success",children:t.rowTotal}),t.isFirstRow&&e.jsx(r,{rowSpan:t.rowSpan,className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[e.jsx(j,{color:"primary",onClick:()=>ce(`/updateDrillingForm/${t.drillingRecordId}`,{state:{drillingRecordId:t.drillingRecordId}}),children:e.jsx(ee,{icon:Pe})}),e.jsx(j,{color:"danger",onClick:()=>xe(t.drillingRecordId),children:e.jsx(ee,{icon:we})})]})})]},a))}),e.jsx(Ne,{children:e.jsxs(H,{style:{backgroundColor:"#f0f0f0",fontWeight:"bold"},children:[e.jsx(r,{colSpan:11,className:"text-end",children:"TOTAL"}),e.jsx(r,{className:"text-center",children:n.workPoint.toFixed(2)}),e.jsx(r,{className:"text-center",children:n.workRate.toFixed(2)}),e.jsx(r,{className:"text-center text-primary",children:n.workTotal.toFixed(2)}),e.jsx(r,{}),e.jsx(r,{className:"text-center",children:n.surveyPoint.toFixed(2)}),e.jsx(r,{className:"text-center",children:n.surveyRate.toFixed(2)}),e.jsx(r,{className:"text-center text-primary",children:n.surveyTotal.toFixed(2)}),e.jsx(r,{className:"text-center text-success",children:n.grandTotal.toFixed(2)}),e.jsx(r,{})]})})]})})})}),e.jsxs(De,{visible:ie,onClose:()=>g(!1),backdrop:"static",children:[e.jsx(Ee,{onClose:()=>g(!1),children:e.jsx(Le,{children:"Delete drilling record?"})}),e.jsxs(He,{children:["Do you really want to"," ",e.jsx("span",{className:"text-danger fw-bold",children:"Delete"})," this record?"]}),e.jsxs(Me,{children:[e.jsx(j,{color:"secondary",variant:"outline",onClick:()=>g(!1),disabled:N,children:"Close"}),e.jsx(j,{color:"danger",disabled:N,onClick:ue,children:N?"Deletingâ€¦":"Yes"})]})]})]})}export{ot as default};
